{% extends 'user/base.html' %}

{% block title %}Laporan APU PPT{% endblock %}

{% block extra_head %}
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Global styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Spinner utility */
        .spinner-border {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: middle;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        .d-none { display: none !important; }

        /* Section styling - compact */
        .section-group {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 0;
            margin-bottom: 1rem; /* Reduced margin */
            overflow: hidden;
        }

        .section-group .section-header {
            font-size: 1.15rem; /* Smaller header */
            font-weight: 700;
            color: #1f2937;
            background-color: #eef2f6;
            padding: 0.8rem 1.5rem; /* Reduced padding */
            margin: 0 -1px 0.8rem -1px; /* Reduced margin */
            border-bottom: 1px solid #e0e7eb;
            border-top-left-radius: 11px;
            border-top-right-radius: 11px;
        }

        .section-group .section-content {
            padding: 1.2rem; /* Reduced padding */
            padding-top: 0;
        }

        /* Form elements - compact */
        .form-label {
            font-size: 0.95rem; /* Smaller labels */
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.3rem; /* Reduced margin */
        }

        .form-input {
            font-size: 0.9rem; /* Smaller font */
            padding: 0.7rem 1rem; /* Reduced padding */
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px; /* Slightly rounder corners */
            color: #4b5563;
            transition: all 0.2s ease;
            min-height: 40px; /* Reduced minimum height */
            box-sizing: border-box;
        }

        /* Date inputs */
        input[type="date"].form-input {
            font-size: 0.9rem;
            padding: 0.7rem 1rem;
            min-height: 40px;
            appearance: none;
            background-color: white;
        }

        /* Select dropdowns */
        select.form-input {
            font-size: 0.9rem;
            padding: 0.7rem 1rem;
            min-height: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23374151' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            background-size: 14px 10px;
            padding-right: 2.2rem;
        }

        /* File input */
        .file-input-container {
            margin-top: 0.3rem;
        }
        
        .file-input-container input[type="file"] {
            font-size: 0.9rem;
            padding: 0.7rem 1rem;
        }

        /* Nested sections */
        .nested-section-group {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f9fafb;
        }

        /* Table styles for radio buttons - compact */
        .form-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0.8rem; /* Reduced margin */
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.9rem; /* Smaller font for table text */
        }
        .form-table th, .form-table td {
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            padding: 0.6rem; /* Reduced padding */
            text-align: center;
            vertical-align: middle;
        }
        .form-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
        }
        .form-table th:last-child,
        .form-table td:last-child {
            border-right: none;
        }
        .form-table tr:last-child td {
            border-bottom: none;
        }
        .form-table td:first-child {
            text-align: left;
            font-weight: 500;
            color: #374151;
        }
        .form-check-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .form-check-input {
            margin: 0;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 1.1rem; /* Slightly smaller radio buttons */
            height: 1.1rem; /* Slightly smaller radio buttons */
            border: 2px solid #9ca3af;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .form-check-input:checked {
            border-color: #4f46e5;
            background-color: #4f46e5;
        }
        .form-check-input:checked::before {
            content: '';
            display: block;
            width: 0.4rem; /* Smaller inner dot */
            height: 0.4rem; /* Smaller inner dot */
            background-color: #ffffff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .form-check-input:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .form-check-input:hover:not(:checked) {
            border-color: #6366f1;
        }

        /* Textarea styling - compact */
        textarea.form-input {
            min-height: 100px; /* Shorter textareas */
            resize: vertical;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-input {
                padding: 0.9rem;
                min-height: 45px;
            }
            
            .section-group .section-header {
                font-size: 1.15rem;
                padding: 0.9rem 1rem;
            }
            
            .nested-section-group {
                padding: 1rem;
            }
        }

        /* Styles for buttons - compact */
        .btn {
            font-size: 0.95rem;
            padding: 0.8rem 1.2rem; /* Reduced padding */
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        /* Adjust gap for grid layouts */
        .tw-gap-4 {
            gap: 0.75rem; /* Reduced gap */
        }
        .tw-gap-x-6 {
            column-gap: 1.5rem; /* Reduced column gap */
        }
        .tw-gap-y-2 {
            row-gap: 0.5rem; /* Reduced row gap */
        }

        /* Styles for the loading overlay (kept consistent) */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        #loadingOverlay .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.35em;
            color: #ffffff;
        }

        /* Styles for the message box backdrop */
        #messageBoxBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
        }

        /* Styles for the message box pop-up */
        #dynamicMessageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            max-width: 400px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        #dynamicMessageBox.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #dynamicMessageBox.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #dynamicMessageBox .icon-container {
            font-size: 3rem;
            line-height: 1;
            animation: fade-in-scale 0.5s ease-out forwards;
        }

        @keyframes fade-in-scale {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #dynamicMessageBox .ok-button {
            background-color: #4CAF50;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s ease;
        }

        #dynamicMessageBox .ok-button:hover {
            background-color: #45a049;
        }
    </style>
{% endblock %}

{% block content %}
<div class="tw-max-w-4xl tw-mx-auto tw-my-8 tw-p-6 tw-bg-white tw-rounded-2xl tw-shadow-2xl tw-space-y-4">
    <h2 class="tw-text-2xl tw-font-extrabold tw-text-gray-900 tw-text-center tw-border-b-4 tw-border-indigo-600 tw-pb-3 tw-mb-4">
        Laporan APU PPT (Anti Pencucian Uang dan Pencegahan Pendanaan Terorisme)
    </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="tw-p-3 tw-rounded-lg tw-text-sm tw-font-semibold tw-text-center {% if category == 'success' %}tw-bg-green-100 tw-text-green-800 tw-border tw-border-green-300{% else %}tw-bg-red-100 tw-text-red-800 tw-border tw-border-red-300{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('submit_laporan_apuppt') }}" enctype="multipart/form-data" id="apuPptReportForm" class="tw-space-y-4">
        
        <!-- Informasi Umum Laporan Section -->
        <div class="section-group">
            <h3 class="section-header">Informasi Umum Laporan</h3>
            <div class="section-content">
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-4 tw-gap-y-2">
                    <div class="tw-space-y-1">
                        <label for="tahun_laporan" class="form-label">Tahun Laporan <span class="tw-text-red-500">*</span></label>
                        <select class="form-input" id="tahun_laporan" name="tahun_laporan" required>
                            <option value="">-- Pilih Tahun --</option>
                            {% for year in range(2020, 2026) %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="nomor_surat" class="form-label">Nomor Surat <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="nomor_surat" name="nomor_surat" required>
                    </div>
                    
                    <div class="md:tw-col-span-2 tw-space-y-1">
                        <label for="tanggal_surat" class="form-label">Tanggal Surat <span class="tw-text-red-500">*</span></label>
                        <input type="date" class="form-input" id="tanggal_surat" name="tanggal_surat" required>
                    </div>
                    
                    <div class="md:tw-col-span-2 tw-space-y-1">
                        <label for="file" class="form-label">Dokumen Laporan Tahunan APU, PPT, dan PPSPM yang telah ditandatangani (PDF/DOC/DOCX) <span class="tw-text-red-500">*</span></label>
                        <div class="file-input-container">
                            <input type="file" class="tw-block tw-w-full tw-text-sm tw-text-gray-500 file:tw-mr-4 file:tw-py-2 file:tw-px-3 file:tw-rounded-lg file:tw-border-0 file:tw-text-base file:tw-font-semibold file:tw-bg-indigo-50 file:tw-text-indigo-700 hover:file:tw-bg-indigo-100 tw-cursor-pointer" 
                                   id="file" name="file" accept=".pdf,.doc,.docx" required>
                        </div>
                        <p class="tw-text-xs tw-text-gray-500 tw-mt-1">Format: PDF, DOC, DOCX (Maks. 10MB)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informasi Petugas & Identitas Pengguna Sistem Section -->
        <div class="section-group">
            <h3 class="section-header">Informasi Petugas & Identitas Pengguna Sistem</h3>
            <div class="section-content">
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-4 tw-gap-y-2">
                    <div class="tw-space-y-1">
                        <label for="nama_petugas" class="form-label">Nama Petugas <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="nama_petugas" name="nama_petugas" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="sk_penunjukan" class="form-label">SK Penunjukan <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="sk_penunjukan" name="sk_penunjukan" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="user_id_goaml" class="form-label">User ID GoAML <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="user_id_goaml" name="user_id_goaml" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="user_id_sipesat" class="form-label">User ID SIPESAT <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="user_id_sipesat" name="user_id_sipesat" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="user_id_pep" class="form-label">User ID PEP <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="user_id_pep" name="user_id_pep" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="user_id_sipendar" class="form-label">User ID SIPENDAR <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="user_id_sipendar" name="user_id_sipendar" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistik Laporan ke PPATK Section -->
        <div class="section-group">
            <h3 class="section-header">Statistik Laporan ke PPATK</h3>
            <div class="section-content">
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-3 tw-gap-4 tw-gap-y-2">
                    <div class="tw-space-y-1">
                        <label for="jumlah_ltkt" class="form-label">Jumlah LTKT <span class="tw-text-red-500">*</span></label>
                        <input type="number" class="form-input" id="jumlah_ltkt" name="jumlah_ltkt" min="0" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="jumlah_ltkm" class="form-label">Jumlah LTKM <span class="tw-text-red-500">*</span></label>
                        <input type="number" class="form-input" id="jumlah_ltkm" name="jumlah_ltkm" min="0" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="jumlah_ltkl" class="form-label">Jumlah LTKL <span class="tw-text-red-500">*</span></label>
                        <input type="number" class="form-input" id="jumlah_ltkl" name="jumlah_ltkl" min="0" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Laporan SIPESAT Triwulanan Section -->
        <div class="section-group">
            <h3 class="section-header">Laporan SIPESAT Triwulanan</h3>
            <div class="section-content">
                <div class="tw-space-y-1 tw-mb-3"> <!-- Reduced margin -->
                    <label for="sipesat_uploaded_count" class="form-label">Laporan SIPESAT Triwulanan sudah di upload berapa saja? <span class="tw-text-red-500">*</span></label>
                    <input type="number" class="form-input" id="sipesat_uploaded_count" name="sipesat_uploaded_count" min="0" required>
                </div>

                <p class="tw-font-semibold tw-text-gray-700 tw-mt-3 tw-mb-2">Telah melakukan Laporan SIPESAT ke PPATK secara Triwulanan? <span class="tw-text-red-500">*</span></p> <!-- Reduced margin -->
                <div class="tw-overflow-x-auto">
                    <table class="form-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Sudah</th>
                                <th>Belum</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Lapor SIPESAT tw 1</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input sipesat-triwulan-status" type="radio" name="lapor_sipesat_tw_1" id="lapor_sipesat_tw_1_sudah" value="True" required>
                                        <label class="tw-sr-only" for="lapor_sipesat_tw_1_sudah">Sudah</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input sipesat-triwulan-status" type="radio" name="lapor_sipesat_tw_1" id="lapor_sipesat_tw_1_belum" value="False">
                                        <label class="tw-sr-only" for="lapor_sipesat_tw_1_belum">Belum</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Lapor SIPESAT tw 2</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input sipesat-triwulan-status" type="radio" name="lapor_sipesat_tw_2" id="lapor_sipesat_tw_2_sudah" value="True" required>
                                        <label class="tw-sr-only" for="lapor_sipesat_tw_2_sudah">Sudah</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input sipesat-triwulan-status" type="radio" name="lapor_sipesat_tw_2" id="lapor_sipesat_tw_2_belum" value="False">
                                        <label class="tw-sr-only" for="lapor_sipesat_tw_2_belum">Belum</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Lapor SIPESAT tw 3</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input sipesat-triwulan-status" type="radio" name="lapor_sipesat_tw_3" id="lapor_sipesat_tw_3_sudah" value="True" required>
                                        <label class="tw-sr-only" for="lapor_sipesat_tw_3_sudah">Sudah</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input sipesat-triwulan-status" type="radio" name="lapor_sipesat_tw_3" id="lapor_sipesat_tw_3_belum" value="False">
                                        <label class="tw-sr-only" for="lapor_sipesat_tw_3_belum">Belum</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Lapor SIPESAT tw 4</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input sipesat-triwulan-status" type="radio" name="lapor_sipesat_tw_4" id="lapor_sipesat_tw_4_sudah" value="True" required>
                                        <label class="tw-sr-only" for="lapor_sipesat_tw_4_sudah">Sudah</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input sipesat-triwulan-status" type="radio" name="lapor_sipesat_tw_4" id="lapor_sipesat_tw_4_belum" value="False">
                                        <label class="tw-sr-only" for="lapor_sipesat_tw_4_belum">Belum</label>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Laporan Pemblokiran/Penghapusan Section -->
        <div class="section-group">
            <h3 class="section-header">Laporan Pemblokiran/Penghapusan</h3>
            <div class="section-content">
                <p class="tw-font-semibold tw-text-gray-700 tw-mb-2">Lapor Pemblokiran DTTOT <span class="tw-text-red-500">*</span></p> <!-- Reduced margin -->
                <div class="tw-overflow-x-auto tw-mb-3"> <!-- Reduced margin -->
                    <table class="form-table" id="dttotTable">
                        <thead>
                            <tr>
                                <th>Dokumen</th>
                                <th>Sudah Dilaporkan</th>
                                <th>Belum Dilaporkan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>R/42/V/RES.6.1./2024/Densus, 2 May 24 (DTTOT/P-17/43/V/RES.6.1./2024)</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dttot-status" type="radio" name="dttot_status_1" id="dttot_status_1_sudah" value="True" required>
                                        <label class="tw-sr-only" for="dttot_status_1_sudah">Sudah Dilaporkan</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dttot-status" type="radio" name="dttot_status_1" id="dttot_status_1_belum" value="False">
                                        <label class="tw-sr-only" for="dttot_status_1_belum">Belum Dilaporkan</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>R/46/VII/RES.6.1./2024/Densus, 25 Jul 24 (DTTOT/P-18/47/VII/RES.6.1./2024)</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dttot-status" type="radio" name="dttot_status_2" id="dttot_status_2_sudah" value="True" required>
                                        <label class="tw-sr-only" for="dttot_status_2_sudah">Sudah Dilaporkan</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dttot-status" type="radio" name="dttot_status_2" id="dttot_status_2_belum" value="False">
                                        <label class="tw-sr-only" for="dttot_status_2_belum">Belum Dilaporkan</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Delisting: No. R/49/X/RES.6.1./2024/Densus, 21 Oct 24 (DTTOT/P-18a/50/X/RES.6.1./2024)</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dttot-status" type="radio" name="dttot_status_3" id="dttot_status_3_sudah" value="True" required>
                                        <label class="tw-sr-only" for="dttot_status_3_sudah">Sudah Dilaporkan</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dttot-status" type="radio" name="dttot_status_3" id="dttot_status_3_belum" value="False">
                                        <label class="tw-sr-only" for="dttot_status_3_belum">Belum Dilaporkan</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Freezing: R/52/XI/RES.6.1./2024/Densus, 7 Nov 24 (DTTOT/P-19/53/XI/RES.6.1./2024)</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dttot-status" type="radio" name="dttot_status_4" id="dttot_status_4_sudah" value="True" required>
                                        <label class="tw-sr-only" for="dttot_status_4_sudah">Sudah Dilaporkan</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dttot-status" type="radio" name="dttot_status_4" id="dttot_status_4_belum" value="False">
                                        <label class="tw-sr-only" for="dttot_status_4_belum">Belum Dilaporkan</label>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- Hidden input to store the aggregated DTTOT status -->
                    <input type="hidden" id="lapor_pemblokiran_dttot" name="lapor_pemblokiran_dttot" value="false">
                </div>

                <p class="tw-font-semibold tw-text-gray-700 tw-mb-2">Lapor Pemblokiran DPPSPM <span class="tw-text-red-500">*</span></p> <!-- Reduced margin -->
                <div class="tw-overflow-x-auto">
                    <table class="form-table" id="dppspmTable">
                        <thead>
                            <tr>
                                <th>Dokumen</th>
                                <th>Sudah Dilaporkan</th>
                                <th>Belum Dilaporkan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>R/230/DN.05.02/IV/2024, 17 Apr 24 (Keputusan Kepala PPATK No. 175 Year 2024)</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dppspm-status" type="radio" name="dppspm_status_1" id="dppspm_status_1_sudah" value="True" required>
                                        <label class="tw-sr-only" for="dppspm_status_1_sudah">Sudah Dilaporkan</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dppspm-status" type="radio" name="dppspm_status_1" id="dppspm_status_1_belum" value="False">
                                        <label class="tw-sr-only" for="dppspm_status_1_belum">Belum Dilaporkan</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>R/647/DN.05.02/4.1/XII/2024, 24 Des 24 (Keputusan Kepala PPATK No. 679 Year 2024)</td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dppspm-status" type="radio" name="dppspm_status_2" id="dppspm_status_2_sudah" value="True" required>
                                        <label class="tw-sr-only" for="dppspm_status_2_sudah">Sudah Dilaporkan</label>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check-container">
                                        <input class="form-check-input dppspm-status" type="radio" name="dppspm_status_2" id="dppspm_status_2_belum" value="False">
                                        <label class="tw-sr-only" for="dppspm_status_2_belum">Belum Dilaporkan</label>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- Hidden input to store the aggregated DPPSPM status -->
                    <input type="hidden" id="lapor_pemblokiran_dppspm" name="lapor_pemblokiran_dppspm" value="false">
                </div>
            </div>
        </div>

        <!-- Kebijakan dan Prosedur Section -->
        <div class="section-group">
            <h3 class="section-header">Kebijakan dan Prosedur</h3>
            <div class="section-content">
                <div class="tw-space-y-3"> <!-- Reduced space-y -->
                    <div class="tw-space-y-1">
                        <label for="tanggung_jawab_direksi" class="form-label">Tanggung Jawab Direksi dan Pengawasan Aktif Dewan Komisaris <span class="tw-text-red-500">*</span></label>
                        <textarea class="form-input" id="tanggung_jawab_direksi" name="tanggung_jawab_direksi" rows="4" required placeholder="Contoh: &#10;- Penetapan Komitmen Direksi dan Dewan Komisaris terhadap penerapan APU PPT dan PPSPM.&#10;- Pernyataan representasi atas penerapan APU PPT dan PPSPM.&#10;- Penetapan KPA PPT.&#10;- Penetapan Direksi atau pejabat setingkat Direksi yang membidangi fungsi kepatuhan sebagai PIC APU PPT dan PPSPM.&#10;- Kewajiban pelaporan dan pemantauan oleh Direksi dan Dewan Komisaris."></textarea>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="kebijakan_prosedur" class="form-label">Kebijakan dan Prosedur Tertulis <span class="tw-text-red-500">*</span></label>
                        <textarea class="form-input" id="kebijakan_prosedur" name="kebijakan_prosedur" rows="4" required placeholder="Contoh:&#10;- Kebijakan dan prosedur PMPJ, pemantauan dan pengkinian profil nasabah, pelaporan LTKT dan LTKM.&#10;- Kebijakan dan prosedur terkait sanksi internal.&#10;- Prosedur identifikasi nasabah dan/atau transaksi mencurigakan.&#10;- Prosedur pelaporan dan pemantauan transaksi.&#10;- Kebijakan dan prosedur audit internal."></textarea>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="metode_pmpj" class="form-label">Metode Pelaksanaan Prinsip Mengenali Pengguna Jasa (PMPJ) <span class="tw-text-red-500">*</span></label>
                        <textarea class="form-input" id="metode_pmpj" name="metode_pmpj" rows="4" required placeholder="Contoh:&#10;- Identifikasi dan verifikasi nasabah individu/korporasi.&#10;- Verifikasi dan identifikasi beneficial ownership.&#10;- Pemantauan transaksi dan profil nasabah.&#10;- Penyimpanan data PMPJ yang akurat dan terkini."></textarea>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="manajemen_risiko" class="form-label">Proses Manajemen Risiko <span class="tw-text-red-500">*</span></label>
                        <textarea class="form-input" id="manajemen_risiko" name="manajemen_risiko" rows="4" required placeholder="Contoh:&#10;- Telah melakukan identifikasi, penilaian risiko pencucian uang dan pendanaan terorisme.&#10;- Telah melakukan mitigasi risiko yang teridentifikasi.&#10;- Penilaian risiko APU PPT secara berkala."></textarea>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="manajemen_sdm" class="form-label">Manajemen Sumber Daya Manusia <span class="tw-text-red-500">*</span></label>
                        <textarea class="form-input" id="manajemen_sdm" name="manajemen_sdm" rows="4" required placeholder="Contoh:&#10;- Pelatihan APU PPT bagi seluruh karyawan.&#10;- Uji kompetensi atau sertifikasi bagi petugas APU PPT.&#10;- Penempatan pegawai yang memiliki pengetahuan dan pengalaman di bidang APU PPT."></textarea>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="sistem_pengendalian" class="form-label">Sistem Pengendalian Intern <span class="tw-text-red-500">*</span></label>
                        <textarea class="form-input" id="sistem_pengendalian" name="sistem_pengendalian" rows="4" required placeholder="Contoh:&#10;- Sistem IT yang mendukung pelaksanaan APU PPT.&#10;- Sistem audit internal yang efektif untuk APU PPT.&#10;- Prosedur pelaporan transaksi mencurigakan."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informasi Penginput Data Section -->
        <div class="section-group">
            <h3 class="section-header">Informasi Penginput Data</h3>
            <div class="section-content">
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-4 tw-gap-y-2">
                    <div class="tw-space-y-1">
                        <label for="nama_penginput" class="form-label">Nama Penginput <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="nama_penginput" name="nama_penginput" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="email_penginput" class="form-label">Email Penginput <span class="tw-text-red-500">*</span></label>
                        <input type="email" class="form-input" id="email_penginput" name="email_penginput" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="email_perusahaan" class="form-label">Email Perusahaan <span class="tw-text-red-500">*</span></label>
                        <input type="email" class="form-input" id="email_perusahaan" name="email_perusahaan" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="nomor_hp" class="form-label">Nomor HP <span class="tw-text-red-500">*</span></label>
                        <input type="tel" class="form-input" id="nomor_hp" name="nomor_hp" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pernyataan Section -->
        <div class="section-group">
            <h3 class="section-header">Pernyataan</h3>
            <div class="section-content">
                <div class="tw-flex tw-items-start">
                    <input class="tw-form-checkbox tw-h-4 tw-w-4 tw-text-indigo-600 focus:tw-ring-indigo-500 tw-border-gray-300 tw-rounded" type="checkbox" id="declaration" name="declaration" required> <!-- Reduced size -->
                    <label class="tw-ml-2 tw-block tw-text-sm tw-text-gray-900" for="declaration">
                        Sehubungan dengan penyampaian Laporan Tahunan APU, PPT, dan PPSPM Tahunan yang telah disampaikan, dengan ini saya mewakili Perusahaan menyatakan data dan informasi pada isian tersebut dengan lengkap dan benar.  
                        Apabila data/informasi yang diisi tidak lengkap dan tidak akurat, maka laporan yang disampaikan akan dianggap salah dan tidak disampaikan. 
                        Dalam hal terdapat perubahan, maka saya, mewakili perusahaan akan melakukan update data dan informasi tersebut. 
                    </label>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="tw-flex tw-justify-end tw-gap-3 tw-pt-4">
            <button type="submit" class="tw-inline-flex tw-items-center tw-px-6 tw-py-3 tw-border tw-border-transparent tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-white tw-bg-green-600 hover:tw-bg-green-700 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-green-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105" id="submitButton">
                <span class="submit-text">Kirim Laporan</span>
                <span class="spinner-border tw-w-5 tw-h-5 tw-ml-2 tw-border-2 tw-border-white tw-border-r-transparent tw-rounded-full tw-animate-spin d-none" role="status" aria-hidden="true"></span>
            </button>
            
            <button type="button" class="tw-inline-flex tw-items-center tw-px-6 tw-py-3 tw-border tw-border-gray-300 tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-gray-700 tw-bg-white hover:tw-bg-gray-100 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-indigo-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105" onclick="window.history.back()">
                Batal
            </button>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<!-- Message Box Backdrop -->
<div id="messageBoxBackdrop" class="d-none"></div>

<!-- Dynamic Message Box (Pop-up) -->
<div id="dynamicMessageBox" class="d-none">
    <div id="messageBoxIcon" class="icon-container"></div>
    <p id="messageBoxContent"></p>
    <button id="messageBoxOkButton" class="ok-button d-none">Oke</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('apuPptReportForm');
    const submitButton = document.getElementById('submitButton');
    const submitText = submitButton.querySelector('.submit-text');
    const submitSpinner = submitButton.querySelector('.spinner-border');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const messageBoxBackdrop = document.getElementById('messageBoxBackdrop');
    const dynamicMessageBox = document.getElementById('dynamicMessageBox');
    const messageBoxContent = document.getElementById('messageBoxContent');
    const messageBoxIcon = document.getElementById('messageBoxIcon');
    const messageBoxOkButton = document.getElementById('messageBoxOkButton');

    // Flag to prevent double submission
    let isSubmitting = false;

    // Event listener for the "Oke" button to close the message box
    messageBoxOkButton.addEventListener('click', () => {
        dynamicMessageBox.classList.add('d-none');
        messageBoxBackdrop.classList.add('d-none');
    });

    /**
     * Show custom message box with message and type (success/error)
     * @param {string} message - Message to display
     * @param {'success'|'error'} type - Message type ('success' or 'error')
     */
    function showMessageBox(message, type) {
        messageBoxContent.textContent = message;
        dynamicMessageBox.classList.remove('success', 'error');
        messageBoxIcon.innerHTML = '';
        messageBoxOkButton.classList.add('d-none');
        messageBoxBackdrop.classList.remove('d-none');

        if (type === 'success') {
            dynamicMessageBox.classList.add('success');
            messageBoxIcon.innerHTML = '&#10003;';
            messageBoxOkButton.classList.remove('d-none');
        } else if (type === 'error') {
            dynamicMessageBox.classList.add('error');
            messageBoxIcon.innerHTML = '&#x2716;';
            messageBoxOkButton.classList.remove('d-none');
            setTimeout(() => {
                if (!dynamicMessageBox.classList.contains('d-none')) {
                    dynamicMessageBox.classList.add('d-none');
                    messageBoxBackdrop.classList.add('d-none');
                }
            }, 5000);
        }
        dynamicMessageBox.classList.remove('d-none');
    }

    // Date validation
    const tanggalSuratInput = document.getElementById('tanggal_surat');
    if(tanggalSuratInput){
        const today = new Date().toISOString().split('T')[0];
        tanggalSuratInput.max = today;
    }

    // Function to update the aggregated boolean status for DTTOT and DPPSPM
    function updatePemblokiranStatus() {
        const dttotRadios = document.querySelectorAll('.dttot-status');
        const dppspmRadios = document.querySelectorAll('.dppspm-status');

        let allDttotReported = true;
        let dttotGroups = new Set();
        dttotRadios.forEach(radio => {
            const groupName = radio.name;
            dttotGroups.add(groupName);
            // Check if the 'Sudah Dilaporkan' option for this group is checked
            const sudahChecked = document.getElementById(`${groupName}_sudah`).checked;
            if (!sudahChecked) {
                allDttotReported = false;
            }
        });
        // Ensure all groups have at least one radio selected (this is handled by 'required' attribute)
        // If all 'Sudah Dilaporkan' are checked, then true, otherwise false.
        document.getElementById('lapor_pemblokiran_dttot').value = allDttotReported ? 'true' : 'false';

        let allDppspmReported = true;
        let dppspmGroups = new Set();
        dppspmRadios.forEach(radio => {
            const groupName = radio.name;
            dppspmGroups.add(groupName);
            const sudahChecked = document.getElementById(`${groupName}_sudah`).checked;
            if (!sudahChecked) {
                allDppspmReported = false;
            }
        });
        document.getElementById('lapor_pemblokiran_dppspm').value = allDppspmReported ? 'true' : 'false';
    }

    // Add event listeners to DTTOT and DPPSPM radio buttons
    document.querySelectorAll('.dttot-status, .dppspm-status').forEach(radio => {
        radio.addEventListener('change', updatePemblokiranStatus);
    });

    // Initial call to set the status on page load
    updatePemblokiranStatus();


    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();

        // Check if form is already submitting
        if (isSubmitting) {
            console.log("Form submission already in progress. Ignoring.");
            return;
        }

        let formIsValid = true;

        // Year validation
        const tahun = document.getElementById('tahun_laporan').value;
        const currentYear = new Date().getFullYear();
        if (parseInt(tahun) > currentYear) {
            showMessageBox('Tahun laporan tidak boleh melebihi tahun berjalan.', 'error');
            formIsValid = false;
        }

        // File validation
        const fileInput = document.getElementById('file'); 
        if (fileInput.files[0] && fileInput.files[0].size > 10 * 1024 * 1024) {
            showMessageBox('Ukuran file dokumen laporan melebihi 10MB.', 'error');
            formIsValid = false;
        }

        // Declaration checkbox validation
        if (!document.getElementById('declaration').checked) {
            showMessageBox('Anda harus menyetujui pernyataan sebelum mengirim laporan.', 'error');
            formIsValid = false;
        }

        // Validate radio buttons for SIPESAT Triwulan status
        const sipesatTriwulanNames = ['lapor_sipesat_tw_1', 'lapor_sipesat_tw_2', 'lapor_sipesat_tw_3', 'lapor_sipesat_tw_4'];
        sipesatTriwulanNames.forEach(name => {
            const radios = document.querySelectorAll(`input[name="${name}"]`);
            const isChecked = Array.from(radios).some(radio => radio.checked);
            if (!isChecked) {
                showMessageBox(`Harap lengkapi status laporan untuk ${name.replace(/_/g, ' ').toUpperCase()}.`, 'error');
                formIsValid = false;
            }
        });

        // Validate DTTOT and DPPSPM radio buttons
        // The updatePemblokiranStatus function already handles the aggregation logic.
        // We just need to ensure all required radio groups have a selection.
        const dttotRadioGroups = ['dttot_status_1', 'dttot_status_2', 'dttot_status_3', 'dttot_status_4'];
        dttotRadioGroups.forEach(name => {
            const radios = document.querySelectorAll(`input[name="${name}"]`);
            const isChecked = Array.from(radios).some(radio => radio.checked);
            if (!isChecked) {
                showMessageBox(`Harap lengkapi semua status laporan DTTOT untuk ${name.replace(/_/g, ' ').toUpperCase()}.`, 'error');
                formIsValid = false;
            }
        });

        const dppspmRadioGroups = ['dppspm_status_1', 'dppspm_status_2'];
        dppspmRadioGroups.forEach(name => {
            const radios = document.querySelectorAll(`input[name="${name}"]`);
            const isChecked = Array.from(radios).some(radio => radio.checked);
            if (!isChecked) {
                showMessageBox(`Harap lengkapi semua status laporan DPPSPM untuk ${name.replace(/_/g, ' ').toUpperCase()}.`, 'error');
                formIsValid = false;
            }
        });

        if (!formIsValid) {
            // Reset loading state if client-side validation fails
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            loadingOverlay.classList.add('d-none');
            isSubmitting = false;
            return;
        }

        // Show loading state
        isSubmitting = true;
        submitButton.disabled = true;
        submitText.textContent = 'Mengirim...';
        submitSpinner.classList.remove('d-none');
        loadingOverlay.classList.remove('d-none');
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || JSON.stringify(errorData) || 'Gagal mengirim laporan (status non-2xx)');
                }).catch(jsonError => {
                    console.error("Error parsing JSON from non-OK response:", jsonError);
                    return response.text().then(text => {
                        throw new Error(`Gagal mengirim laporan. Respons server: ${text.substring(0, 100)}...`);
                    });
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showMessageBox(data.message || 'Laporan berhasil dikirim!', 'success');
                form.reset();
                // Re-run updatePemblokiranStatus after form reset to clear hidden inputs
                updatePemblokiranStatus();
            } else {
                showMessageBox(data.message || 'Gagal mengirim laporan.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessageBox(error.message || 'Terjadi kesalahan jaringan atau server.', 'error');
        })
        .finally(() => {
            // Always reset loading state
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            loadingOverlay.classList.add('d-none');
            isSubmitting = false;
        });
    });
});
</script>
{% endblock %}
