{% extends 'user/base.html' %}

{% block title %}Laporan Manajemen{% endblock %}

{% block extra_head %}
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Global styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Spinner utility */
        .spinner-border {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: middle;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        .d-none { display: none !important; }

        /* Section styling - compact */
        .section-group {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 0;
            margin-bottom: 1rem; /* Reduced margin */
            overflow: hidden;
        }

        .section-group .section-header {
            font-size: 1.15rem; /* Smaller header */
            font-weight: 700;
            color: #1f2937;
            background-color: #eef2f6;
            padding: 0.8rem 1.5rem; /* Reduced padding */
            margin: 0 -1px 0.8rem -1px; /* Reduced margin */
            border-bottom: 1px solid #e0e7eb;
            border-top-left-radius: 11px;
            border-top-right-radius: 11px;
        }

        .section-group .section-content {
            padding: 1.2rem; /* Reduced padding */
            padding-top: 0;
        }

        /* Form elements - compact */
        .form-label {
            font-size: 0.95rem; /* Smaller labels */
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.3rem; /* Reduced margin */
        }

        .form-input {
            font-size: 0.9rem; /* Smaller font */
            padding: 0.7rem 1rem; /* Reduced padding */
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px; /* Slightly rounder corners */
            color: #4b5563;
            transition: all 0.2s ease;
            min-height: 40px; /* Reduced minimum height */
            box-sizing: border-box;
        }

        /* Date inputs */
        input[type="date"].form-input {
            font-size: 0.9rem;
            padding: 0.7rem 1rem;
            min-height: 40px;
            appearance: none;
            background-color: white;
        }

        /* Select dropdowns */
        select.form-input {
            font-size: 0.9rem;
            padding: 0.7rem 1rem;
            min-height: 40px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23374151' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            background-size: 14px 10px;
            padding-right: 2.2rem;
        }

        /* File input */
        .file-input-container {
            margin-top: 0.3rem;
        }
        
        .file-input-container input[type="file"] {
            font-size: 0.9rem;
            padding: 0.7rem 1rem;
        }

        /* Styles for dynamic members (Komisaris/Direksi) - compact */
        .management-member-item {
            border: 1px solid #e0e7eb;
            border-radius: 8px;
            padding: 0.8rem; /* Reduced padding */
            margin-bottom: 0.8rem; /* Reduced margin */
            background-color: #fcfdfe;
            position: relative;
        }
        .management-member-item .remove-item-btn {
            position: absolute;
            top: 0.3rem; /* Adjusted position */
            right: 0.3rem; /* Adjusted position */
            background-color: #fef2f2;
            color: #ef4444;
            border: 1px solid #fecaca;
            border-radius: 9999px;
            padding: 0.2rem; /* Reduced padding */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem; /* Reduced size */
            height: 1.8rem; /* Reduced size */
            transition: all 0.2s ease-in-out;
        }
        .management-member-item .remove-item-btn:hover {
            background-color: #fee2e2;
            color: #dc2626;
        }
        .management-member-item .remove-item-btn svg {
            width: 0.9rem; /* Reduced icon size */
            height: 0.9rem; /* Reduced icon size */
        }

        /* Table styles for Executive Summary - compact */
        .form-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0.8rem; /* Reduced margin */
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.9rem; /* Smaller font for table text */
        }
        .form-table th, .form-table td {
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            padding: 0.6rem; /* Reduced padding */
            vertical-align: top;
        }
        .form-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            text-align: left;
        }
        .form-table th:first-child { width: 5%; text-align: center; }
        .form-table th:nth-child(2) { width: 45%; } 
        .form-table th:nth-child(3) { width: 10%; text-align: center;} 
        .form-table th:nth-child(4) { width: 40%; } 

        .form-table td:first-child {
            text-align: center;
            font-weight: 500;
            color: #374151;
        }
        .form-table td:last-child,
        .form-table th:last-child {
            border-right: none;
        }
        .form-table tr:last-child td {
            border-bottom: none;
        }
        .executive-summary-text {
            min-height: 60px; /* Shorter textarea */
            resize: vertical;
            width: 100%;
            font-size: 0.85rem; /* Smaller font for textarea */
        }
        .word-count-info {
            font-size: 0.7rem; /* Smaller font size */
            color: #6b7280;
            margin-top: 0.15rem; /* Reduced margin */
        }
        .word-count-error {
            color: #ef4444;
            font-weight: 500;
        }

        /* Custom checkbox styling - compact */
        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 1.1rem; /* Reduced size */
            height: 1.1rem; /* Reduced size */
            border: 2px solid #9ca3af;
            border-radius: 0.2rem; /* Slightly smaller radius */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
            display: inline-block;
            vertical-align: middle;
            margin-top: -0.1rem; /* Adjusted position */
        }
        .custom-checkbox:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .custom-checkbox:checked::after {
            content: '';
            display: block;
            width: 0.4rem; /* Smaller checkmark */
            height: 0.7rem; /* Smaller checkmark */
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg) translate(-50%, -50%);
            position: absolute;
            top: 40%;
            left: 50%;
        }
        .custom-checkbox:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-input {
                padding: 0.9rem;
                min-height: 45px;
            }
            
            .section-group .section-header {
                font-size: 1.15rem;
                padding: 0.9rem 1rem;
            }
            
            .management-member-item {
                padding: 0.75rem;
            }
            
            .form-table th, 
            .form-table td {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
        }

        /* Styles for the loading overlay (kept consistent) */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        #loadingOverlay .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.35em;
            color: #ffffff;
        }

        /* Styles for the message box backdrop */
        #messageBoxBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
        }

        /* Styles for the message box pop-up */
        #dynamicMessageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            max-width: 400px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        #dynamicMessageBox.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #dynamicMessageBox.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #dynamicMessageBox .icon-container {
            font-size: 3rem;
            line-height: 1;
            animation: fade-in-scale 0.5s ease-out forwards;
        }

        @keyframes fade-in-scale {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #dynamicMessageBox .ok-button {
            background-color: #4CAF50;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s ease;
        }

        #dynamicMessageBox .ok-button:hover {
            background-color: #45a049;
        }
    </style>
{% endblock %}

{% block content %}
<div class="tw-max-w-4xl tw-mx-auto tw-my-8 tw-p-6 tw-bg-white tw-rounded-2xl tw-shadow-2xl tw-space-y-4">
    <h2 class="tw-text-2xl tw-font-extrabold tw-text-gray-900 tw-text-center tw-border-b-4 tw-border-indigo-600 tw-pb-3 tw-mb-4">
        Laporan Manajemen & Hasil Pengawasan Dewan Komisaris
    </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="tw-p-3 tw-rounded-lg tw-text-sm tw-font-semibold tw-text-center {% if category == 'success' %}tw-bg-green-100 tw-text-green-800 tw-border tw-border-green-300{% else %}tw-bg-red-100 tw-text-red-800 tw-border tw-border-red-300{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('submit_laporan_manajemen') }}" enctype="multipart/form-data" id="managementForm" class="tw-space-y-4">
        
        <!-- Informasi Umum Laporan Section -->
        <div class="section-group">
            <h3 class="section-header">Informasi Umum Laporan</h3>
            <div class="section-content">
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-4 tw-gap-y-2">
                    <div class="tw-space-y-1">
                        <label for="tahun" class="form-label">Tahun Laporan <span class="tw-text-red-500">*</span></label>
                        <select class="form-input" id="tahun" name="tahun" required>
                            <option value="">-- Pilih Tahun --</option>
                            {% for year_option in range(current_year - 5, current_year + 2) %}
                            <option value="{{ year_option }}" {% if year_option == current_year %}selected{% endif %}>{{ year_option }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="nomor_surat" class="form-label">Nomor Surat <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="nomor_surat" name="nomor_surat" required>
                    </div>
                    
                    <div class="md:tw-col-span-2 tw-space-y-1">
                        <label for="tanggal_surat" class="form-label">Tanggal Surat <span class="tw-text-red-500">*</span></label>
                        <input type="date" class="form-input" id="tanggal_surat" name="tanggal_surat" required>
                    </div>
                    
                    <div class="md:tw-col-span-2 tw-space-y-1">
                        <label for="file_laporan" class="form-label">Upload File Laporan (PDF/DOC/DOCX) <span class="tw-text-red-500">*</span></label>
                        <div class="file-input-container">
                            <input type="file" class="tw-block tw-w-full tw-text-sm tw-text-gray-500 file:tw-mr-4 file:tw-py-2 file:tw-px-3 file:tw-rounded-lg file:tw-border-0 file:tw-text-base file:tw-font-semibold file:tw-bg-indigo-50 file:tw-text-indigo-700 hover:file:tw-bg-indigo-100 tw-cursor-pointer" 
                                   id="file_laporan" name="file_laporan" accept=".pdf,.doc,.docx" required>
                        </div>
                        <p class="tw-text-xs tw-text-gray-500 tw-mt-1">Format: PDF, DOC, DOCX (Maks. 10MB)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pejabat yang Bertandatangan Section -->
        <div class="section-group">
            <h3 class="section-header">Pejabat yang Bertandatangan</h3>
            <div class="section-content">
                <p class="tw-text-sm tw-text-gray-700 tw-mb-3">
                    Silakan masukkan nama, jabatan, dan klasifikasi (Komisaris atau Direksi) dari setiap anggota manajemen yang menandatangani laporan ini.
                </p>
                <div id="management-members-container" class="tw-space-y-3">
                    <!-- Dynamic fields will be added here -->
                </div>
                <button type="button" class="tw-inline-flex tw-items-center tw-px-3 tw-py-2 tw-border tw-border-transparent tw-text-sm tw-font-medium tw-rounded-md tw-shadow-sm tw-text-indigo-700 tw-bg-indigo-100 hover:tw-bg-indigo-200 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-indigo-500 tw-transition tw-duration-150 tw-ease-in-out mt-3" id="add-management-member">
                    <svg class="tw-w-4 tw-h-4 tw-mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> Tambah Anggota Manajemen
                </button>
            </div>
        </div>

        <!-- Ringkasan Laporan Manajemen Section -->
        <div class="section-group">
            <h3 class="section-header">Ringkasan Laporan Manajemen</h3>
            <div class="section-content">
                <div id="executive-summary-section" class="tw-space-y-3">
                    <div class="tw-overflow-x-auto">
                        <table class="form-table">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Sub Laporan</th>
                                    <th class="text-center">Tersedia di Laporan?</th>
                                    <th>Executive Summary</th>
                                </tr>
                            </thead>
                            <tbody id="executive-summary-table-body">
                                <!-- Rows will be dynamically added/pre-populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informasi Kepemilikan & Tambahan Section -->
        <div class="section-group">
            <h3 class="section-header">Informasi Kepemilikan & Tambahan</h3>
            <div class="section-content">
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-4 tw-gap-y-2">
                    <div class="tw-space-y-1">
                        <label for="kepemilikan_domestik" class="form-label">Persentase Kepemilikan Domestik (%) <span class="tw-text-red-500">*</span></label>
                        <input type="number" class="form-input" id="kepemilikan_domestik" name="persentase_kepemilikan_domestik" min="0" max="100" step="0.01" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="pengendalian_domestik" class="form-label">Pengendalian Domestik (Jumlah) <span class="tw-text-red-500">*</span></label>
                        <input type="number" class="form-input" id="pengendalian_domestik" name="pengendalian_domestik" min="0" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="kepemilikan_asing" class="form-label">Persentase Kepemilikan Asing (%) <span class="tw-text-red-500">*</span></label>
                        <input type="number" class="form-input" id="kepemilikan_asing" name="persentase_kepemilikan_asing" min="0" max="100" step="0.01" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="pengendalian_asing" class="form-label">Pengendalian Asing (Jumlah) <span class="tw-text-red-500">*</span></label>
                        <input type="number" class="form-input" id="pengendalian_asing" name="pengendalian_asing" min="0" required>
                    </div>
                    
                    <div class="md:tw-col-span-2 tw-space-y-1">
                        <label for="pihak_pengendali_ubo" class="form-label">Pihak Pengendali UBO <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="pihak_pengendali_ubo" name="pihak_pengendali_ubo" required>
                    </div>
                    
                    <div class="md:tw-col-span-2 tw-space-y-1">
                        <label for="keterangan" class="form-label">Keterangan Tambahan</label>
                        <textarea class="form-input" id="keterangan" name="keterangan" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="tw-flex tw-justify-end tw-gap-3 tw-pt-4">
            <button type="submit" class="tw-inline-flex tw-items-center tw-px-6 tw-py-3 tw-border tw-border-transparent tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-white tw-bg-green-600 hover:tw-bg-green-700 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-green-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105" id="submitButton">
                <span class="submit-text">Kirim Laporan</span>
                <span class="spinner-border tw-w-5 tw-h-5 tw-ml-2 tw-border-2 tw-border-white tw-border-r-transparent tw-rounded-full tw-animate-spin d-none" role="status" aria-hidden="true"></span>
            </button>
            
            <button type="button" class="tw-inline-flex tw-items-center tw-px-6 tw-py-3 tw-border tw-border-gray-300 tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-gray-700 tw-bg-white hover:tw-bg-gray-100 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-indigo-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105" onclick="window.history.back()">
                Batal
            </button>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<!-- Message Box Backdrop -->
<div id="messageBoxBackdrop" class="d-none"></div>

<!-- Dynamic Message Box (Pop-up) -->
<div id="dynamicMessageBox" class="d-none">
    <div id="messageBoxIcon" class="icon-container"></div>
    <p id="messageBoxContent"></p>
    <button id="messageBoxOkButton" class="ok-button d-none">Oke</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('managementForm');
    const submitButton = document.getElementById('submitButton');
    const submitText = submitButton.querySelector('.submit-text');
    const submitSpinner = submitButton.querySelector('.spinner-border');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const messageBoxBackdrop = document.getElementById('messageBoxBackdrop');
    const dynamicMessageBox = document.getElementById('dynamicMessageBox');
    const messageBoxContent = document.getElementById('messageBoxContent');
    const messageBoxIcon = document.getElementById('messageBoxIcon');
    const messageBoxOkButton = document.getElementById('messageBoxOkButton');

    // Flag untuk mencegah pengiriman ganda
    let isSubmitting = false;

    // Event listener untuk tombol "Oke" untuk menutup kotak pesan
    messageBoxOkButton.addEventListener('click', () => {
        dynamicMessageBox.classList.add('d-none');
        messageBoxBackdrop.classList.add('d-none');
    });

    /**
     * Menampilkan kotak pesan kustom dengan pesan dan tipe (sukses/error)
     * @param {string} message - Pesan yang akan ditampilkan
     * @param {'success'|'error'} type - Tipe pesan ('success' atau 'error')
     */
    function showMessageBox(message, type) {
        messageBoxContent.textContent = message;
        dynamicMessageBox.classList.remove('success', 'error');
        messageBoxIcon.innerHTML = '';
        messageBoxOkButton.classList.add('d-none');
        messageBoxBackdrop.classList.remove('d-none');

        if (type === 'success') {
            dynamicMessageBox.classList.add('success');
            messageBoxIcon.innerHTML = '&#10003;'; // Ikon centang
            messageBoxOkButton.classList.remove('d-none');
        } else if (type === 'error') {
            dynamicMessageBox.classList.add('error');
            messageBoxIcon.innerHTML = '&#x2716;'; // Ikon silang
            messageBoxOkButton.classList.remove('d-none'); // Tampilkan tombol OK untuk error juga
            // Auto-hide setelah 5 detik jika tidak diklik
            setTimeout(() => {
                if (!dynamicMessageBox.classList.contains('d-none')) {
                    dynamicMessageBox.classList.add('d-none');
                    messageBoxBackdrop.classList.add('d-none');
                }
            }, 5000); // Sembunyikan setelah 5 detik
        }
        dynamicMessageBox.classList.remove('d-none');
    }

    // Validasi tanggal
    const tanggalSuratInput = document.getElementById('tanggal_surat');
    if(tanggalSuratInput){
        const today = new Date().toISOString().split('T')[0];
        tanggalSuratInput.max = today;
    }

    // --- JavaScript untuk Anggota Manajemen ---
    const managementMembersContainer = document.getElementById('management-members-container');
    let memberCounter = 0;

    function addManagementMember(name = '', position = '', classification = '') {
        memberCounter++;
        const newItem = document.createElement('div');
        newItem.className = 'management-member-item tw-space-y-1'; /* Reduced space-y */
        newItem.innerHTML = `
            <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-3 tw-gap-4 tw-gap-y-2"> 
                <div class="tw-space-y-1">
                    <label class="form-label">Nama <span class="tw-text-red-500">*</span></label>
                    <input type="text" class="form-input" name="member_name_${memberCounter}" value="${name}" required>
                </div>
                <div class="tw-space-y-1">
                    <label class="form-label">Jabatan <span class="tw-text-red-500">*</span></label>
                    <input type="text" class="form-input" name="member_position_${memberCounter}" value="${position}" required>
                </div>
                <div class="tw-space-y-1">
                    <label class="form-label">Klasifikasi <span class="tw-text-red-500">*</span></label>
                    <select class="form-input" name="member_classification_${memberCounter}" required>
                        <option value="">-- Pilih Klasifikasi --</option>
                        <option value="Komisaris" ${classification === 'Komisaris' ? 'selected' : ''}>Komisaris</option>
                        <option value="Direksi" ${classification === 'Direksi' ? 'selected' : ''}>Direksi</option>
                    </select>
                </div>
            </div>
            <button type="button" class="remove-item-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </button>
        `;
        managementMembersContainer.appendChild(newItem);

        newItem.querySelector('.remove-item-btn').addEventListener('click', function() {
            newItem.remove();
            updateManagementMemberNumbers();
        });
        updateManagementMemberNumbers();
    }

    function updateManagementMemberNumbers() {
        const items = managementMembersContainer.querySelectorAll('.management-member-item');
        memberCounter = 0; // Reset counter
        items.forEach((item) => {
            memberCounter++;
            // Update name attributes to ensure correct indexing for form submission
            item.querySelectorAll('input, select').forEach(input => {
                const oldName = input.name;
                const baseName = oldName.substring(0, oldName.lastIndexOf('_'));
                input.name = `${baseName}_${memberCounter}`;
            });
        });
    }

    document.getElementById('add-management-member').addEventListener('click', function() {
        addManagementMember();
    });
    // --- End JavaScript untuk Anggota Manajemen ---

    // --- JavaScript untuk Tabel Ringkasan Eksekutif ---
    const executiveSummaryTableBody = document.getElementById('executive-summary-table-body');
    
    // Definisikan struktur untuk setiap poin ringkasan dengan deskripsi lengkapnya
    const summaryPoints = [
        { name: "Penilaian Dewan Komisaris terhadap kondisi perekonomian terkini & perkembangan industri SP", id: "penilaian_perkembangan_industri_sp" },
        { name: "Hasil Pengawasan Dewan Komisaris terhadap perkembangan bisnis PJP kinerja PJP, termasuk langkah strategis yang telah dilakukan antara lain terkait permodalan pengembangan infrastruktur sistem informasi SDM", id: "pengawasan_perkembangan_bisnis_pjp" },
        { name: "Hasil Pengawasan Dewan Komisaris terhadap pelaksanaan tata kelola dan manajemen risiko termasuk prinsip kehati hatian oleh PJP", id: "pengawasan_tata_kelola_pjp" },
        { name: "Pandangan dari Dewan Komisaris untuk mendorong PJP agar menjadi lebih baik lagi", id: "pandangan_perbaikan_pjp" },
        { name: "Penjelasan perubahan komposisi Dewan Komisaris (apabila ada)", id: "perubahan_komposisi_komisaris" },
        { name: "Laporan pertanggungjawaban Direksi yang mencakup: Implementasi kebijakan Direksi", id: "implementasi_kebijakan_direksi" },
        { name: "Laporan pertanggungjawaban Direksi yang mencakup: Proses yang dilakukan Direksi untuk memastikan pencapaian kinerja tahun pelaporan", id: "proses_pencapaian_kinerja" },
        { name: "Laporan pertanggungjawaban Direksi yang mencakup: Perbandingan antara hasil yang dicapai dengan yang ditargetkan PJP/PIP, paling sedikit memuat realisasi selama satu tahun terakhir dibandingkan tahun sebelumnya", id: "perbandingan_target_dan_realisasi" },
        { name: "Laporan pertanggungjawaban Direksi yang mencakup: Kendala yang dihadapi PJP", id: "kendala_yang_dihadapi_pjp" },
        { name: "Penerapan tata kelola dan manajemen risiko yang mencakup: Pengawasan aktif direksi dan dewan komisaris", id: "tata_kelola_pengawasan_direksi_komisaris" },
        { name: "Penerapan tata kelola dan manajemen risiko yang mencakup: Proses dan Fungsi Manajemen Risiko termasuk SDM", id: "tata_kelola_risiko_sdm" },
        { name: "Penerapan tata kelola dan manajemen risiko yang mencakup: Ketersediaan kebijakan dan prosedur", id: "tata_kelola_ketersediaan_prosedur" },
        { name: "Penerapan tata kelola dan manajemen risiko yang mencakup: Pengendalian intern", id: "tata_kelola_pengendalian_intern" },
        { name: "Asesmen kecukupan struktur organisasi dan SDM, yang mencakup: Kualitas: Rencana pengembangan SDM terkait SP", id: "asesmen_kualitatif_sdm" },
        { name: "Asesmen kecukupan struktur organisasi dan SDM, yang mencakup: Kuantitas: Asesmen kecukupan SDM SP, jabatan kosong, dan target pemenuhan", id: "asesmen_kuantitatif_sdm" },
        { name: "Asesmen struktur kepemilikan (termasuk informasi struktur kepemilikan sampai ultimate shareholder) (Sesuai PBI PJP Pasal 19 atau PBI PIP pasal 21) Struktur kepemilikan domestik dan asing apabila ada ) sampai dengan ultimate shareholder sesuai PBI PJP pasal 19 dan PBI PIP pasal 21 (Persentase kepemilikan dan pengendalian dihitung berdasarkan nominal saham)", id: "asesmen_kepemilikan_domestik_asing" },
        { name: "Asesmen struktur pengendalian termasuk informasi struktur pengendalian sampai ultimate shareholder Struktur pengendalian domestik dan asing apabila ada ) sampai dengan ultimate shareholder sesuai PBI PJP pasal 20 dan PBI PIP pasal 22 (Persentase kepemilikan dan pengendalian dihitung berdasarkan nominal saham)", id: "asesmen_pengendalian_domestik_asing" },
        { name: "Asesmen permodalan dan investasi (jika tidak memenuhi Kewajiban Permodalan Sistem Pembayaran maka disampaikan rencana penambahan modal)", id: "asesmen_pemenuhan_modal" },
        { name: "Asesmen manajemen risiko dan standar keamanan sistem informasi (sesuai dengan kewajiban pemenuhan MRSI)", id: "asesmen_manajemen_risiko_it" },
        { name: "Pemantauan kepatuhan (apabila ada ) termasuk komitmen", id: "pemantauan_kepatuhan" }
    ];

    function populateExecutiveSummaryTable() {
        executiveSummaryTableBody.innerHTML = ''; // Hapus baris yang ada
        summaryPoints.forEach((point, index) => {
            const rowNumber = index + 1;
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${rowNumber}</td>
                <td>
                    <div class="tw-font-semibold tw-text-gray-800">${point.name}</div>
                </td>
                <td class="text-center">
                    <div class="form-check-container">
                        <input class="custom-checkbox summary-status-checkbox" type="checkbox" 
                               name="${point.id}_status" id="${point.id}_status_${rowNumber}" value="True">
                        <label class="tw-sr-only" for="${point.id}_status_${rowNumber}">Status</label>
                    </div>
                </td>
                <td>
                    <textarea class="form-input executive-summary-text" 
                               name="${point.id}_detail" rows="2" 
                               placeholder="Isi ringkasan jika tersedia..." disabled></textarea>
                    <p class="word-count-info"></p>
                </td>
            `;
            executiveSummaryTableBody.appendChild(newRow);

            const statusCheckbox = newRow.querySelector(`#${point.id}_status_${rowNumber}`);
            const detailTextarea = newRow.querySelector(`textarea[name="${point.id}_detail"]`);
            const wordCountInfo = newRow.querySelector('.word-count-info');

            // Tambahkan event listener untuk mengaktifkan/menonaktifkan textarea dan required
            statusCheckbox.addEventListener('change', function() {
                detailTextarea.disabled = !this.checked;
                detailTextarea.required = this.checked;
                if (!this.checked) {
                    detailTextarea.value = ''; // Kosongkan konten jika tidak dicentang
                    detailTextarea.classList.remove('tw-border-red-500'); // Hapus gaya error
                    wordCountInfo.textContent = ''; // Kosongkan info jumlah kata
                } else {
                    // Picu pemeriksaan jumlah kata awal jika diaktifkan kembali dan memiliki konten
                    detailTextarea.dispatchEvent(new Event('input'));
                }
            });

            // Tambahkan validasi jumlah kata untuk textarea
            detailTextarea.addEventListener('input', function() {
                const words = this.value.match(/\S+/g) || [];
                const wordCount = words.length;
                const minWords = 10;
                const maxWords = 100;
                
                wordCountInfo.textContent = `Min ${minWords}, Max ${maxWords} kata. (${wordCount}/${maxWords} kata)`;
                if (wordCount < minWords || wordCount > maxWords) {
                    detailTextarea.classList.add('tw-border-red-500');
                    wordCountInfo.classList.add('word-count-error');
                } else {
                    detailTextarea.classList.remove('tw-border-red-500');
                    wordCountInfo.classList.remove('word-count-error');
                }
            });
        });
    }

    // Selalu isi tabel ringkasan eksekutif
    populateExecutiveSummaryTable(); 
    // --- End JavaScript untuk Tabel Ringkasan Eksekutif ---

    // Handler pengiriman formulir
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Mencegah pengiriman ganda
        if (isSubmitting) {
            console.log("Pengiriman formulir sudah berjalan. Mengabaikan.");
            return;
        }

        let formIsValid = true;
        
        // Validasi ukuran file
        const fileLaporanInput = document.getElementById('file_laporan');
        if (fileLaporanInput.files[0] && fileLaporanInput.files[0].size > 10 * 1024 * 1024) { // 10MB
            showMessageBox('Ukuran file laporan melebihi 10MB.', 'error');
            formIsValid = false;
        }

        // Validasi total persentase kepemilikan
        const kepemilikanDomestik = parseFloat(document.getElementById('kepemilikan_domestik').value) || 0;
        const kepemilikanAsing = parseFloat(document.getElementById('kepemilikan_asing').value) || 0;
        if (Math.round((kepemilikanDomestik + kepemilikanAsing) * 100) / 100 !== 100) {
            showMessageBox('Total persentase kepemilikan domestik dan asing harus tepat 100%.', 'error');
            formIsValid = false;
        }

        // Validasi anggota manajemen
        const managementMembers = managementMembersContainer.querySelectorAll('.management-member-item');
        if (managementMembers.length === 0) {
            showMessageBox('Harap tambahkan setidaknya satu Anggota Manajemen (Komisaris atau Direksi).', 'error');
            formIsValid = false;
        } else {
            managementMembers.forEach((item, index) => {
                const nameInput = item.querySelector(`input[name="member_name_${index + 1}"]`);
                const positionInput = item.querySelector(`input[name="member_position_${index + 1}"]`);
                const classificationSelect = item.querySelector(`select[name="member_classification_${index + 1}"]`);

                if (!nameInput.value.trim() || !positionInput.value.trim() || !classificationSelect.value) {
                    showMessageBox(`Data Anggota Manajemen #${index + 1} tidak lengkap. Harap isi semua field.`, 'error');
                    formIsValid = false;
                }
            });
        }

        // Validasi textarea ringkasan eksekutif berdasarkan kotak centang statusnya
        executiveSummaryTableBody.querySelectorAll('.summary-status-checkbox').forEach(checkbox => {
            const detailTextarea = checkbox.closest('tr').querySelector('.executive-summary-text');
            if (checkbox.checked) {
                const words = detailTextarea.value.match(/\S+/g) || [];
                const wordCount = words.length;
                const minWords = 10;
                const maxWords = 100;
                if (wordCount < minWords || wordCount > maxWords) {
                    detailTextarea.classList.add('tw-border-red-500'); // Tambahkan kelas error
                    formIsValid = false;
                    showMessageBox(`Pastikan semua ringkasan eksekutif yang dicentang memiliki antara ${minWords} dan ${maxWords} kata.`, 'error');
                } else {
                    detailTextarea.classList.remove('tw-border-red-500'); // Hapus kelas error
                }
            } else {
                // Jika kotak centang tidak dicentang, pastikan textarea kosong
                if (detailTextarea.value.trim() !== '') {
                    showMessageBox('Ringkasan eksekutif harus kosong jika statusnya tidak dicentang.', 'error');
                    formIsValid = false;
                }
            }
        });

        if (!formIsValid) {
            console.log("Form tidak valid, pengiriman dibatalkan.");
            // Pastikan status loading direset jika validasi sisi klien gagal
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            loadingOverlay.classList.add('d-none');
            isSubmitting = false;
            return;
        }

        // Tampilkan status loading
        isSubmitting = true;
        submitButton.disabled = true;
        submitText.textContent = 'Mengirim...';
        submitSpinner.classList.remove('d-none');
        loadingOverlay.classList.remove('d-none');
        
        const formData = new FormData(this);

        // Kumpulkan data anggota manajemen dinamis secara manual
        const membersData = [];
        managementMembersContainer.querySelectorAll('.management-member-item').forEach((item, index) => {
            const name = item.querySelector(`input[name="member_name_${index + 1}"]`).value;
            const position = item.querySelector(`input[name="member_position_${index + 1}"]`).value;
            const classification = item.querySelector(`select[name="member_classification_${index + 1}"]`).value;
            membersData.push({
                name: name,
                position: position,
                classification: classification
            });
        });
        formData.append('management_members_json', JSON.stringify(membersData));

        // Kumpulkan data ringkasan eksekutif sebagai string JSON
        const executiveSummaries = [];
        executiveSummaryTableBody.querySelectorAll('tr').forEach(row => {
            const statusCheckbox = row.querySelector('.summary-status-checkbox');
            const detailTextarea = row.querySelector('.executive-summary-text');
            const keterangan = row.querySelector('td:nth-child(2) div').textContent; // Dapatkan teks statis

            executiveSummaries.push({
                keterangan: keterangan,
                status: statusCheckbox.checked,
                executive_summary: detailTextarea.value.trim()
            });
        });
        formData.append('executive_summaries_json', JSON.stringify(executiveSummaries));
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
        })
        .then(async response => { // Menggunakan async/await untuk penanganan respons yang lebih baik
            // Sembunyikan spinner dan overlay setelah respons diterima
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            loadingOverlay.classList.add('d-none');
            isSubmitting = false; // Reset flag

            let responseData;
            let errorMessage = 'Terjadi kesalahan tidak dikenal.';

            try {
                // Coba parse respons sebagai JSON terlebih dahulu
                responseData = await response.json();
            } catch (jsonError) {
                // Jika parsing JSON gagal, coba dapatkan teks mentah
                try {
                    errorMessage = await response.text();
                    // Potong pesan jika terlalu panjang
                    errorMessage = errorMessage.substring(0, 200) + (errorMessage.length > 200 ? '...' : '');
                } catch (textError) {
                    errorMessage = 'Gagal membaca respons server.';
                }
                // Lempar Error baru agar ditangkap oleh blok .catch() di luar
                throw new Error(errorMessage);
            }

            // Jika respons tidak OK (misalnya, status 4xx atau 5xx)
            if (!response.ok) {
                // Gunakan pesan dari data JSON yang sudah di-parse, atau pesan generik
                errorMessage = responseData.message || JSON.stringify(responseData) || 'Gagal mengirim laporan (status non-2xx).';
                // Jika backend membungkus pesan dalam kunci 'message' bersarang (seperti data.message.message)
                if (responseData.message && typeof responseData.message === 'object' && responseData.message.message) {
                    errorMessage = responseData.message.message;
                }
                throw new Error(errorMessage);
            }

            // Jika respons OK (status 2xx)
            return responseData;
        })
        .then(data => {
            // Blok ini hanya tercapai jika response.ok adalah true dan JSON berhasil di-parse
            // Akses data.message jika backend membungkus pesan dalam kunci 'message'
            let messageToDisplay = 'Laporan berhasil dikirim!';
            if (data.message) {
                if (typeof data.message === 'object' && data.message.message) {
                    messageToDisplay = data.message.message;
                } else if (typeof data.message === 'string') {
                    messageToDisplay = data.message;
                }
            }

            if (data.status >= 200 && data.status < 300) { // Periksa status 2xx dari respons JSON
                showMessageBox(messageToDisplay, 'success');
                form.reset();
                // Reset bidang dinamis setelah pengiriman berhasil
                managementMembersContainer.innerHTML = ''; // Hapus semua anggota dinamis
                memberCounter = 0; // Reset counter
                populateExecutiveSummaryTable(); // Isi ulang tabel ke keadaan awal
            } else {
                // Fallback jika 'success' tidak ada atau false dalam respons 200 OK
                showMessageBox(messageToDisplay || 'Gagal mengirim laporan.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessageBox(error.message || 'Terjadi kesalahan jaringan atau server.', 'error');
        })
        .finally(() => {
            // Selalu reset status loading
            isSubmitting = false;
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            loadingOverlay.classList.add('d-none');
        });
    });

    // Tangani reset formulir untuk memastikan status awal yang benar untuk bidang dinamis
    form.addEventListener('reset', function() {
        setTimeout(() => {
            managementMembersContainer.innerHTML = ''; // Hapus anggota dinamis
            memberCounter = 0; // Reset counter
            populateExecutiveSummaryTable(); // Isi ulang tabel ke keadaan awal
        }, 0);
    });

    // Tambahkan anggota manajemen awal saat halaman dimuat
    addManagementMember();
});
</script>
{% endblock %}
