{% extends 'user/base.html' %}

{% block title %}Laporan Manajemen{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-12 col-lg-10">
        <div class="card shadow-lg p-4">
            <!-- Modals for Success, Error, Loading -->
            <div class="modal fade" id="successModalManajemen" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">Sukses!</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p id="successMessageManajemen">Laporan berhasil dikirim!</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" data-bs-dismiss="modal">Tutup</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="errorModalManajemen" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Error!</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p id="errorMessageManajemen">Terjadi kesalahan saat mengirim laporan.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Tutup</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="loadingModalManajemen" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center py-4">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="mt-3 mb-0">Mengirim laporan...</h5>
                            <p class="text-muted small">Harap tunggu sebentar</p>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="text-center mb-4">Laporan Manajemen</h3>
            <form method="POST" action="{{ url_for('submit_laporan_manajemen') }}" enctype="multipart/form-data" id="managementForm">
                <div class="row mb-4">
                    <div class="col-md-12 mb-3">
                        <label for="tahun" class="form-label">Tahun Laporan <span class="text-danger">*</span></label>
                        <select class="form-select form-select-lg" id="tahun" name="tahun" required>
                            <option value="">-- Pilih Tahun --</option>
                            {% for year_option in range(current_year - 5, current_year + 2) %}
                            <option value="{{ year_option }}" {% if year_option == current_year %}selected{% endif %}>{{ year_option }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <label for="nomor_surat" class="form-label">Nomor Surat <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-lg" id="nomor_surat" name="nomor_surat" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tanggal_surat" class="form-label">Tanggal Surat <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="tanggal_surat" name="tanggal_surat" required>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Komposisi Komisaris</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="jumlah_komisaris" class="form-label">Jumlah Komisaris <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="jumlah_komisaris" name="jumlah_komisaris" min="0" required>
                            </div>
                        </div>

                        <div id="komisaris-container">
                            </div>

                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="tambah-komisaris">
                            <i class="bi bi-plus-circle"></i> Tambah Komisaris
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Komposisi Direksi</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="jumlah_direksi" class="form-label">Jumlah Direksi <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="jumlah_direksi" name="jumlah_direksi" min="0" required>
                            </div>
                        </div>

                        <div id="direksi-container">
                            </div>

                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="tambah-direksi">
                            <i class="bi bi-plus-circle"></i> Tambah Direksi
                        </button>
                    </div>
                </div>

                <!-- Bagian Ringkasan Laporan Manajemen yang diubah menjadi tabel -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Ringkasan Laporan Manajemen <span class="text-danger">*</span></h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">No.</th>
                                    <th style="width: 50%;">Isi Laporan</th>
                                    <th style="width: 45%;">Executive Summary</th>
                                </tr>
                            </thead>
                            <tbody id="executive-summary-table-body">
                                <!-- Baris akan ditambahkan secara dinamis di sini -->
                            </tbody>
                        </table>
                        <!-- Tombol "Tambah Baris Ringkasan" dihapus -->
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <label for="kepemilikan_domestik" class="form-label">Persentase Kepemilikan Domestik (%) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control form-control-lg" id="kepemilikan_domestik" 
                               name="persentase_kepemilikan_domestik" min="0" max="100" step="0.01" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="kepemilikan_asing" class="form-label">Persentase Kepemilikan Asing (%) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control form-control-lg" id="kepemilikan_asing" 
                               name="persentase_kepemilikan_asing" min="0" max="100" step="0.01" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="keterangan" class="form-label">Keterangan Tambahan</label>
                    <textarea class="form-control form-control-lg" id="keterangan" name="keterangan" rows="3"></textarea>
                </div>

                <div class="mb-4">
                    <label for="file_laporan" class="form-label">Upload File Laporan <span class="text-danger">*</span></label>
                    <input type="file" class="form-control form-control-lg" id="file_laporan" 
                           name="file_laporan" accept=".pdf,.doc,.docx" required>
                    <div class="form-text">Format: PDF, DOC, DOCX (Maks. 10MB)</div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <span class="submit-text">Kirim Laporan</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .form-text {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .card-header {
        font-weight: 600;
    }
    .remove-item {
        padding: 0.25rem 0.5rem;
    }
    .btn-primary .spinner-border {
        vertical-align: middle;
        margin-left: 5px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('managementForm');
    const submitButton = form.querySelector('button[type="submit"]');
    const submitText = submitButton.querySelector('.submit-text');
    const submitSpinner = submitButton.querySelector('.spinner-border');
    
    const loadingModalElement = document.getElementById('loadingModalManajemen');
    const successModalElement = document.getElementById('successModalManajemen');
    const errorModalElement = document.getElementById('errorModalManajemen');

    const loadingModal = new bootstrap.Modal(loadingModalElement);
    const successModal = new bootstrap.Modal(successModalElement);
    const errorModal = new bootstrap.Modal(errorModalElement);
    
    const successMessageElement = document.getElementById('successMessageManajemen');
    const errorMessageElement = document.getElementById('errorMessageManajemen');

    const tanggalSuratInput = document.getElementById('tanggal_surat');
    if(tanggalSuratInput){
        const today = new Date().toISOString().split('T')[0];
        tanggalSuratInput.max = today;
    }

    // --- JavaScript for Komisaris and Direksi (Reverted to original) ---
    function addManagementMember(containerId, type, countInputId) {
        const container = document.getElementById(containerId);
        const newItem = document.createElement('div');
        newItem.className = type + '-item mb-3 border p-3 rounded';
        newItem.innerHTML = `
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label">Nama ${type.charAt(0).toUpperCase() + type.slice(1)} <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="nama_${type}[]" required>
                </div>
                <div class="col-md-5 mb-2">
                    <label class="form-label">Keterangan/Jabatan <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="keterangan_${type}[]" required>
                </div>
                <div class="col-md-1 mb-2 d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-item" title="Hapus ${type}">
                        <i class="bi bi-trash"></i> Hapus
                    </button>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        document.getElementById(countInputId).value = container.children.length;

        newItem.querySelector('.remove-item').addEventListener('click', function() {
            newItem.remove();
            document.getElementById(countInputId).value = container.children.length;
        });
    }
    
    const jumlahKomisarisInput = document.getElementById('jumlah_komisaris');
    const komisarisContainer = document.getElementById('komisaris-container');
    document.getElementById('tambah-komisaris').addEventListener('click', function() {
        addManagementMember('komisaris-container', 'komisaris', 'jumlah_komisaris');
    });
    // Sync input number with dynamic fields for Komisaris
    if(jumlahKomisarisInput) {
        jumlahKomisarisInput.addEventListener('change', function() {
            const targetCount = parseInt(this.value) || 0;
            const currentCount = komisarisContainer.children.length;
            if (targetCount > currentCount) {
                for (let i = currentCount; i < targetCount; i++) {
                    addManagementMember('komisaris-container', 'komisaris', 'jumlah_komisaris');
                }
            } else if (targetCount < currentCount) {
                for (let i = currentCount; i > targetCount; i--) {
                    if (komisarisContainer.lastElementChild) komisarisContainer.lastElementChild.remove();
                }
            }
            this.value = komisarisContainer.children.length; // Update count based on actual fields
        });
    }

    const jumlahDireksiInput = document.getElementById('jumlah_direksi');
    const direksiContainer = document.getElementById('direksi-container');
    document.getElementById('tambah-direksi').addEventListener('click', function() {
         addManagementMember('direksi-container', 'direksi', 'jumlah_direksi');
    });
    // Sync input number with dynamic fields for Direksi
    if(jumlahDireksiInput) {
        jumlahDireksiInput.addEventListener('change', function() {
            const targetCount = parseInt(this.value) || 0;
            const currentCount = direksiContainer.children.length;
            if (targetCount > currentCount) {
                for (let i = currentCount; i < targetCount; i++) {
                    addManagementMember('direksi-container', 'direksi', 'jumlah_direksi');
                }
            } else if (targetCount < currentCount) {
                for (let i = currentCount; i > targetCount; i--) {
                    if (direksiContainer.lastElementChild) direksiContainer.lastElementChild.remove();
                }
            }
             this.value = direksiContainer.children.length; // Update count based on actual fields
        });
    }
    // --- End of JavaScript for Komisaris and Direksi ---


    // --- JavaScript for Executive Summary Table ---
    const executiveSummaryTableBody = document.getElementById('executive-summary-table-body');
    let executiveSummaryCounter = 0;

    function addExecutiveSummaryRow(keteranganValue = '', executiveSummaryValue = '') {
        executiveSummaryCounter++;
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${executiveSummaryCounter}</td>
            <td>
                <div class="keterangan-static-text fw-bold">${keteranganValue}</div>
            </td>
            <td>
                <textarea class="form-control form-control-sm executive-summary-text" 
                          name="executive_summary_detail[]" rows="2" 
                          minlength="10" maxlength="100" required>${executiveSummaryValue}</textarea>
                <div class="form-text">Min 10, Max 100 kata.</div>
            </td>
            <!-- Kolom Aksi dihapus -->
        `;
        executiveSummaryTableBody.appendChild(newRow);

        // Add event listeners for word counting and validation for the editable textarea
        newRow.querySelector('.executive-summary-text').addEventListener('input', function() {
            const words = this.value.match(/\S+/g) || [];
            const wordCount = words.length;
            const minWords = 10;
            const maxWords = 100;
            const formText = this.nextElementSibling;

            if (formText) {
                formText.textContent = `Min ${minWords}, Max ${maxWords} kata. (${wordCount}/${maxWords} kata)`;
                if (wordCount < minWords || wordCount > maxWords) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            }
        });
        // Trigger initial count and validation for newly added row
        newRow.querySelector('.executive-summary-text').dispatchEvent(new Event('input')); 
    }

    function updateExecutiveSummaryRowNumbers() {
        const rows = executiveSummaryTableBody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.querySelector('td:first-child').textContent = index + 1;
        });
        executiveSummaryCounter = rows.length;
    }

    // Tombol 'tambah-executive-summary' dihapus, sehingga event listener ini juga dihapus
    // document.getElementById('tambah-executive-summary').addEventListener('click', function() {
    //     addExecutiveSummaryRow('', ''); 
    // });

    // Pre-populate the table with data from the document
    const predefinedSummaries = [
        "Penilaian Dewan Komisaris terhadap kondisi perekonomian terkini & perkembangan industri SP",
        "Hasil Pengawasan Dewan Komisaris terhadap perkembangan bisnis PJP kinerja PJP, termasuk langkah strategis yang telah dilakukan antara lain terkait permodalan pengembangan infrastruktur sistem informasi SDM",
        "Hasil Pengawasan Dewan Komisaris terhadap pelaksanaan tata Kelola dan manajemen risiko termasuk prinsip kehati hatian oleh PJP",
        "Pandangan dari Dewan Komisaris untuk mendorong PJP agar menjadi lebih baik lagi",
        "Penjelasan perubahan komposisi Dewan Komisaris (apabila ada)",
        "Laporan pertanggungjawaban Direksi yang mencakup: Implementasi kebijakan Direksi",
        "Laporan pertanggungjawaban Direksi yang mencakup: Proses yang dilakukan Direksi untuk memastikan pencapaian kinerja tahun pelaporan",
        "Laporan pertanggungjawaban Direksi yang mencakup: Perbandingan antara hasil yang dicapai dengan yang ditargetkan PJP/PIP, paling sedikit memuat realisasi selama satu tahun terakhir dibandingkan tahun sebelumnya",
        "Laporan pertanggungjawaban Direksi yang mencakup: Kendala yang dihadapi PJP",
        "Penerapan tata kelola dan manajemen risiko yang mencakup: Pengawasan aktif direksi dan dewan komisaris",
        "Penerapan tata kelola dan manajemen risiko yang mencakup: Proses dan Fungsi Manajemen Risiko termasuk SDM",
        "Penerapan tata kelola dan manajemen risiko yang mencakup: Ketersediaan kebijakan dan prosedur",
        "Penerapan tata kelola dan manajemen risiko yang mencakup: Pengendalian intern",
        "Asesmen kecukupan struktur organisasi dan SDM, yang mencakup: Kualitas: Rencana pengembangan SDM terkait SP",
        "Asesmen kecukupan struktur organisasi dan SDM, yang mencakup: Kuantitas: Asesmen kecukupan SDM SP, jabatan kosong, dan target pemenuhan",
        "Asesmen struktur kepemilikan (termasuk informasi struktur kepemilikan sampai ultimate shareholder) (Sesuai PBI PJP Pasal 19 atau PBI PIP pasal 21) Struktur kepemilikan domestik dan asing apabila ada ) sampai dengan ultimate shareholder sesuai PBI PJP pasal 19 dan PBI PIP pasal 21 (Persentase kepemilikan dan pengendalian dihitung berdasarkan nominal saham)",
        "Asesmen struktur pengendalian termasuk informasi struktur pengendalian sampai ultimate shareholder Struktur pengendalian domestik dan asing apabila ada ) sampai dengan ultimate shareholder sesuai PBI PJP pasal 20 dan PBI PIP pasal 22 (Persentase kepemilikan dan pengendalian dihitung berdasarkan nominal saham)",
        "Asesmen permodalan dan investasi (jika tidak memenuhi Kewajiban Permodalan Sistem Pembayaran maka disampaikan rencana penambahan modal)",
        "Asesmen manajemen risiko dan standar keamanan sistem informasi (sesuai dengan kewajiban pemenuhan MRSI)",
        "Pemantauan kepatuhan (apabila ada ) termasuk komitmen"
    ];

    predefinedSummaries.forEach(item => {
        addExecutiveSummaryRow(item, ''); 
    });
    // --- End of JavaScript for Executive Summary Table ---


    form.addEventListener('submit', function(e) {
        e.preventDefault();
        let formIsValid = true;
        
        const domestic = parseFloat(document.getElementById('kepemilikan_domestik').value) || 0;
        const foreign = parseFloat(document.getElementById('kepemilikan_asing').value) || 0;
        
        if (Math.round((domestic + foreign) * 100) / 100 !== 100) {
            errorMessageElement.textContent = 'Total kepemilikan domestik dan asing harus tepat 100%.';
            errorModal.show();
            formIsValid = false;
        }

        const fileLaporanInput = document.getElementById('file_laporan');
        if (fileLaporanInput.files[0] && fileLaporanInput.files[0].size > 10 * 1024 * 1024) { // 10MB
            errorMessageElement.textContent = 'Ukuran file laporan melebihi 10MB.';
            errorModal.show();
            formIsValid = false;
        }
        
        // Validate jumlah komisaris/direksi matches the dynamic fields
        if (parseInt(jumlahKomisarisInput.value) !== komisarisContainer.children.length) {
            errorMessageElement.textContent = 'Jumlah komisaris tidak sesuai dengan detail yang diinput.';
            errorModal.show();
            formIsValid = false;
        }
        if (parseInt(jumlahDireksiInput.value) !== direksiContainer.children.length) {
            errorMessageElement.textContent = 'Jumlah direksi tidak sesuai dengan detail yang diinput.';
            errorModal.show();
            formIsValid = false;
        }

        // Validate executive summary textareas (only the editable ones)
        executiveSummaryTableBody.querySelectorAll('.executive-summary-text').forEach(textarea => {
            const words = textarea.value.match(/\S+/g) || [];
            const wordCount = words.length;
            const minWords = 10;
            const maxWords = 100;
            if (wordCount < minWords || wordCount > maxWords) {
                textarea.classList.add('is-invalid');
                formIsValid = false;
                errorMessageElement.textContent = `Pastikan semua ringkasan eksekutif memiliki antara ${minWords} dan ${maxWords} kata.`;
                errorModal.show();
            } else {
                textarea.classList.remove('is-invalid');
            }
        });

        if (!formIsValid) return;

        submitButton.disabled = true;
        submitText.textContent = 'Mengirim...';
        submitSpinner.classList.remove('d-none');
        loadingModal.show();
        
        const formData = new FormData(this);

        // Collect executive summary data as JSON string
        const executiveSummaries = [];
        executiveSummaryTableBody.querySelectorAll('tr').forEach(row => {
            const keterangan = row.querySelector('.keterangan-static-text').textContent; // Get text content
            const detail = row.querySelector('.executive-summary-text').value;
            executiveSummaries.push({
                keterangan: keterangan,
                executive_summary: detail
            });
        });
        formData.append('executive_summaries_json', JSON.stringify(executiveSummaries));
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
        })
        .then(response => {
            loadingModal.hide();
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                successMessageElement.textContent = data.message || 'Laporan berhasil dikirim!';
                successModal.show();
                form.reset();
                // Clear and re-populate dynamic fields for Komisaris/Direksi and Executive Summary table
                komisarisContainer.innerHTML = '';
                jumlahKomisarisInput.value = 0;
                direksiContainer.innerHTML = '';
                jumlahDireksiInput.value = 0;
                executiveSummaryTableBody.innerHTML = ''; 
                executiveSummaryCounter = 0; 
                predefinedSummaries.forEach(item => { 
                    addExecutiveSummaryRow(item, '');
                });
            } else {
                errorMessageElement.textContent = data.message || 'Gagal mengirim laporan.';
                errorModal.show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loadingModal.hide();
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            errorMessageElement.textContent = 'Terjadi kesalahan jaringan atau server.';
            errorModal.show();
        });
    });
});
</script>
{% endblock %}
