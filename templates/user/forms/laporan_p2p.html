{% extends 'user/base.html' %}

{% block title %}Laporan Kerjasama P2P{% endblock %}

{% block extra_head %}
<!-- Font Inter -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* Global styles */
    body {
        font-family: 'Inter', sans-serif;
    }

    /* Spinner utility */
    .spinner-border {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        vertical-align: middle;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }

    @keyframes spinner-border {
        to { transform: rotate(360deg); }
    }

    .d-none { display: none !important; }

    /* Enhanced form styling - compact */
    .section-group {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 0;
        margin-bottom: 1rem; /* Reduced margin */
        overflow: hidden;
    }

    .section-group .section-header {
        font-size: 1.15rem; /* Smaller header */
        font-weight: 700;
        color: #1f2937;
        background-color: #eef2f6;
        padding: 0.8rem 1.5rem; /* Reduced padding */
        margin: 0 -1px 0.8rem -1px; /* Reduced margin */
        border-bottom: 1px solid #e0e7eb;
        border-top-left-radius: 11px;
        border-top-right-radius: 11px;
    }

    .section-group .section-content {
        padding: 1.2rem; /* Reduced padding */
        padding-top: 0;
    }

    /* Smaller form elements */
    .form-label {
        font-size: 0.95rem; /* Smaller labels */
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.3rem; /* Reduced margin */
    }

    .form-input {
        font-size: 0.9rem; /* Smaller font */
        padding: 0.7rem 1rem; /* Reduced padding */
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 8px; /* Slightly rounder corners */
        color: #4b5563;
        transition: all 0.2s ease;
        min-height: 40px; /* Reduced minimum height */
        box-sizing: border-box;
    }

    /* Special styling for date inputs to make them appear smaller */
    input[type="date"].form-input,
    input[type="datetime-local"].form-input {
        font-size: 0.9rem;
        padding: 0.7rem 1rem;
        min-height: 40px;
        appearance: none; /* Remove default styling */
        background-color: white;
    }

    /* Make select dropdowns match the smaller style */
    select.form-input {
        font-size: 0.9rem;
        padding: 0.7rem 1rem;
        min-height: 40px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23374151' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.8rem center;
        background-size: 14px 10px;
        padding-right: 2.2rem;
    }

    textarea.form-input {
        min-height: 100px; /* Shorter textareas */
        resize: vertical;
    }

    /* File input styling */
    .file-input-container {
        margin-top: 0.3rem; /* Reduced margin */
    }
    
    .file-input-container input[type="file"] {
        font-size: 0.9rem; /* Smaller font */
        padding: 0.7rem 1rem; /* Reduced padding */
    }

    /* Button styling - smaller and more compact */
    .btn {
        font-size: 0.95rem;
        padding: 0.8rem 1.2rem; /* Reduced padding */
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background-color: #4f46e5;
        color: white;
        border: none;
    }

    .btn-primary:hover {
        background-color: #4338ca;
        transform: translateY(-1px);
    }

    /* Company item styling */
    .company-item {
        padding: 1.2rem; /* Reduced padding */
        border: 2px dashed #e5e7eb;
        border-radius: 10px; /* Slightly smaller border radius */
        background-color: white;
        position: relative;
        margin-bottom: 1rem; /* Reduced margin */
    }
    
    /* Adjust gap for grid layouts */
    .tw-gap-4 {
        gap: 0.75rem; /* Reduced gap */
    }
    .tw-gap-x-6 {
        column-gap: 1.5rem; /* Reduced column gap */
    }
    .tw-gap-y-2 {
        row-gap: 0.5rem; /* Reduced row gap */
    }

    /* Loading overlay and message box styles (kept consistent) */
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(3px);
    }

    #loadingOverlay .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.35em;
        color: #ffffff;
    }

    /* Styles for the message box backdrop */
    #messageBoxBackdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none;
    }

    /* Styles for the message box pop-up */
    #dynamicMessageBox {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 1.5rem 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        display: none;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
        max-width: 400px;
        width: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    #dynamicMessageBox.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    #dynamicMessageBox.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    #dynamicMessageBox .icon-container {
        font-size: 3rem;
        line-height: 1;
        animation: fade-in-scale 0.5s ease-out forwards;
    }

    @keyframes fade-in-scale {
        from {
            opacity: 0;
            transform: scale(0.5);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    #dynamicMessageBox .ok-button {
        background-color: #4CAF50;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 700;
        transition: background-color 0.3s ease;
    }

    #dynamicMessageBox .ok-button:hover {
        background-color: #45a049;
    }
</style>

{% endblock %}

{% block content %}
<div class="tw-max-w-4xl tw-mx-auto tw-my-8 tw-p-6 tw-bg-white tw-rounded-2xl tw-shadow-2xl tw-space-y-4"> <!-- Reduced space-y -->
    
    <h2 class="tw-text-2xl tw-font-extrabold tw-text-gray-900 tw-text-center tw-border-b-4 tw-border-indigo-600 tw-pb-3 tw-mb-4"> <!-- Reduced text size, padding, margin -->
        Laporan Kerjasama P2P
    </h2>
    
    <p class="tw-text-center tw-text-sm tw-font-medium tw-text-red-700 tw-bg-red-50 tw-p-2 tw-rounded-lg tw-border tw-border-red-200"> <!-- Reduced padding -->
        Penyampaian data laporan ini tidak menggugurkan kewajiban pelaporan ke LKKPBU
    </p>

    <form method="POST" action="{{ url_for('submit_laporan_p2p') }}" enctype="multipart/form-data" id="p2pCooperationForm" class="tw-space-y-4"> <!-- Reduced space-y -->
        
        <!-- Informasi Laporan Section -->
        <div class="section-group">
            <h3 class="section-header">Informasi Laporan</h3>
            <div class="section-content">
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-4 tw-gap-y-2"> <!-- Reduced gap -->
                    <div class="tw-space-y-1"> <!-- Added space-y for label/input spacing -->
                        <label for="tahun_laporan" class="form-label">Tahun Laporan <span class="tw-text-red-500">*</span></label>
                        <select class="form-input" id="tahun_laporan" name="tahun_laporan" required>
                            <option value="">-- Pilih Tahun --</option>
                            {% for year in range(current_year - 1, current_year + 2) %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="periode_laporan" class="form-label">Periode Laporan (Bulan) <span class="tw-text-red-500">*</span></label>
                        <select class="form-input" id="periode_laporan" name="periode_laporan" required>
                            <option value="">-- Pilih Bulan --</option>
                            <option value="Januari">Januari</option>
                            <option value="Februari">Februari</option>
                            <option value="Maret">Maret</option>
                            <option value="April">April</option>
                            <option value="Mei">Mei</option>
                            <option value="Juni">Juni</option>
                            <option value="Juli">Juli</option>
                            <option value="Agustus">Agustus</option>
                            <option value="September">September</option>
                            <option value="Oktober">Oktober</option>
                            <option value="November">November</option>
                            <option value="Desember">Desember</option>
                        </select>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="tanggal_surat" class="form-label">Tanggal Surat <span class="tw-text-red-500">*</span></label>
                        <input type="date" class="form-input" id="tanggal_surat" name="tanggal_surat" required>
                    </div>
                    
                    <div class="tw-space-y-1">
                        <label for="nomor_surat" class="form-label">Nomor Surat <span class="tw-text-red-500">*</span></label>
                        <input type="text" class="form-input" id="nomor_surat" name="nomor_surat" required>
                    </div>
                    
                    <div class="md:tw-col-span-2 tw-space-y-1">
                        <label for="file" class="form-label">Dokumen Laporan Kerjasama (PDF) <span class="tw-text-red-500">*</span></label>
                        <div class="file-input-container">
                            <input type="file" class="tw-block tw-w-full tw-text-sm tw-text-gray-500 file:tw-mr-4 file:tw-py-2 file:tw-px-3 file:tw-rounded-lg file:tw-border-0 file:tw-text-base file:tw-font-semibold file:tw-bg-indigo-50 file:tw-text-indigo-700 hover:file:tw-bg-indigo-100 tw-cursor-pointer"
                                        id="file" name="file" accept=".pdf" required>
                        </div>
                        <p class="tw-text-xs tw-text-gray-500 tw-mt-1">Format: PDF (Maks. 5MB)</p> <!-- Reduced text size and margin -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Daftar Perusahaan Section -->
        <div class="section-group">
            <h3 class="section-header">Daftar Perusahaan Kerjasama P2P</h3>
            <div class="section-content">
                <div class="tw-mb-4 tw-space-y-1"> <!-- Reduced margin -->
                    <label for="jumlah_perusahaan_kerjasama_p2p" class="form-label">Jumlah Perusahaan Kerjasama P2P <span class="tw-text-red-500">*</span></label>
                    <input type="number" class="form-input" id="jumlah_perusahaan_kerjasama_p2p" name="jumlah_perusahaan_kerjasama_p2p" min="0" required value="1">
                </div>

                <hr class="tw-border-gray-300 tw-my-4"> <!-- Reduced margin -->

                <div class="tw-mb-4 tw-space-y-1"> <!-- Reduced margin -->
                    <label for="excelFileInput" class="form-label">Impor Data Perusahaan dari Excel</label>
                    <div class="file-input-container">
                        <input type="file" class="tw-block tw-w-full tw-text-sm tw-text-gray-500 file:tw-mr-4 file:tw-py-2 file:tw-px-3 file:tw-rounded-lg file:tw-border-0 file:tw-text-base file:tw-font-semibold file:tw-bg-indigo-50 file:tw-text-indigo-700 hover:file:tw-bg-indigo-100 tw-cursor-pointer"
                                        id="excelFileInput" accept=".xlsx, .xls">
                    </div>
                    <p class="tw-text-xs tw-text-gray-500 tw-mt-1">Unggah file Excel (.xlsx atau .xls) dengan format yang sesuai.</p> <!-- Reduced text size and margin -->
                    
                    <div class="tw-flex tw-flex-wrap tw-gap-2 tw-mt-3"> <!-- Reduced gap and margin -->
                        <button type="button" id="importExcelBtn" class="btn btn-primary">
                            <svg class="tw-w-4 tw-h-4 tw-mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <!-- Reduced icon size -->
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Impor Excel
                        </button>
                        
                        <button type="button" id="downloadTemplateBtn" class="tw-inline-flex tw-items-center tw-px-3 tw-py-2 tw-border tw-border-gray-300 tw-text-sm tw-font-bold tw-rounded-lg tw-text-gray-700 tw-bg-white hover:tw-bg-gray-50 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-indigo-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105"> <!-- Reduced padding, text size, rounded -->
                            <svg class="tw-w-4 tw-h-4 tw-mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <!-- Reduced icon size -->
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Unduh Template CSV
                        </button>
                    </div>
                </div>

                <hr class="tw-border-gray-300 tw-my-4"> <!-- Reduced margin -->

                <!-- Company List Container -->
                <div id="companyListContainer" class="tw-space-y-4"> <!-- Reduced space-y -->
                    <div class="company-item tw-p-4"> <!-- Reduced padding -->
                        <h4 class="tw-text-base tw-font-bold tw-text-gray-800 tw-mb-3">Perusahaan Kerjasama #<span class="company-number">1</span></h4> <!-- Reduced text size, margin -->
                        
                        <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-x-4 tw-gap-y-2"> <!-- Reduced gap -->
                            <div class="tw-space-y-1">
                                <label for="nama_perusahaan_kerjasama_1" class="form-label">Nama Perusahaan Kerjasama <span class="tw-text-red-500">*</span></label>
                                <input type="text" class="form-input" id="nama_perusahaan_kerjasama_1" name="nama_perusahaan_kerjasama_1" required>
                            </div>
                            
                            <div class="tw-space-y-1">
                                <label for="peran_pjp_1" class="form-label">Peran PJP <span class="tw-text-red-500">*</span></label>
                                <select class="form-input peran-pjp-select" id="peran_pjp_1" name="peran_pjp_1" required>
                                    <option value="">-- Pilih Peran --</option>
                                    <option value="Penyelenggara">Penyelenggara</option>
                                    <option value="Mitra">Mitra</option>
                                    <option value="Penjamin">Penjamin</option>
                                    <option value="Lainnya">Lainnya</option>
                                </select>
                                <div class="peran-pjp-custom-input tw-mt-1" style="display: none;"> <!-- Reduced margin -->
                                    <label for="peran_pjp_custom_1" class="tw-sr-only">Peran PJP Kustom</label>
                                    <input type="text" class="form-input" id="peran_pjp_custom_1" name="peran_pjp_custom_1" placeholder="Masukkan peran kustom">
                                </div>
                            </div>
                            
                            <div class="tw-space-y-1">
                                <label for="tanggal_mulai_kerjasama_1" class="form-label">Tanggal Mulai Kerja Sama <span class="tw-text-red-500">*</span></label>
                                <input type="date" class="form-input" id="tanggal_mulai_kerjasama_1" name="tanggal_mulai_kerjasama_1" required>
                            </div>
                            
                            <div class="tw-space-y-1">
                                <label for="tanggal_akhir_kerjasama_1" class="form-label">Tanggal Akhir Kerja Sama</label>
                                <input type="date" class="form-input" id="tanggal_akhir_kerjasama_1" name="tanggal_akhir_kerjasama_1">
                            </div>
                            
                            <div class="md:tw-col-span-2 tw-space-y-1">
                                <label for="keterangan_perusahaan_1" class="form-label">Keterangan</label>
                                <input type="text" class="form-input" id="keterangan_perusahaan_1" name="keterangan_perusahaan_1">
                            </div>
                        </div>
                        
                        <button type="button" class="remove-company-btn tw-absolute tw-top-2 tw-right-2 tw-text-red-600 hover:tw-text-red-800 tw-font-bold tw-p-1 tw-rounded-full tw-bg-red-100 hover:tw-bg-red-200 tw-transition-colors tw-duration-150" style="display: none;"> <!-- Reduced padding, top/right position -->
                            <svg class="tw-w-4 tw-h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"> <!-- Reduced icon size -->
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="tw-flex tw-justify-center tw-mt-4"> <!-- Reduced margin -->
                    <button type="button" id="addCompanyBtn" class="tw-inline-flex tw-items-center tw-px-6 tw-py-3 tw-border tw-border-transparent tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-white tw-bg-indigo-600 hover:tw-bg-indigo-700 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-indigo-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105"> <!-- Reduced padding -->
                        <svg class="tw-w-5 tw-h-5 tw-mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <!-- Reduced icon size -->
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Tambah Perusahaan
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="tw-flex tw-justify-end tw-gap-3 tw-pt-4"> <!-- Reduced gap and padding -->
            <button type="submit" class="tw-inline-flex tw-items-center tw-px-6 tw-py-3 tw-border tw-border-transparent tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-white tw-bg-green-600 hover:tw-bg-green-700 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-green-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105" id="submitButton"> <!-- Reduced padding -->
                <span class="submit-text">Kirim Laporan</span>
                <span class="spinner-border tw-w-5 tw-h-5 tw-ml-2 tw-border-2 tw-border-white tw-border-r-transparent tw-rounded-full tw-animate-spin d-none" role="status" aria-hidden="true"></span>
            </button>
            
            <button type="button" class="tw-inline-flex tw-items-center tw-px-6 tw-py-3 tw-border tw-border-gray-300 tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-gray-700 tw-bg-white hover:tw-bg-gray-100 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-indigo-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105" onclick="window.history.back()"> <!-- Reduced padding -->
                Batal
            </button>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<!-- Message Box Backdrop -->
<div id="messageBoxBackdrop" class="d-none"></div>

<!-- Dynamic Message Box (Pop-up) -->
<div id="dynamicMessageBox" class="d-none">
    <div id="messageBoxIcon" class="icon-container"></div>
    <p id="messageBoxContent"></p>
    <button id="messageBoxOkButton" class="ok-button d-none">Oke</button>
</div>

{% block extra_scripts %}
{# SheetJS (xlsx) library - Tetap diperlukan untuk import Excel #}
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('p2pCooperationForm');
    const submitButton = document.getElementById('submitButton');
    const submitText = submitButton.querySelector('.submit-text');
    const submitSpinner = submitButton.querySelector('.spinner-border');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const messageBoxBackdrop = document.getElementById('messageBoxBackdrop');
    const dynamicMessageBox = document.getElementById('dynamicMessageBox');
    const messageBoxContent = document.getElementById('messageBoxContent');
    const messageBoxIcon = document.getElementById('messageBoxIcon');
    const messageBoxOkButton = document.getElementById('messageBoxOkButton');

    // Tambahkan flag untuk mencegah pengiriman ganda
    let isSubmitting = false; 

    // Event listener for the "Oke" button to close the message box
    messageBoxOkButton.addEventListener('click', () => {
        dynamicMessageBox.classList.add('d-none');
        messageBoxBackdrop.classList.add('d-none');
    });

    /**
     * Displays a custom message box with a given message and type (success/error).
     * @param {string} message - The message to display.
     * @param {'success'|'error'} type - The type of message ('success' or 'error').
     */
    function showMessageBox(message, type) {
        messageBoxContent.textContent = message;
        dynamicMessageBox.classList.remove('success', 'error'); // Remove previous type classes
        messageBoxIcon.innerHTML = ''; // Clear previous icon
        messageBoxOkButton.classList.add('d-none'); // Hide OK button by default
        messageBoxBackdrop.classList.remove('d-none'); // Show backdrop

        if (type === 'success') {
            dynamicMessageBox.classList.add('success');
            messageBoxIcon.innerHTML = '&#10003;'; // Checkmark icon
            messageBoxOkButton.classList.remove('d-none'); // Show OK button for success
        } else if (type === 'error') {
            dynamicMessageBox.classList.add('error');
            messageBoxIcon.innerHTML = '&#x2716;'; // Cross mark icon
            messageBoxOkButton.classList.remove('d-none'); // Show OK button for errors (user dismisses manually)
            // For errors, it will auto-hide after 5 seconds if OK is not clicked
            setTimeout(() => {
                if (!dynamicMessageBox.classList.contains('d-none')) { // Only hide if not already hidden by manual click
                    dynamicMessageBox.classList.add('d-none');
                    messageBoxBackdrop.classList.add('d-none');
                }
            }, 5000);
        }
        dynamicMessageBox.classList.remove('d-none'); // Show the message box
    }

    const companyListContainer = document.getElementById('companyListContainer');
    const jumlahPerusahaanInput = document.getElementById('jumlah_perusahaan_kerjasama_p2p');
    const excelFileInput = document.getElementById('excelFileInput');
    const importExcelBtn = document.getElementById('importExcelBtn');
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');

    /**
     * Toggles the visibility of the custom PJP input field based on the selected dropdown value.
     * @param {HTMLSelectElement} selectElement - The select element for PJP role.
     */
    function toggleCustomPjpInput(selectElement) {
        const customInputContainer = selectElement.closest('.tw-space-y-1') ? selectElement.closest('.tw-space-y-1').querySelector('.peran-pjp-custom-input') : null;
        if (customInputContainer) {
            const customInputField = customInputContainer.querySelector('input');
            if (selectElement.value === 'Lainnya') {
                customInputContainer.style.display = 'block';
                customInputField.setAttribute('required', 'true');
            } else {
                customInputContainer.style.display = 'none';
                customInputField.removeAttribute('required');
                customInputField.value = '';
            }
        }
    }

    /**
     * Updates company item numbers, manages remove buttons visibility, and updates input IDs/names.
     * @param {boolean} updateJumlahPerusahaan - Whether to update the 'Jumlah Perusahaan' input.
     */
    function updateCompanyNumbersAndRemoveButtons(updateJumlahPerusahaan = true) {
        const items = companyListContainer.querySelectorAll('.company-item');
        items.forEach((item, index) => {
            item.querySelector('.company-number').textContent = index + 1;

            const removeBtn = item.querySelector('.remove-company-btn');
            if (removeBtn) {
                if (items.length > 1) {
                    removeBtn.style.display = 'inline-flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            }

            // Update IDs and 'for' attributes for labels and 'name' attributes for inputs
            item.querySelectorAll('input, select, textarea').forEach(input => {
                const oldId = input.id;
                const newIdx = index + 1;

                // Update ID
                if (oldId && oldId.match(/_\d+$/)) {
                    input.id = oldId.replace(/_\d+$/, '_' + newIdx);
                } else if (oldId && oldId.startsWith('peran_pjp_custom_')) {
                    input.id = `peran_pjp_custom_${newIdx}`;
                } else { // For initial elements that might not have a number
                    input.id = `${input.id.split('_')[0]}_${newIdx}`; // Ensure base name is kept
                }

                // Update name
                const oldName = input.name;
                if (oldName && oldName.match(/_\d+$/)) {
                    input.name = oldName.replace(/_\d+$/, '_' + newIdx);
                } else if (oldName && oldName.startsWith('peran_pjp_custom_')) {
                    input.name = `peran_pjp_custom_${newIdx}`;
                } else if (oldName && !oldName.match(/_\d+$/) && !oldName.endsWith('[]')) { // Ensure it's not already numbered or an array
                    input.name = `${oldName.split('_')[0]}_${newIdx}`; // Ensure base name is kept
                }
                
                const label = item.querySelector(`label[for="${oldId}"]`);
                if (label) {
                    label.setAttribute('for', input.id);
                }
            });

            const peranPjpSelect = item.querySelector('.peran-pjp-select');
            if (peranPjpSelect) {
                // Remove old listener to prevent duplicates
                const oldListener = peranPjpSelect._changeListener; // Stored listener reference
                if (oldListener) {
                    peranPjpSelect.removeEventListener('change', oldListener);
                }
                const newListener = function() { toggleCustomPjpInput(this); };
                peranPjpSelect.addEventListener('change', newListener);
                peranPjpSelect._changeListener = newListener; // Store new listener reference
                
                // Call once to ensure correct initial state
                toggleCustomPjpInput(peranPjpSelect);
            }
        });

        if (updateJumlahPerusahaan && jumlahPerusahaanInput) {
            jumlahPerusahaanInput.value = items.length;
        }
    }
    
    /**
     * Creates a new company item HTML structure and optionally populates it with data.
     * @param {number} index - The 0-based index for the new item.
     * @param {object} [data={}] - Optional data object to pre-fill fields.
     * @returns {HTMLDivElement} The new company item element.
     */
    function createCompanyItem(index, data = {}) {
        const newIdx = index + 1;
        const newItem = document.createElement('div');
        newItem.className = 'company-item tw-p-4 tw-border-2 tw-border-dashed tw-border-gray-200 tw-rounded-lg tw-bg-white tw-relative';
        newItem.innerHTML = `
            <h4 class="tw-text-base tw-font-bold tw-text-gray-800 tw-mb-3">Perusahaan Kerjasama #<span class="company-number">${newIdx}</span></h4>
            <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-x-4 tw-gap-y-2">
                <div class="tw-space-y-1">
                    <label for="nama_perusahaan_kerjasama_${newIdx}" class="tw-block form-label">Nama Perusahaan Kerjasama <span class="tw-text-red-500">*</span></label>
                    <input type="text" class="tw-mt-1 tw-block tw-w-full form-input" id="nama_perusahaan_kerjasama_${newIdx}" name="nama_perusahaan_kerjasama_${newIdx}" required value="${data['Nama Perusahaan'] || ''}">
                </div>
                <div class="tw-space-y-1">
                    <label for="peran_pjp_${newIdx}" class="tw-block form-label">Peran PJP <span class="tw-text-red-500">*</span></label>
                    <select class="tw-mt-1 tw-block tw-w-full form-input peran-pjp-select" id="peran_pjp_${newIdx}" name="peran_pjp_${newIdx}" required>
                        <option value="">-- Pilih Peran --</option>
                        <option value="Penyelenggara" ${data['Peran PJP (Dropdown)'] === 'Penyelenggara' ? 'selected' : ''}>Penyelenggara</option>
                        <option value="Mitra" ${data['Peran PJP (Dropdown)'] === 'Mitra' ? 'selected' : ''}>Mitra</option>
                        <option value="Penjamin" ${data['Peran PJP (Dropdown)'] === 'Penjamin' ? 'selected' : ''}>Penjamin</option>
                        <option value="Lainnya" ${data['Peran PJP (Dropdown)'] === 'Lainnya' ? 'selected' : ''}>Lainnya</option>
                    </select>
                    <div class="peran-pjp-custom-input tw-mt-1" style="display: none;">
                        <label for="peran_pjp_custom_${newIdx}" class="tw-sr-only">Peran PJP Kustom</label>
                        <input type="text" class="tw-block tw-w-full form-input" id="peran_pjp_custom_${newIdx}" name="peran_pjp_custom_${newIdx}" placeholder="Masukkan peran kustom" value="${data['Peran PJP Kustom (Jika Lainnya)'] || ''}">
                    </div>
                </div>
            </div>
            <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-x-4 tw-gap-y-2">
                <div class="tw-space-y-1">
                    <label for="tanggal_mulai_kerjasama_${newIdx}" class="tw-block form-label">Tanggal Mulai Kerja Sama <span class="tw-text-red-500">*</span></label>
                    <input type="date" class="tw-mt-1 tw-block tw-w-full form-input" id="tanggal_mulai_kerjasama_${newIdx}" name="tanggal_mulai_kerjasama_${newIdx}" required value="${data['Tanggal Mulai Kerjasama (YYYY-MM-DD)'] || ''}">
                </div>
                <div class="tw-space-y-1">
                    <label for="tanggal_akhir_kerjasama_${newIdx}" class="tw-block form-label">Tanggal Akhir Kerja Sama</label>
                    <input type="date" class="tw-mt-1 tw-block tw-w-full form-input" id="tanggal_akhir_kerjasama_${newIdx}" name="tanggal_akhir_kerjasama_${newIdx}" value="${data['Tanggal Akhir Kerjasama (YYYY-MM-DD)'] || ''}">
                </div>
                <div class="tw-space-y-1 md:tw-col-span-2">
                    <label for="keterangan_perusahaan_${newIdx}" class="tw-block form-label">Keterangan</label>
                    <input type="text" class="tw-mt-1 tw-block tw-w-full form-input" id="keterangan_perusahaan_${newIdx}" name="keterangan_perusahaan_${newIdx}" value="${data['Keterangan Perusahaan'] || ''}">
                </div>
            </div>
            <button type="button" class="remove-company-btn tw-absolute tw-top-2 tw-right-2 tw-text-red-600 hover:tw-text-red-800 tw-font-bold tw-p-1 tw-rounded-full tw-bg-red-100 hover:tw-bg-red-200 tw-transition-colors tw-duration-150" style="display: none;">
                <svg class="tw-w-4 tw-h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
            </button>
        `;
        
        newItem.querySelector('.remove-company-btn').addEventListener('click', function() {
            newItem.remove();
            updateCompanyNumbersAndRemoveButtons();
        });

        const peranPjpSelect = newItem.querySelector('.peran-pjp-select');
        peranPjpSelect.addEventListener('change', function() {
            toggleCustomPjpInput(this);
        });
        toggleCustomPjpInput(peranPjpSelect); // Initialize custom input visibility
        return newItem;
    }

    // Event listener for "Tambah Perusahaan" button
    document.getElementById('addCompanyBtn').addEventListener('click', function() {
        companyListContainer.appendChild(createCompanyItem(companyListContainer.children.length));
        updateCompanyNumbersAndRemoveButtons();
    });
    
    // Event listener for "Jumlah Perusahaan Kerjasama P2P" input change
    if (jumlahPerusahaanInput) {
        jumlahPerusahaanInput.addEventListener('change', function() {
            const targetCount = parseInt(this.value) || 0;
            const currentCount = companyListContainer.children.length;

            if (targetCount > currentCount) {
                for (let i = currentCount; i < targetCount; i++) {
                    companyListContainer.appendChild(createCompanyItem(i));
                }
            } else if (targetCount < currentCount) {
                for (let i = currentCount; i > targetCount; i--) {
                    if (companyListContainer.lastElementChild) {
                        companyListContainer.lastElementChild.remove();
                    }
                }
            }
            updateCompanyNumbersAndRemoveButtons();
        });
    }

    // Excel Import Logic
    importExcelBtn.addEventListener('click', function() {
        const file = excelFileInput.files[0];
        if (!file) {
            showMessageBox('Harap pilih file Excel terlebih dahulu.', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                // raw: false ensures that date cells are parsed into Date objects by SheetJS
                const workbook = XLSX.read(data, { type: 'array', cellDates: true, raw: false });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Use header: 1 to get an array of arrays, with the first array being headers
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

                if (jsonData.length < 2) { // Minimum 2 rows: header + at least one data row
                    showMessageBox('File Excel kosong atau hanya berisi header.', 'error');
                    return;
                }

                const headers = jsonData[0].map(h => String(h).trim()); // Trim headers
                const companyDataRows = jsonData.slice(1);

                const expectedExcelHeaders = [
                    'Nama Perusahaan',
                    'Peran PJP (Dropdown)',
                    'Peran PJP Kustom (Jika Lainnya)',
                    'Tanggal Mulai Kerjasama (YYYY-MM-DD)',
                    'Tanggal Akhir Kerjasama (YYYY-MM-DD)',
                    'Keterangan Perusahaan'
                ];

                const headerMap = {};
                let isValidHeaderSet = true;
                expectedExcelHeaders.forEach(expectedH => {
                    const actualFoundHeader = headers.find(h => h === expectedH);
                    if (actualFoundHeader) {
                        headerMap[expectedH] = actualFoundHeader;
                    } else {
                        isValidHeaderSet = false;
                    }
                });

                if (!isValidHeaderSet) {
                    showMessageBox('File Excel tidak memiliki semua kolom header yang diperlukan sesuai template. Harap gunakan template yang diunduh atau periksa format header.', 'error');
                    return;
                }

                companyListContainer.innerHTML = ''; // Clear existing items
                
                let validImportedCompanies = 0;

                companyDataRows.forEach((row, index) => {
                    // Skip empty rows (rows where all cells are empty or just whitespace)
                    if (row.filter(cell => cell !== undefined && cell !== null && String(cell).trim() !== '').length === 0) {
                        return;
                    }

                    const companyRawData = {};
                    expectedExcelHeaders.forEach(expectedH => {
                        const actualColHeader = headerMap[expectedH];
                        const colIndex = headers.indexOf(actualColHeader);
                        if (colIndex !== -1) {
                            companyRawData[expectedH] = row[colIndex];
                        }
                    });

                    // Basic validation for required fields
                    if (!companyRawData['Nama Perusahaan'] ||
                        !companyRawData['Peran PJP (Dropdown)'] ||
                        !companyRawData['Tanggal Mulai Kerjasama (YYYY-MM-DD)']) {
                        console.warn(`Baris ${index + 2} di Excel diabaikan karena data wajib tidak lengkap.`);
                        return;
                    }

                    // Function to convert Excel date values to YYYY-MM-DD string
                    const convertExcelDate = (excelDate) => {
                        if (excelDate instanceof Date) { // If SheetJS already converted it to Date object
                            return excelDate.toISOString().split('T')[0];
                        }
                        if (typeof excelDate === 'string' && excelDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            return excelDate; // Already in YYYY-MM-DD format
                        }
                        // Handle numeric Excel dates (days since 1899-12-30)
                        if (typeof excelDate === 'number' && !isNaN(excelDate)) {
                            // Excel's epoch is 1899-12-30. JS epoch is 1970-01-01.
                            // 25569 is the number of days between the two epochs.
                            const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
                            if (!isNaN(date.getTime())) { // Check for valid date
                                return date.toISOString().split('T')[0];
                            }
                        }
                        console.warn(`Invalid or unparsable date format for cell data:`, excelDate);
                        return '';
                    };

                    const namaPerusahaan = String(companyRawData['Nama Perusahaan'] || '').trim();
                    const peranPjp = String(companyRawData['Peran PJP (Dropdown)'] || '').trim();
                    const peranPjpKustom = String(companyRawData['Peran PJP Kustom (Jika Lainnya)'] || '').trim();
                    const tanggalMulai = convertExcelDate(companyRawData['Tanggal Mulai Kerjasama (YYYY-MM-DD)']);
                    const tanggalAkhir = convertExcelDate(companyRawData['Tanggal Akhir Kerjasama (YYYY-MM-DD)']);
                    const keteranganPerusahaan = String(companyRawData['Keterangan Perusahaan'] || '').trim();

                    const formattedCompanyData = {
                        'Nama Perusahaan': namaPerusahaan,
                        'Peran PJP (Dropdown)': peranPjp, // Use the dropdown value for selection
                        'Peran PJP Kustom (Jika Lainnya)': peranPjpKustom, // Use for custom input
                        'Tanggal Mulai Kerjasama (YYYY-MM-DD)': tanggalMulai,
                        'Tanggal Akhir Kerjasama (YYYY-MM-DD)': tanggalAkhir,
                        'Keterangan Perusahaan': keteranganPerusahaan
                    };

                    companyListContainer.appendChild(createCompanyItem(validImportedCompanies, formattedCompanyData));
                    validImportedCompanies++;
                });

                if (validImportedCompanies > 0) {
                    jumlahPerusahaanInput.value = validImportedCompanies;
                    updateCompanyNumbersAndRemoveButtons(false); // Don't update jumlahPerusahaanInput again
                    showMessageBox(`${validImportedCompanies} perusahaan berhasil diimpor dari Excel.`, 'success');
                } else {
                    showMessageBox('Tidak ada data perusahaan yang valid ditemukan dalam file Excel. Pastikan data tidak kosong dan format header sesuai.', 'error');
                    // Re-add a default empty item if all imported data was invalid
                    if (companyListContainer.children.length === 0) {
                        companyListContainer.appendChild(createCompanyItem(0));
                        jumlahPerusahaanInput.value = 1;
                    }
                    updateCompanyNumbersAndRemoveButtons();
                }

            } catch (error) {
                console.error('Error reading Excel file:', error);
                showMessageBox(`Terjadi kesalahan saat membaca file Excel: ${error.message}. Pastikan format file benar dan tidak rusak.`, 'error');
            } finally {
                excelFileInput.value = ''; // Clear the file input after processing
            }
        };
        reader.onerror = function(errorEvent) {
            console.error('FileReader error:', errorEvent);
            showMessageBox(`Gagal membaca file: ${errorEvent.target.error.message || 'Unknown error'}.`, 'error');
            excelFileInput.value = ''; // Clear the file input on error
        };
        reader.readAsArrayBuffer(file);
    });

    // Download Excel Template Logic
    downloadTemplateBtn.addEventListener('click', function() {
        const csvHeaders = [
            'Nama Perusahaan',
            'Peran PJP (Dropdown)',
            'Peran PJP Kustom (Jika Lainnya)',
            'Tanggal Mulai Kerjasama (YYYY-MM-DD)',
            'Tanggal Akhir Kerjasama (YYYY-MM-DD)',
            'Keterangan Perusahaan'
        ];
        const csvContent = csvHeaders.join(',') + "\n";
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "Template_Daftar_Perusahaan_P2P.csv";
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showMessageBox('Template CSV telah diunduh. Harap diperhatikan bahwa file CSV tidak mendukung fitur dropdown atau date picker di dalamnya.', 'success');
    });

    // Ensure remove buttons are visible if there's more than 1 company on page load
    updateCompanyNumbersAndRemoveButtons();

    // Set max date for 'tanggal_surat' to today
    const tanggalSuratInput = document.getElementById('tanggal_surat');
    if(tanggalSuratInput){
        const today = new Date().toISOString().split('T')[0];
        tanggalSuratInput.max = today;
    }
    
    // Form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission

        // Periksa apakah formulir sedang dalam proses pengiriman
        if (isSubmitting) {
            console.log("Pengiriman formulir sudah berjalan. Mengabaikan.");
            return;
        }

        let formIsValid = true;
        
        // Validate 'tahun_laporan'
        const tahun = document.getElementById('tahun_laporan').value;
        const currentYear = new Date().getFullYear();
        if (parseInt(tahun) > currentYear + 1 || parseInt(tahun) < currentYear - 1 ) {
            showMessageBox('Tahun laporan harus tahun sekarang, tahun sebelumnya, atau tahun berikutnya.', 'error');
            formIsValid = false;
        }
        
        // Validate file size
        const fileInput = document.getElementById('file');
        if (fileInput.files[0] && fileInput.files[0].size > 5 * 1024 * 1024) { // 5MB limit
            showMessageBox('Ukuran file lampiran melebihi 5MB.', 'error');
            formIsValid = false;
        }
        
        // Validate consistency between declared and actual company count
        const companyCountDeclared = parseInt(jumlahPerusahaanInput.value) || 0;
        const actualCompanyCount = companyListContainer.children.length;

        if (companyCountDeclared !== actualCompanyCount) {
            showMessageBox('Jumlah perusahaan yang dideklarasikan tidak sesuai dengan detail yang diinput. Harap periksa kembali jumlah atau detail perusahaan.', 'error');
            formIsValid = false;
        }
        if (actualCompanyCount === 0 && companyCountDeclared > 0) {
            showMessageBox('Harap tambahkan detail perusahaan kerjasama sesuai jumlah yang dideklarasikan.', 'error');
            formIsValid = false;
        }

        const companyItems = companyListContainer.querySelectorAll('.company-item');
        const perusahaanDataArray = [];

        companyItems.forEach((item, index) => {
            // Get inputs by their updated 'name' attributes
            const namaPerusahaanInput = item.querySelector(`input[name="nama_perusahaan_kerjasama_${index+1}"]`);
            const peranPjpSelect = item.querySelector(`select[name="peran_pjp_${index+1}"]`);
            const peranPjpCustomInput = item.querySelector(`input[name="peran_pjp_custom_${index+1}"]`);
            const tanggalMulaiInput = item.querySelector(`input[name="tanggal_mulai_kerjasama_${index+1}"]`);
            const tanggalAkhirInput = item.querySelector(`input[name="tanggal_akhir_kerjasama_${index+1}"]`);
            const keteranganPerusahaanInput = item.querySelector(`input[name="keterangan_perusahaan_${index+1}"]`);

            // Client-side validation for each company item
            if (!namaPerusahaanInput.value.trim()) {
                showMessageBox(`Nama Perusahaan Kerjasama untuk perusahaan #${index + 1} tidak boleh kosong.`, 'error');
                formIsValid = false;
            }
            if (!peranPjpSelect.value) {
                showMessageBox(`Peran PJP untuk perusahaan #${index + 1} tidak boleh kosong.`, 'error');
                formIsValid = false;
            }
            let peranPjpValue = peranPjpSelect.value;
            if (peranPjpSelect.value === 'Lainnya') {
                if (!peranPjpCustomInput || !peranPjpCustomInput.value.trim()) {
                    showMessageBox(`Peran PJP kustom untuk perusahaan #${index + 1} tidak boleh kosong.`, 'error');
                    formIsValid = false;
                } else {
                    peranPjpValue = peranPjpCustomInput.value.trim();
                }
            }
            if (!tanggalMulaiInput.value) {
                showMessageBox(`Tanggal Mulai Kerja Sama untuk perusahaan #${index + 1} tidak boleh kosong.`, 'error');
                formIsValid = false;
            }

            perusahaanDataArray.push({
                "nama_perusahaan_kerjasama": namaPerusahaanInput.value.trim(),
                "peran_pjp": peranPjpValue,
                "tanggal_mulai_kerjasama": tanggalMulaiInput.value, // YYYY-MM-DD format
                "tanggal_akhir_kerjasama": tanggalAkhirInput.value || null, // Send null if empty
                "keterangan": keteranganPerusahaanInput.value.trim() || null // Send null if empty
            });
        });
        
        if (!formIsValid) {
            console.log("Form tidak valid, pengiriman dibatalkan.");
            // Ensure loading state is reset if client-side validation fails
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            loadingOverlay.classList.add('d-none'); // Ensure overlay is hidden
            return;
        }

        // Set flag to true when submission starts
        isSubmitting = true; 

        // Disable submit button, show loading text and spinner, and show global loading overlay
        submitButton.disabled = true;
        submitText.textContent = 'Mengirim...';
        submitSpinner.classList.remove('d-none');
        loadingOverlay.classList.remove('d-none'); // Show global loading overlay

        // --- Prepare all form data, including the stringified company details ---
        const formDataToSend = new FormData();
        formDataToSend.append('tahun_laporan', document.getElementById('tahun_laporan').value);
        formDataToSend.append('periode_laporan', document.getElementById('periode_laporan').value);
        formDataToSend.append('nomor_surat', document.getElementById('nomor_surat').value);
        formDataToSend.append('tanggal_surat', document.getElementById('tanggal_surat').value); // YYYY-MM-DD
        formDataToSend.append('jumlah_perusahaan_kerjasama_p2p', document.getElementById('jumlah_perusahaan_kerjasama_p2p').value);
        
        const file = fileInput.files[0];
        if (file) {
            formDataToSend.append('file', file);
        }

        // Add the stringified company data to the FormData object
        formDataToSend.append('perusahaan_data_json', JSON.stringify(perusahaanDataArray));

        // Submit all data to the single Flask endpoint
        fetch(form.action, {
            method: 'POST',
            body: formDataToSend,
            headers: {
                'Accept': 'application/json' // Expect JSON response
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || JSON.stringify(errorData) || 'Gagal mengirim laporan (status non-2xx)');
                }).catch(jsonError => {
                    console.error("Error parsing JSON from non-OK response:", jsonError);
                    return response.text().then(text => {
                        throw new Error(`Gagal mengirim laporan. Server response: ${text.substring(0, 100)}...`);
                    });
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showMessageBox(data.message || 'Laporan Kerjasama P2P berhasil dikirim!', 'success');
                form.reset();
                // Reset company list back to one default item
                companyListContainer.innerHTML = '';
                companyListContainer.appendChild(createCompanyItem(0));
                updateCompanyNumbersAndRemoveButtons();
            } else {
                // If backend indicates failure, show error message
                throw new Error(data.message || 'Gagal mengirim laporan.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessageBox(error.message || 'Terjadi kesalahan jaringan atau server.', 'error');
        })
        .finally(() => {
            // Ensure loading state is always reset
            submitButton.disabled = false;
            submitText.textContent = 'Kirim Laporan';
            submitSpinner.classList.add('d-none');
            loadingOverlay.classList.add('d-none');
            isSubmitting = false; // Reset flag when submission finishes
        });
    });

    // Form reset logic: reverts company list to one default item
    form.addEventListener('reset', function() {
        while (companyListContainer.children.length > 1) {
            companyListContainer.lastElementChild.remove();
        }
        const firstItem = companyListContainer.querySelector('.company-item');
        if (firstItem) {
            firstItem.querySelector('.peran-pjp-select').value = '';
            toggleCustomPjpInput(firstItem.querySelector('.peran-pjp-select'));
            // Reset specific input values on the first item
            firstItem.querySelector('input[name="nama_perusahaan_kerjasama_1"]').value = '';
            firstItem.querySelector('input[name="tanggal_mulai_kerjasama_1"]').value = '';
            firstItem.querySelector('input[name="tanggal_akhir_kerjasama_1"]').value = '';
            firstItem.querySelector('input[name="keterangan_perusahaan_1"]').value = '';
        }
        jumlahPerusahaanInput.value = 1;
        updateCompanyNumbersAndRemoveButtons();
    });

    // Initialization: If initial company count is > 1, add corresponding items
    if (parseInt(jumlahPerusahaanInput.value) > 1 && companyListContainer.children.length === 1) {
        const initialCount = parseInt(jumlahPerusahaanInput.value);
        for (let i = 1; i < initialCount; i++) {
            companyListContainer.appendChild(createCompanyItem(i));
        }
    }
    // Ensure numbering and remove buttons are updated on page load
    updateCompanyNumbersAndRemoveButtons();
});
</script>

{% endblock %}
{% endblock %}
