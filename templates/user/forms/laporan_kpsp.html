{% extends "user/base.html" %}

{% block title %}Form Perhitungan KPSP v.1.0{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Menggunakan url_for untuk aset CSS -->
    <link href="{{ url_for('static', filename='assets/dist/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='assets/dist/css/offcanvas-navbar.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='assets/css/select2.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='assets/css/select2-bootstrap-5-theme.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='assets/css/jquery-ui.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='assets/css/sweetalert2.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='assets/dist/css/custom.css') }}" rel="stylesheet">
    <style>
        /* Gaya tambahan untuk menyesuaikan tampilan form */
        body {
            padding-top: 0; /* Pastikan tidak ada padding ganda jika base.html sudah mengaturnya */
            background-color: #f8f9fa; /* Warna latar belakang */
        }
        .bg-purple {
            background-color: #6f42c1 !important;
        }
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            background-color: #ffffff;
        }
        .form-section-title {
            color: #6f42c1;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .card-header {
            font-weight: bold;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #eee;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        /* Tambahan styling untuk status pemenuhan */
        .bg-success-custom {
            background-color: #28a745 !important;
            color: white !important;
        }
        .bg-danger-custom {
            background-color: #dc3545 !important;
            color: white !important;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-3">
        <div class="row justify-content-center">
            <!-- Isi utama form akan berada di sini, dalam kolom setelah sidebar dari base.html -->
            <div class="col-lg-10 col-md-12">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2 text-dark">Form Perhitungan KPSP v.1.0</h1>
                </div>

                <!-- Card untuk Form Utama KPSP -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-purple text-white">
                        Informasi Umum dan Data Keuangan
                    </div>
                    <div class="card-body">
                        <form id="kpspForm">
                            <div class="form-section">
                                <h5 class="form-section-title">Informasi Umum</h5>
                                <div class="row mb-3">
                                    <div class="col-3 text-end">
                                        Posisi
                                    </div>
                                    <div class="col-4">
                                    <input type="date" class="form-control form-control-lg" id="posisilaporan" name="Posisi Tanggal Laporan">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-3 text-end">
                                        Nama Pelapor
                                    </div>
                                    <div class="col-4">
                                        <input type="text" class="form-control" id="nama_pelapor" onchange="refreshAktivitas()">
                                    </div>
                                </div>
                            </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">Pemenuhan Initial Capital</h5>
                                <div class="mb-3 row align-items-center">
                                    <label for="jumlahModalDisetor" class="col-sm-8 col-form-label">Jumlah Modal Disetor <span class="badge bg-primary">Diisi sesuai laporan keuangan audited</span></label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="jumlahModalDisetor" name="jumlahModalDisetor" value="0">
                                    </div>
                                </div>
                                <small class="d-block text-end mb-3 text-muted">
                                    Initial Capital merujuk pada modal disetor yang tertera dalam akta perusahaan
                                </small>
                                <div class="mb-3 row align-items-center">
                                    <label class="col-sm-8 col-form-label">Jumlah Kewajiban Initial Capital</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="kewajibanInitCapital" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label class="col-sm-8 col-form-label">Status Pemenuhan Initial Capital</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control text-center fw-bold" id="statusPemenuhan_initialCapital" name="statusPemenuhanInitialCapitalDisplay" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label class="col-sm-8 col-form-label">Total Kebutuhan Tambahan Initial Capital</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="tambahanInitCapital" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="" id="flagGL_PIPasing">
                                            <label class="form-check-label" for="flagGL_PIPasing">
                                                Memiliki guarantee letter dari parent company (khusus PIP Asing)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">Perhitungan Ongoing Capital</h5>
                                <h6 class="border-bottom pb-2 mb-3">Penetapan Transaksi Tertimbang Menurut Risiko (TTMR) <span class="badge bg-primary">Transaksi yang diproses selama tahun buku laporan</span></h6>
                                <div class="mb-3 row align-items-center">
                                    <label for="jumlahBulanTrx" class="col-sm-4 col-form-label">Jumlah Bulan Transaksi</label>
                                    <div class="col-sm-3">
                                        <input type="number" class="form-control" id="jumlahBulanTrx" name="jumlahBulanTrx" min="1" max="12" value="12">
                                    </div>
                                    <div class="col-sm-5 text-danger small">(Range 1 s.d. 12)</div>
                                </div>

                                <div class="row mb-3 fw-bold">
                                    <div class="col-sm-4"></div>
                                    <div class="col-sm-4 text-center">Transaksi selama tahun buku laporan</div>
                                    <div class="col-sm-4 text-center">Rata-rata Transaksi/Bulan</div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="totalTrx_ATMDebet" class="col-sm-4 col-form-label">Total Transaksi menggunakan Kartu ATM/Debet*)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalTrx_ATMDebet" name="totalTrx_ATMDebet" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalTrx_ATMDebet_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="totalTrx_KK" class="col-sm-4 col-form-label">Total Transaksi menggunakan Transaksi Kartu Kredit*)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalTrx_KK" name="totalTrx_KK" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalTrx_KK_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="trxDompel" class="col-sm-4 col-form-label">Transaksi Dompet Elektronik</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxDompel" name="trxDompel" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxDompel_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="trxTrfDanaLN_inc" class="col-sm-4 col-form-label">Transaksi Transfer Dana LN - Incoming</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxTrfDanaLN_inc" name="trxTrfDanaLN_inc" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxTrfDanaLN_inc_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="trxTrfDanaLN_out" class="col-sm-4 col-form-label">Transaksi Transfer Dana LN - Outgoing</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxTrfDanaLN_out" name="trxTrfDanaLN_out" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxTrfDanaLN_out_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="trxTrfDana_dom" class="col-sm-4 col-form-label">Transaksi Transfer Dana - Domestik</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxTrfDana_dom" name="trxTrfDana_dom" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxTrfDana_dom_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="trxUE" class="col-sm-4 col-form-label">Transaksi Uang Elektronik**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxUE" name="trxUE" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxUE_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="trxPIAS_fasil" class="col-sm-4 col-form-label">Transaksi PIAS - Fasilitator***)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxPIAS_fasil" name="trxPIAS_fasil" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxPIAS_fasil_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="trxPIAS_merchAgg" class="col-sm-4 col-form-label">Transaksi PIAS - Merchant Agregator</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxPIAS_merchAgg" name="trxPIAS_merchAgg" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxPIAS_merchAgg_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="trxLainnya" class="col-sm-4 col-form-label">Transaksi lainnya (a.l. Biller Aggregator)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxLainnya" name="trxLainnya" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="trxLainnya_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-4 col-form-label text-end">Total Nilai Transaksi</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalNilaiTrx" name="totalNilaiTrx" readonly>
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalNilaiTrx_rata" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Beban Transaksi</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="bebanTrx" name="bebanTrx" readonly>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-12 text-danger small">
                                        *) Untuk PIP hanya memperhitungkan transaksi off us<br>
                                        **) meliputi transaksi outgoing berupa transaksi belanja, transfer & reedeem<br>
                                        ***) Nilai Transaksi PIAS - Fasilitator dihitung 10%
                                    </div>
                                </div>

                                <div class="row mb-3 fw-bold">
                                    <div class="col-sm-4"></div>
                                    <div class="col-sm-4 text-center">Transaksi selama tahun buku laporan</div>
                                    <div class="col-sm-4 text-center">Rata-rata Transaksi/Bulan</div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="danaFloat" class="col-sm-4 col-form-label">Dana Float****)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="danaFloat" name="danaFloat" value="0">
                                    </div>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="danaFloat_rata" readonly>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-12 text-danger small">
                                        ****) khusus AIS yang menyelenggarakan Uang Elektronik
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">% Beban Transaksi Dana Float</label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <input type="text" class="form-control text-center" id="percBebanTrxDanaFloat" name="percBebanTrxDanaFloat" readonly>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Beban Transaksi Dana Float</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="bebanTrxDanaFloat" name="bebanTrxDanaFloat" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Total Beban (Beban Transaksi Progresif + Beban Dana Float)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalBeban" name="totalBeban" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Konstanta TTMR</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control text-center" id="konstantaTTMR" name="konstantaTTMR" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">TTMR (Konstanta TTMR x Total Beban)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="TTMR" name="TTMR" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">Komponen Perhitungan Ongoing Capital</h5>
                                <div class="text-center text-danger small mb-3">
                                    Modal disetor = modal saham (nilai nominal saham) + uang muka setoran modal + agio/disagio saham
                                </div>
                                <div class="row mb-3 fw-bold">
                                    <div class="col-sm-8"></div>
                                    <div class="col-sm-4 text-center">Nominal</div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="modalSaham" class="col-sm-8 col-form-label">Modal Saham</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalSaham" name="modalSaham" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="uangMukaSetoranModal" class="col-sm-8 col-form-label">Uang Muka Setoran Modal*)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="uangMukaSetoranModal" name="uangMukaSetoranModal" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="agioDisagioSaham" class="col-sm-8 col-form-label">Agio Saham/Disagio Saham*) - <i class="text-danger small">diisi negatif jika disagio</i></label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="agioDisagioSaham" name="agioDisagioSaham" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="saldoLRberjalan" class="col-sm-8 col-form-label">Saldo Laba/Rugi berjalan, termasuk akumulasi laba/rugi tahun sebelumnya - <i class="text-danger small">diisi negatif jika rugi</i></label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="saldoLRberjalan" name="saldoLRberjalan" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="saldoPenghasilanKompr" class="col-sm-8 col-form-label">Saldo penghasilan komprehensif lain - <i class="text-danger small">diisi negatif jika rugi</i></label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="saldoPenghasilanKompr" name="saldoPenghasilanKompr" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Modal Inti Utama</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalIntiUtama" name="modalIntiUtama" readonly>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-12 text-danger small">
                                        *) Pada sebagian format laporan keuangan ditulis sebagai komponen tambahan modal disetor
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="asetPajakTangguhan" class="col-sm-8 col-form-label">Aset pajak tangguhan (deferred tax asset)**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="asetPajakTangguhan" name="asetPajakTangguhan" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="goodWill" class="col-sm-8 col-form-label">Goodwill**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="goodWill" name="goodWill" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="asetTidakBerwujud" class="col-sm-8 col-form-label">Asset tidak berwujud (intangible asset)**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="asetTidakBerwujud" name="asetTidakBerwujud" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="seluruhPenyertaan" class="col-sm-8 col-form-label">Seluruh penyertaan dengan kepemilikan lebih dari 5% atau lebih**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="seluruhPenyertaan" name="seluruhPenyertaan" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="pembelianKembaliInstModal" class="col-sm-8 col-form-label">Pembelian kembali instrumen modal yang telah diakui sebagai komponen permodalan PJP/PIP**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="pembelianKembaliInstModal" name="pembelianKembaliInstModal" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="penempatanDanaInstUtang" class="col-sm-8 col-form-label">Penempatan dana pada instrumen utang pada entitas lainnya yang diakui sebagai komponen modal oleh entitas penerbit **)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="penempatanDanaInstUtang" name="penempatanDanaInstUtang" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Faktor Pengurang Modal Inti Utama</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="faktorPengurangModalInti" name="faktorPengurangModalInti" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Modal Inti Utama (Setelah dikurangi Faktor Pengurang)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalIntiUtama_setelahFPR" name="modalIntiUtama_setelahFPR" readonly>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-12 text-danger small">
                                        **) Faktor pengurang diisi dengan nilai positif
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="instrumenUtang" class="col-sm-8 col-form-label">Instrumen utang, baik berupa surat utang (debt securities) dan pinjaman yang bersifat subordinasi, yang tidak memiliki jangka waktu, dan pembayaran imbal hasil tidak dapat diakumulasikan</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="instrumenUtang" name="instrumenUtang" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="instrumenHybrid" class="col-sm-8 col-form-label">Instrumen hybrid yang tidak memiliki jangka waktu dan pembayaran imbal hasil tidak dapat diakumulasikan</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="instrumenHybrid" name="instrumenHybrid" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="sahamPreferenNonKumulatif" class="col-sm-8 col-form-label">Saham preferen non kumulatif baik dengan atau tanpa fitur opsi beli</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="sahamPreferenNonKumulatif" name="sahamPreferenNonKumulatif" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="premiumDiskonto" class="col-sm-8 col-form-label">Premium/diskonto yang berasal dari penerbitan instrumen yang tergolong sebagai modal inti tambahan</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="premiumDiskonto" name="premiumDiskonto" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Modal Inti Tambahan</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalIntiTambahan" name="modalIntiTambahan" readonly>
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="instrumenModalIntiTambahan" class="col-sm-8 col-form-label">Instrumen Modal Inti Tambahan yang dimiliki sendiri (akibat kewajiban kontraktual)**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="instrumenModalIntiTambahan" name="instrumenModalIntiTambahan" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="kepemilikanModalIntiTambahan" class="col-sm-8 col-form-label">Kepemilikan Modal Inti Tambahan oleh pihak lain yang terindikasi merupakan skema kepemilikan silang (crossholding)**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="kepemilikanModalIntiTambahan" name="kepemilikanModalIntiTambahan" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Faktor Pengurang Modal Inti Tambahan</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="faktorPengurangModalIntiTambahan" name="faktorPengurangModalIntiTambahan" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Modal Inti Tambahan (Setelah dikurangi Faktor Pengurang)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalIntiTambahan_setelahFPR" name="modalIntiTambahan_setelahFPR" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Modal Inti Tambahan yang dapat diperhitungkan sebagai Ongoing Capital<br><b class="text-danger small">(max 1/3 modal inti utama)</b></label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalIntiTambahan_ongoingCapital" name="modalIntiTambahan_ongoingCapital" readonly>
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="instrumenUtangJangkaPjg" class="col-sm-8 col-form-label">Instrumen utang jangka panjang, baik berupa surat utang (debt securities) dan pinjaman yang bersifat subordinasi dengan maturitas â‰¥ 5thn</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="instrumenUtangJangkaPjg" name="instrumenUtangJangkaPjg" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="premiumDiskontoModalPelengkap" class="col-sm-8 col-form-label">Premium/diskonto yang berasal dari penerbitan instrumen yang tergolong sebagai modal pelengkap</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="premiumDiskontoModalPelengkap" name="premiumDiskontoModalPelengkap" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Modal Pelengkap</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalPelengkap" name="modalPelengkap" readonly>
                                    </div>
                                </div>

                                <div class="mb-3 row align-items-center">
                                    <label for="instrumenModalPelengkap" class="col-sm-8 col-form-label">Instrumen Modal Pelengkap yang dimiliki sendiri (akibat kewajiban kontraktual)**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="instrumenModalPelengkap" name="instrumenModalPelengkap" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center">
                                    <label for="kepemilikanModalPelengkap" class="col-sm-8 col-form-label">Kepemilikan Modal Pelengkap oleh pihak lain yang terindikasi merupakan skema kepemilikan silang (cross holding)**)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="kepemilikanModalPelengkap" name="kepemilikanModalPelengkap" value="0">
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Faktor Pengurang Modal Pelengkap</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="faktorPengurangModalPelengkap" name="faktorPengurangModalPelengkap" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Modal Pelengkap (Setelah dikurangi Faktor Pengurang)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalPelengkap_setelahFPR" name="modalPelengkap_setelahFPR" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Modal Pelengkap yang dapat diperhitungkan sebagai Ongoing Capital<br><b class="text-danger small">(max 1/3 Modal Inti Tambahan yang dapat diperhitungkan sebagai ongoing capital)</b></label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="modalPelengkap_ongoingCapital" name="modalPelengkap_ongoingCapital" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Total Ongoing Capital</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalOngoingCapital" name="totalOngoingCapital" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Rasio KPSP (Ongoing Capital/TTMR)</label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <input type="text" class="form-control text-center" id="rasioKPSP" name="rasioKPSP" readonly>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5 class="form-section-title">Kewajiban Ongoing Capital</h5>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">KPSP Dasar</label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <input type="text" class="form-control text-center" id="KPSPdasar" name="KPSPdasar" readonly>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Surcharge Berdasarkan Klasifikasi PJP/PIP</label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <input type="text" class="form-control text-center" id="surcharge" name="surcharge" readonly>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Total KPSP</label>
                                    <div class="col-sm-4">
                                        <div class="input-group">
                                            <input type="text" class="form-control text-center" id="totalKPSP" name="totalKPSP" readonly>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Jumlah Kewajiban Ongoing Capital (KPSP x TTMR)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="jumlahKewajibanOngoingCapital" name="jumlahKewajibanOngoingCapital" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Status Pemenuhan Ongoing Capital</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control text-center fw-bold" id="statusPemenuhanOngoingCapital" name="statusPemenuhanOngoingCapitalDisplay" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row align-items-center fw-bold">
                                    <label class="col-sm-8 col-form-label text-end">Total Kebutuhan Tambahan Ongoing Capital</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control money" id="totalKebutuhanTambahanOngoingCapital" name="totalKebutuhanTambahanOngoingCapital" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i data-feather="send" class="align-text-bottom"></i> Hitung KPSP
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Card untuk menampilkan hasil perhitungan KPSP -->
                <div class="card mb-3 shadow-sm" id="kpsp_results_card" style="display: none;">
                    <div class="card-header bg-purple text-white">
                        Ringkasan Hasil Perhitungan KPSP
                    </div>
                    <div class="card-body">
                        <div id="kpsp_results">
                            <!-- Hasil perhitungan akan ditampilkan di sini secara dinamis oleh JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="text-center text-muted small py-3">
                    Departemen Surveilans Sistem Keuangan &middot; &copy; 2023
                </div>

            </div>
        </div>
    </div>

    <!-- JavaScript Dependencies (menggunakan url_for) -->
    <script src="{{ url_for('static', filename='assets/js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/dist/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/color-modes.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/select2.full.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/jquery-ui.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/sweetalert2.all.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/jquery.csv.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/jquery.maskMoney.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/core.js') }}"></script>
    <!-- Feather Icons (gunakan dari CDN atau lokal jika sudah diunduh) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <script>
        // Inisialisasi Feather Icons
        feather.replace();

        // Data PJP/PIP (diisi dari Flask menggunakan Jinja2)
const banksData = JSON.parse('{{ banks | tojson | safe if banks is not none else "[]" }}');

        // Konstanta perhitungan (diambil dari modal asumsi perhitungan)
        // Pastikan nilai-nilai ini akurat sesuai rumus KPSP Anda
        const PARAMS = {
            initialCapital: {
                PIP: 100000000000,
                AIS: 15000000000,
                PIAS: 5000000000,
                REM1: 1000000000,
                REM2: 500000000
            },
            kpspObligation: {
                PIP_PSPS: { dasar: 10.00, surcharge: 5.00, total: 15.00 },
                PSPS:     { dasar: 10.00, surcharge: 2.50, total: 12.50 },
                PSPK:     { dasar: 10.00, surcharge: 1.50, total: 11.50 },
                PSPU:     { dasar: 10.00, surcharge: 0.00, total: 10.00 }
            },
            otherParams: {
                rateBand4Perc: 100000000000, // 100 Miliar
                rateBand1Perc: 1000000000000, // 1 Triliun
                rateBand01PercAbove: 1000000000000, // 1 Triliun
                rateKI3: 0.10, // 0.10%
                bebanDanaFloat: 5.00, // 5.00%
                konstantaTTMR: 10,
                konstantaTTMR_KI3: 10 // Jika ada perbedaan untuk KI3
            }
        };


        $(document).ready(function() {
            // Inisialisasi Select2 untuk dropdown PJP
            const $namaPjpSelect = $('#nama_pjp');
            banksData.forEach(bank => {
                $namaPjpSelect.append(new Option(bank.nama, bank.nama));
            });
            $namaPjpSelect.select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Pilih PJP'
            });

            // Inisialisasi Datepicker
            $('.datepicker').datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                showButtonPanel: true
            });

            // Inisialisasi MaskMoney
            $('.money').maskMoney({
                prefix: 'Rp ',
                thousands: '.',
                decimal: ',',
                allowZero: true,
                affixesStay: false
            });

            // --- Event Listeners untuk Perhitungan Realtime ---
            // Trigger recalculation on any input change within the form
            $('#kpspForm input, #kpspForm select').on('change keyup', function() {
                updateAllCalculations();
            });

            // Populate PJP details when selected
            $namaPjpSelect.on('change', function() {
                const selectedPJPName = $(this).val();
                const selectedBank = banksData.find(bank => bank.nama === selectedPJPName);

                if (selectedBank) {
                    // Update fields from selected bank data
                    // Kategori Izin, No. Izin, Tgl. Izin sekarang diisi otomatis
                    $('#kategori_izin').val(selectedBank.kategori); // Ini akan digunakan untuk logika perhitungan
                    $('#no_izin').val(selectedBank.no_izin);
                    $('#tgl_izin').val(selectedBank.tgl_izin);
                    // Update Flag PIP Asing checkbox berdasarkan data bank
                    $('#flagGL_PIPasing').prop('checked', selectedBank.flag_pip_asing || false);
                } else {
                    // Clear fields if no PJP is selected
                    $('#kategori_izin').val('');
                    $('#no_izin').val('');
                    $('#tgl_izin').val('');
                    $('#flagGL_PIPasing').prop('checked', false);
                }
                updateAllCalculations(); // Recalculate when PJP changes
            });

            // Handle form submission (untuk menampilkan hasil dan mengirim ke backend)
            $('#kpspForm').on('submit', function(e) {
                e.preventDefault();
                
                const formData = {};
                $(this).serializeArray().forEach(item => {
                    formData[item.name] = item.value;
                });

                // Ambil nilai yang dihitung dari readonly fields
                formData['totalOngoingCapitalDisplay'] = $('#totalOngoingCapital').val();
                formData['rasioKPSPDisplay'] = $('#rasioKPSP').val();
                formData['statusPemenuhanInitialCapitalDisplay'] = $('#statusPemenuhan_initialCapital').val();
                formData['statusPemenuhanOngoingCapitalDisplay'] = $('#statusPemenuhanOngoingCapital').val();
                
                // Tampilkan SweetAlert loading
                Swal.fire({
                    title: 'Memproses...',
                    text: 'Sedang menghitung dan menyimpan laporan KPSP.',
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    allowOutsideClick: false
                });

                $.ajax({
                    url: "{{ url_for('submit_laporan_kpsp') }}", // Endpoint Flask yang baru
                    type: "POST",
                    data: formData, // Kirim semua data form, termasuk calculated values
                    success: function(response) {
                        Swal.close();
                        if (response.success) {
                            Swal.fire('Berhasil!', response.message, 'success');
                            // Tampilkan ringkasan hasil yang sudah dihitung di frontend
                            displayFinalResults();
                        } else {
                            Swal.fire('Error!', response.message, 'error');
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        Swal.close();
                        let errorMessage = 'Terjadi kesalahan saat mengirim data.';
                        if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                            errorMessage = jqXHR.responseJSON.message;
                        } else if (errorThrown) {
                            errorMessage = `Error: ${errorThrown}`;
                        }
                        Swal.fire('Error!', errorMessage, 'error');
                        console.error("AJAX Error:", textStatus, errorThrown, jqXHR.responseText);
                    }
                });
            });

            // --- Fungsi Pembantu (Helpers) ---

            // Converts Rupiah format string to a float number
            function parseMoney(value) {
                if (typeof value !== 'string') return value;
                return parseFloat(value.replace(/Rp /g, '').replace(/\./g, '').replace(/,/g, '.') || '0');
            }

            // Formats a float number to Rupiah string
            function formatMoney(value) {
                if (isNaN(value)) return 'Rp 0,00';
                // Hindari masalah floating point untuk pembulatan yang sangat presisi
                return 'Rp ' + (Math.round(value * 100) / 100).toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            // Update all calculations based on current input values
            function updateAllCalculations() {
                calculateInitialCapital();
                calculateOngoingCapital();
                calculateKPSPobligation();
            }

            // --- Implementasi Perhitungan KPSP ---

            function calculateInitialCapital() {
                const kategoriIzin = $('#kategori_izin').val(); // Mendapatkan kategori izin dari field tersembunyi
                const jumlahModalDisetor = parseMoney($('#jumlahModalDisetor').val());
                const isPIPAsing = $('#flagGL_PIPasing').is(':checked');

                let kewajibanInitCapital = 0;
                let statusPemenuhan = "Tidak Memenuhi";
                let tambahanInitCapital = 0;

                // Tentukan kewajiban Initial Capital berdasarkan kategori izin yang didapat dari data bank
                if (kategoriIzin) {
                    if (kategoriIzin === "PIP") {
                        kewajibanInitCapital = PARAMS.initialCapital.PIP;
                    } else if (kategoriIzin === "KI1") { // AIS
                        kewajibanInitCapital = PARAMS.initialCapital.AIS;
                    } else if (kategoriIzin === "KI2") { // PIAS
                        kewajibanInitCapital = PARAMS.initialCapital.PIAS;
                    } else if (kategoriIzin === "KI3") { // REM1/REM2 - perlu ditentukan berdasarkan aktivitas yang diceklis
                        kewajibanInitCapital = Math.min(PARAMS.initialCapital.REM1, PARAMS.initialCapital.REM2);
                    }
                }

                // Logika status pemenuhan
                if (isPIPAsing && kategoriIzin === "PIP") { // PIP Asing selalu "Memenuhi" jika guarantee letter diceklis
                    statusPemenuhan = "Memenuhi";
                    tambahanInitCapital = 0;
                } else if (jumlahModalDisetor >= kewajibanInitCapital) {
                    statusPemenuhan = "Memenuhi";
                    tambahanInitCapital = 0;
                } else {
                    statusPemenuhan = "Tidak Memenuhi";
                    tambahanInitCapital = kewajibanInitCapital - jumlahModalDisetor;
                }

                $('#kewajibanInitCapital').val(formatMoney(kewajibanInitCapital));
                $('#statusPemenuhan_initialCapital').val(statusPemenuhan).removeClass('bg-success-custom bg-danger-custom').addClass(statusPemenuhan === "Memenuhi" ? 'bg-success-custom' : 'bg-danger-custom');
                $('#tambahanInitCapital').val(formatMoney(tambahanInitCapital));
            }

            function calculateOngoingCapital() {
                const jumlahBulanTrx = parseFloat($('#jumlahBulanTrx').val()) || 1;

                // Transaksi Inputs
                const totalTrx_ATMDebet = parseMoney($('#totalTrx_ATMDebet').val());
                const totalTrx_KK = parseMoney($('#totalTrx_KK').val());
                const trxDompel = parseMoney($('#trxDompel').val());
                const trxTrfDanaLN_inc = parseMoney($('#trxTrfDanaLN_inc').val());
                const trxTrfDanaLN_out = parseMoney($('#trxTrfDanaLN_out').val());
                const trxTrfDana_dom = parseMoney($('#trxTrfDana_dom').val());
                const trxUE = parseMoney($('#trxUE').val());
                let trxPIAS_fasil = parseMoney($('#trxPIAS_fasil').val()); // Diperhitungkan 10%
                const trxPIAS_merchAgg = parseMoney($('#trxPIAS_merchAgg').val());
                const trxLainnya = parseMoney($('#trxLainnya').val());

                // Rata-rata transaksi
                const calculateRata = (value) => (jumlahBulanTrx > 0 ? value / jumlahBulanTrx : 0);
                $('#totalTrx_ATMDebet_rata').val(formatMoney(calculateRata(totalTrx_ATMDebet)));
                $('#totalTrx_KK_rata').val(formatMoney(calculateRata(totalTrx_KK)));
                $('#trxDompel_rata').val(formatMoney(calculateRata(trxDompel)));
                $('#trxTrfDanaLN_inc_rata').val(formatMoney(calculateRata(trxTrfDanaLN_inc)));
                $('#trxTrfDanaLN_out_rata').val(formatMoney(calculateRata(trxTrfDanaLN_out)));
                $('#trxTrfDana_dom_rata').val(formatMoney(calculateRata(trxTrfDana_dom)));
                $('#trxUE_rata').val(formatMoney(calculateRata(trxUE)));

                // Perhitungan PIAS - Fasilitator (10%)
                const trxPIAS_fasil_processed = trxPIAS_fasil * 0.10;
                $('#trxPIAS_fasil_rata').val(formatMoney(calculateRata(trxPIAS_fasil_processed)));

                // Total Nilai Transaksi (TTMR)
                const totalNilaiTrx = totalTrx_ATMDebet + totalTrx_KK + trxDompel + trxTrfDanaLN_inc + trxTrfDanaLN_out + trxTrfDana_dom + trxUE + trxPIAS_fasil_processed + trxPIAS_merchAgg + trxLainnya;
                $('#totalNilaiTrx').val(formatMoney(totalNilaiTrx));
                $('#totalNilaiTrx_rata').val(formatMoney(calculateRata(totalNilaiTrx)));

                // Beban Transaksi Progresif (mengikuti band rates)
                let bebanTrx = 0;
                let tempTotalTrx = totalNilaiTrx;

                // Rate 0.1% for band above 1 Trillion
                if (tempTotalTrx > PARAMS.otherParams.rateBand1Perc) {
                    bebanTrx += (tempTotalTrx - PARAMS.otherParams.rateBand1Perc) * 0.001;
                    tempTotalTrx = PARAMS.otherParams.rateBand1Perc;
                }
                // Rate 1% for band between 100 Billion and 1 Trillion
                if (tempTotalTrx > PARAMS.otherParams.rateBand4Perc) {
                    bebanTrx += (tempTotalTrx - PARAMS.otherParams.rateBand4Perc) * 0.01;
                    tempTotalTrx = PARAMS.otherParams.rateBand4Perc;
                }
                // Rate 4% for band up to 100 Billion
                bebanTrx += tempTotalTrx * 0.04;
                
                $('#bebanTrx').val(formatMoney(bebanTrx));

                // Dana Float
                const danaFloat = parseMoney($('#danaFloat').val());
                $('#danaFloat_rata').val(formatMoney(calculateRata(danaFloat)));
                const percBebanTrxDanaFloat = PARAMS.otherParams.bebanDanaFloat; // 5%
                const bebanTrxDanaFloat = danaFloat * (percBebanTrxDanaFloat / 100);
                $('#percBebanTrxDanaFloat').val(percBebanTrxDanaFloat.toFixed(2));
                $('#bebanTrxDanaFloat').val(formatMoney(bebanTrxDanaFloat));

                // Total Beban
                const totalBeban = bebanTrx + bebanTrxDanaFloat;
                $('#totalBeban').val(formatMoney(totalBeban));

                // Konstanta TTMR
                const kategoriIzin = $('#kategori_izin').val(); // Mengambil kategori izin dari field tersembunyi
                let konstantaTTMR_val = PARAMS.otherParams.konstantaTTMR;
                // Asumsi: Jika kategori izin KI3, gunakan konstantaTTMR_KI3, jika ada.
                if (kategoriIzin === 'KI3' && PARAMS.otherParams.konstantaTTMR_KI3 !== undefined) { 
                    konstantaTTMR_val = PARAMS.otherParams.konstantaTTMR_KI3;
                }
                $('#konstantaTTMR').val(konstantaTTMR_val);

                // TTMR (Transaksi Tertimbang Menurut Risiko)
                const TTMR = totalBeban * konstantaTTMR_val;
                $('#TTMR').val(formatMoney(TTMR));


                // --- Komponen Perhitungan Ongoing Capital ---
                const modalSaham = parseMoney($('#modalSaham').val());
                const uangMukaSetoranModal = parseMoney($('#uangMukaSetoranModal').val());
                const agioDisagioSaham = parseMoney($('#agioDisagioSaham').val());
                const saldoLRberjalan = parseMoney($('#saldoLRberjalan').val());
                const saldoPenghasilanKompr = parseMoney($('#saldoPenghasilanKompr').val());

                // Modal Inti Utama (sebelum pengurangan)
                const modalIntiUtama = modalSaham + uangMukaSetoranModal + agioDisagioSaham + saldoLRberjalan + saldoPenghasilanKompr;
                $('#modalIntiUtama').val(formatMoney(modalIntiUtama));

                const asetPajakTangguhan = parseMoney($('#asetPajakTangguhan').val());
                const goodWill = parseMoney($('#goodWill').val());
                const asetTidakBerwujud = parseMoney($('#asetTidakBerwujud').val());
                const seluruhPenyertaan = parseMoney($('#seluruhPenyertaan').val());
                const pembelianKembaliInstModal = parseMoney($('#pembelianKembaliInstModal').val());
                const penempatanDanaInstUtang = parseMoney($('#penempatanDanaInstUtang').val());

                // Faktor Pengurang Modal Inti Utama
                const faktorPengurangModalInti = asetPajakTangguhan + goodWill + asetTidakBerwujud + seluruhPenyertaan + pembelianKembaliInstModal + penempatanDanaInstUtang;
                $('#faktorPengurangModalInti').val(formatMoney(faktorPengurangModalInti));

                // Modal Inti Utama (setelah pengurangan)
                const modalIntiUtama_setelahFPR = modalIntiUtama - faktorPengurangModalInti;
                $('#modalIntiUtama_setelahFPR').val(formatMoney(modalIntiUtama_setelahFPR));


                const instrumenUtang = parseMoney($('#instrumenUtang').val());
                const instrumenHybrid = parseMoney($('#instrumenHybrid').val());
                const sahamPreferenNonKumulatif = parseMoney($('#sahamPreferenNonKumulatif').val());
                const premiumDiskonto = parseMoney($('#premiumDiskonto').val());

                // Modal Inti Tambahan (sebelum pengurangan)
                const modalIntiTambahan = instrumenUtang + instrumenHybrid + sahamPreferenNonKumulatif + premiumDiskonto;
                $('#modalIntiTambahan').val(formatMoney(modalIntiTambahan));

                const instrumenModalIntiTambahan = parseMoney($('#instrumenModalIntiTambahan').val());
                const kepemilikanModalIntiTambahan = parseMoney($('#kepemilikanModalIntiTambahan').val());

                // Faktor Pengurang Modal Inti Tambahan
                const faktorPengurangModalIntiTambahan = instrumenModalIntiTambahan + kepemilikanModalIntiTambahan;
                $('#faktorPengurangModalIntiTambahan').val(formatMoney(faktorPengurangModalIntiTambahan));

                // Modal Inti Tambahan (setelah pengurangan)
                const modalIntiTambahan_setelahFPR = modalIntiTambahan - faktorPengurangModalIntiTambahan;
                $('#modalIntiTambahan_setelahFPR').val(formatMoney(modalIntiTambahan_setelahFPR));

                // Modal Inti Tambahan yang dapat diperhitungkan sebagai Ongoing Capital (max 1/3 modal inti utama)
                const maxModalIntiTambahanOngoing = modalIntiUtama_setelahFPR / 3;
                const modalIntiTambahan_ongoingCapital = Math.min(modalIntiTambahan_setelahFPR, maxModalIntiTambahanOngoing);
                $('#modalIntiTambahan_ongoingCapital').val(formatMoney(modalIntiTambahan_ongoingCapital));


                const instrumenUtangJangkaPjg = parseMoney($('#instrumenUtangJangkaPjg').val());
                const premiumDiskontoModalPelengkap = parseMoney($('#premiumDiskontoModalPelengkap').val());

                // Modal Pelengkap (sebelum pengurangan)
                const modalPelengkap = instrumenUtangJangkaPjg + premiumDiskontoModalPelengkap;
                $('#modalPelengkap').val(formatMoney(modalPelengkap));

                const instrumenModalPelengkap = parseMoney($('#instrumenModalPelengkap').val());
                const kepemilikanModalPelengkap = parseMoney($('#kepemilikanModalPelengkap').val());

                // Faktor Pengurang Modal Pelengkap
                const faktorPengurangModalPelengkap = instrumenModalPelengkap + kepemilikanModalPelengkap;
                $('#faktorPengurangModalPelengkap').val(formatMoney(faktorPengurangModalPelengkap));

                // Modal Pelengkap (setelah pengurangan)
                const modalPelengkap_setelahFPR = modalPelengkap - faktorPengurangModalPelengkap;
                $('#modalPelengkap_setelahFPR').val(formatMoney(modalPelengkap_setelahFPR));

                // Modal Pelengkap yang dapat diperhitungkan sebagai Ongoing Capital (max 1/3 Modal Inti Tambahan yang dapat diperhitungkan sebagai ongoing capital)
                const maxModalPelengkapOngoing = modalIntiTambahan_ongoingCapital / 3;
                const modalPelengkap_ongoingCapital = Math.min(modalPelengkap_setelahFPR, maxModalPelengkapOngoing);
                $('#modalPelengkap_ongoingCapital').val(formatMoney(modalPelengkap_ongoingCapital));

                // Total Ongoing Capital
                const totalOngoingCapital = modalIntiUtama_setelahFPR + modalIntiTambahan_ongoingCapital + modalPelengkap_ongoingCapital;
                $('#totalOngoingCapital').val(formatMoney(totalOngoingCapital));

                // Rasio KPSP (Ongoing Capital / TTMR)
                const rasioKPSP_val = (TTMR !== 0) ? (totalOngoingCapital / TTMR) * 100 : 0;
                $('#rasioKPSP').val(rasioKPSP_val.toFixed(2));
            }

            function calculateKPSPobligation() {
                // Klasifikasi PJP/PIP sekarang akan diambil dari data bank yang sudah diisi secara otomatis
                const kategoriIzin = $('#kategori_izin').val(); // Mengambil kategori izin
                const klasifikasiPJPPIP = ''; // Kosongkan atau dapatkan dari logika Anda jika ada pemetaan khusus
                const isPIPAsing = $('#flagGL_PIPasing').is(':checked');

                let KPSPdasar = 0;
                let surcharge = 0;
                let totalKPSP = 0;

                // Tentukan KPSP berdasarkan kategori izin dan flag PIP Asing
                // Anda mungkin perlu menyesuaikan logika ini berdasarkan bagaimana
                // 'Klasifikasi PJP/PIP' (`PSPS`, `PSPK`, `PSPU`) ditentukan dari `Kategori Izin` (KI1, KI2, KI3, PIP)
                // Jika tidak ada logika pemetaan, Anda mungkin perlu menambahkan field untuk klasifikasi ini lagi.
                // Untuk saat ini, saya akan mengasumsikan mapping sederhana atau default.

                // Contoh pemetaan sederhana berdasarkan Kategori Izin
                if (kategoriIzin === "PIP") {
                    if (isPIPAsing) { // Contoh: PIP Asing mungkin selalu PSPS dengan surcharge
                        KPSPdasar = PARAMS.kpspObligation.PIP_PSPS.dasar;
                        surcharge = PARAMS.kpspObligation.PIP_PSPS.surcharge;
                        totalKPSP = PARAMS.kpspObligation.PIP_PSPS.total;
                    } else { // PIP non-asing, asumsikan PSPS
                        KPSPdasar = PARAMS.kpspObligation.PSPS.dasar;
                        surcharge = PARAMS.kpspObligation.PSPS.surcharge;
                        totalKPSP = PARAMS.kpspObligation.PSPS.total;
                    }
                } else if (kategoriIzin === "KI1" || kategoriIzin === "KI2") { // Asumsi KI1/KI2 adalah PSPK
                    KPSPdasar = PARAMS.kpspObligation.PSPK.dasar;
                    surcharge = PARAMS.kpspObligation.PSPK.surcharge;
                    totalKPSP = PARAMS.kpspObligation.PSPK.total;
                } else if (kategoriIzin === "KI3") { // Asumsi KI3 adalah PSPU
                    KPSPdasar = PARAMS.kpspObligation.PSPU.dasar;
                    surcharge = PARAMS.kpspObligation.PSPU.surcharge;
                    totalKPSP = PARAMS.kpspObligation.PSPU.total;
                }

                $('#KPSPdasar').val(KPSPdasar.toFixed(2));
                $('#surcharge').val(surcharge.toFixed(2));
                $('#totalKPSP').val(totalKPSP.toFixed(2));

                const TTMR_val = parseMoney($('#TTMR').val());
                const jumlahKewajibanOngoingCapital = (totalKPSP / 100) * TTMR_val;
                $('#jumlahKewajibanOngoingCapital').val(formatMoney(jumlahKewajibanOngoingCapital));

                const totalOngoingCapital_val = parseMoney($('#totalOngoingCapital').val());
                let statusPemenuhanOngoingCapital = "Tidak Memenuhi";
                let totalKebutuhanTambahanOngoingCapital = 0;

                if (totalOngoingCapital_val >= jumlahKewajibanOngoingCapital) {
                    statusPemenuhanOngoingCapital = "Memenuhi";
                    totalKebutuhanTambahanOngoingCapital = 0;
                } else {
                    statusPemenuhanOngoingCapital = "Tidak Memenuhi";
                    totalKebutuhanTambahanOngoingCapital = jumlahKewajibanOngoingCapital - totalOngoingCapital_val;
                }
                $('#statusPemenuhanOngoingCapital').val(statusPemenuhanOngoingCapital).removeClass('bg-success-custom bg-danger-custom').addClass(statusPemenuhanOngoingCapital === "Memenuhi" ? 'bg-success-custom' : 'bg-danger-custom');
                $('#totalKebutuhanTambahanOngoingCapital').val(formatMoney(totalKebutuhanTambahanOngoingCapital));
            }


            // --- Fungsi untuk Menampilkan Hasil Akhir di Card Terpisah ---
            function displayFinalResults() {
                // Ambil nilai yang sudah dihitung dan ditampilkan di form
                const initialCapitalStatus = $('#statusPemenuhan_initialCapital').val();
                const totalOngoingCapital = $('#totalOngoingCapital').val();
                const rasioKPSP_display = $('#rasioKPSP').val(); // Sudah termasuk '%'
                const finalTotalKPSP = $('#totalKPSP').val(); // Sudah termasuk '%'
                const ongoingCapitalObligation = $('#jumlahKewajibanOngoingCapital').val();
                const ongoingCapitalStatus = $('#statusPemenuhanOngoingCapital').val();
                const neededOngoingCapital = $('#totalKebutuhanTambahanOngoingCapital').val();

                let resultsHtml = `
                    <div class="result-item"><span>Status Pemenuhan Initial Capital:</span> <strong class="${initialCapitalStatus === 'Memenuhi' ? 'text-success' : 'text-danger'}">${initialCapitalStatus}</strong></div>
                    <div class="result-item"><span>Total Ongoing Capital:</span> <strong>${totalOngoingCapital}</strong></div>
                    <div class="result-item"><span>Rasio KPSP (Ongoing Capital/TTMR):</span> <strong>${rasioKPSP_display}%</strong></div>
                    <div class="result-item"><span>Total KPSP (Kewajiban):</span> <strong>${finalTotalKPSP}%</strong></div>
                    <div class="result-item"><span>Jumlah Kewajiban Ongoing Capital:</span> <strong>${ongoingCapitalObligation}</strong></div>
                    <div class="result-item"><span>Status Pemenuhan Ongoing Capital:</span> <strong class="${ongoingCapitalStatus === 'Memenuhi' ? 'text-success' : 'text-danger'}">${ongoingCapitalStatus}</strong></div>
                    <div class="result-item"><span>Total Kebutuhan Tambahan Ongoing Capital:</span> <strong>${neededOngoingCapital}</strong></div>
                `;

                $('#kpsp_results').html(resultsHtml);
                $('#kpsp_results_card').show();
                // Smooth scroll ke bagian hasil
                $('html, body').animate({
                    scrollTop: $('#kpsp_results_card').offset().top - 100
                }, 500);
            }

            // Initial calculation on page load
            // Call this after all initializations are done
            updateAllCalculations();
        });
    </script>
</body>
{% endblock %}
