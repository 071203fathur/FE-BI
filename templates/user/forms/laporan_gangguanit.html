{% extends 'user/base.html' %}

{% block title %}Laporan Gangguan IT{% endblock %}

{% block extra_head %}
<!-- Font Inter -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Mengatur font-family secara global untuk halaman ini */
    body {
        font-family: 'Inter', sans-serif;
    }

    /* Kelas utilitas untuk spinner */
    .spinner-border {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        vertical-align: middle;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }

    @keyframes spinner-border {
        to {
            transform: rotate(360deg);
        }
    }

    .d-none {
        display: none !important;
    }

    /* Custom styles to match Laporan P2P form aesthetics */
    .section-group {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 0;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .section-group .section-header {
        font-size: 1.15rem;
        font-weight: 700;
        color: #1f2937;
        background-color: #eef2f6;
        padding: 0.8rem 1.5rem;
        margin-top: 0;
        margin-left: -1px;
        margin-right: -1px;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e0e7eb;
        border-top-left-radius: 11px;
        border-top-right-radius: 11px;
    }

    .section-group .section-content {
        padding: 1.5rem;
        padding-top: 0;
    }

    /* Adjust font size for labels and inputs for precision */
    .form-label {
        font-size: 0.95rem;
        font-weight: 600;
        color: #374151;
    }

    .form-input {
        font-size: 0.9rem;
        padding: 0.7rem 1rem;
        font-family: inherit;
        width: 100%; /* Ensure inputs take full width of their container */
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }

    /* Styles for the loading overlay */
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(3px);
    }

    #loadingOverlay .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.35em;
        color: #ffffff;
    }

    /* Styles for the message box backdrop */
    #messageBoxBackdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none;
    }

    /* Styles for the message box pop-up */
    #dynamicMessageBox {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 1.5rem 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        display: none;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
        max-width: 400px;
        width: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    #dynamicMessageBox.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    #dynamicMessageBox.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    #dynamicMessageBox .icon-container {
        font-size: 3rem;
        line-height: 1;
        animation: fade-in-scale 0.5s ease-out forwards;
    }

    @keyframes fade-in-scale {
        from {
            opacity: 0;
            transform: scale(0.5);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    #dynamicMessageBox .ok-button {
        background-color: #4CAF50;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 700;
        transition: background-color 0.3s ease;
    }

    #dynamicMessageBox .ok-button:hover {
        background-color: #45a049;
    }
</style>
{% endblock %}

{% block content %}
<div class="tw-max-w-4xl tw-mx-auto tw-my-8 tw-p-6 tw-bg-white tw-rounded-2xl tw-shadow-2xl tw-space-y-6">

    <h2
        class="tw-text-3xl tw-font-extrabold tw-text-gray-900 tw-text-center tw-border-b-4 tw-border-indigo-600 tw-pb-4 tw-mb-6">
        Formulir Laporan Gangguan IT</h2>

    <form id="itIncidentForm" action="{{ url_for('submit_laporan_gangguanit') }}" method="POST" enctype="multipart/form-data"
        class="tw-space-y-6">
        <!-- Informasi Umum Laporan -->
        <div class="section-group">
            <h3 class="section-header">Informasi Umum Laporan</h3>
            <div class="section-content">
                <div class="tw-flex tw-w-full">
                    <div class="tw-flex tw-w-1/2 tw-flex-col tw-pr-2">
                        <div class="tw-my-2">
                            <label for="nomor_surat" class="tw-block form-label">Nomor Surat <span
                                    class="tw-text-red-500">*</span></label>
                            <input type="text" id="nomor_surat" name="nomor_surat" placeholder="Masukkan Nomor Surat"
                                required
                                class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out">
                        </div>
                    </div>
                    <div class="tw-flex tw-w-1/2 tw-flex-col tw-pl-2">
                        <div class="tw-my-2">
                            <label for="tanggal_surat" class="tw-block form-label">Tanggal Surat <span
                                    class="tw-text-red-500">*</span></label>
                            <input type="date" id="tanggal_surat" name="tanggal_surat" required
                                class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out">
                        </div>
                    </div>
                </div>
                <div class="tw-flex tw-flex-col md:tw-col-span-2 tw-mt-3">
                    <label for="file" class="tw-flex form-label">Pilih File Laporan (PDF) <span
                            class="tw-text-red-500">*</span></label>
                    <input type="file" id="file" name="file" accept=".pdf" required
                        class="tw-flex tw-w-full tw-text-sm tw-text-gray-500 file:tw-mr-4 file:tw-py-2 file:tw-px-4 file:tw-rounded-full file:tw-border-0 file:tw-text-sm file:tw-font-semibold file:tw-bg-indigo-50 file:tw-text-indigo-700 hover:file:tw-bg-indigo-100 tw-cursor-pointer tw-transition tw-duration-150 tw-ease-in-out">
                    <p class="tw-text-xs tw-text-gray-500 tw-mt-1">Ukuran file maksimal: 5MB</p>
                </div>
            </div>
        </div>

        <!-- Detail Gangguan IT -->
        <div class="section-group">
            <h3 class="section-header">Detail Gangguan IT</h3>
            <div class="section-content">
                <div class="tw-flex tw-w-full">
                    <div class="tw-flex tw-w-1/2 tw-flex-col tw-pr-2">
                        <div class="tw-my-2">
                            <label for="waktu_kejadian" class="tw-block form-label">Waktu Kejadian <span
                                    class="tw-text-red-500">*</span></label>
                            <input type="datetime-local" id="waktu_kejadian" name="waktu_kejadian" required
                                class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out">
                            <p class="tw-text-xs tw-text-gray-500 tw-mt-1">Format: YYYY-MM-DDTHH:MM (misal: 2025-06-26T14:30)</p>
                        </div>
                    </div>
                    <div class="tw-flex tw-w-1/2 tw-flex-col tw-pl-2">
                        <div class="tw-my-2">
                            <label for="jenis_gangguan" class="tw-block form-label">Jenis Gangguan <span
                                    class="tw-text-red-500">*</span></label>
                            <select id="jenis_gangguan" name="jenis_gangguan" required
                                class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out">
                                <option value="" disabled selected>Pilih Jenis Gangguan</option>
                                <option value="Perangkat Keras">Perangkat Keras</option>
                                <option value="Perangkat Lunak">Perangkat Lunak</option>
                                <option value="Jaringan">Jaringan</option>
                                <option value="Keamanan Siber">Keamanan Siber</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="tw-flex tw-flex-col tw-my-2">
                    <label for="ringkasan" class="tw-block form-label">Ringkasan Gangguan <span
                            class="tw-text-red-500">*</span></label>
                    <textarea id="ringkasan" name="ringkasan" rows="3" placeholder="Jelaskan ringkasan gangguan IT" required
                        class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out"></textarea>
                </div>
                <div class="tw-flex tw-flex-col tw-my-2">
                    <label for="potensi_kerugian" class="tw-block form-label">Potensi Kerugian (Rp) <span
                            class="tw-text-red-500">*</span></label>
                    <input type="number" id="potensi_kerugian" name="potensi_kerugian" placeholder="Masukkan nilai potensi kerugian" required min="0"
                        class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out">
                </div>
            </div>
        </div>

        <!-- Penanganan dan Status -->
        <div class="section-group">
            <h3 class="section-header">Penanganan dan Status</h3>
            <div class="section-content">
                <div class="tw-flex tw-flex-col tw-my-2">
                    <label for="upaya_perbaikan" class="tw-block form-label">Upaya Perbaikan <span
                            class="tw-text-red-500">*</span></label>
                    <textarea id="upaya_perbaikan" name="upaya_perbaikan" rows="3" placeholder="Jelaskan upaya perbaikan yang telah dilakukan" required
                        class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out"></textarea>
                </div>
                <div class="tw-flex tw-w-full">
                    <div class="tw-flex tw-w-1/2 tw-flex-col tw-pr-2">
                        <div class="tw-my-2">
                            <label for="status_penyelesaian" class="tw-block form-label">Status Penyelesaian <span
                                    class="tw-text-red-500">*</span></label>
                            <select id="status_penyelesaian" name="status_penyelesaian" required
                                class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out">
                                <option value="" disabled selected>Pilih Status</option>
                                <option value="Belum Terselesaikan">Belum Terselesaikan</option>
                                <option value="Terselesaikan">Terselesaikan</option>
                            </select>
                        </div>
                    </div>
                    <div class="tw-flex tw-w-1/2 tw-flex-col tw-pl-2" id="waktu_penyelesaian_group" style="display: none;">
                        <div class="tw-my-2">
                            <label for="tanggal_penyelesaian" class="tw-block form-label">Tanggal Penyelesaian <span
                                    class="tw-text-red-500">*</span></label>
                            <input type="date" id="tanggal_penyelesaian" name="tanggal_penyelesaian"
                                class="tw-mt-1 form-input tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-shadow-sm focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-indigo-500 focus:tw-border-indigo-500 tw-transition tw-duration-150 tw-ease-in-out">
                            <p class="tw-text-xs tw-text-gray-500 tw-mt-1">Format: YYYY-MM-DD (misal: 2025-06-26)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tw-flex tw-justify-end tw-gap-4 tw-pt-6">
            <button type="submit"
                class="tw-inline-flex tw-items-center tw-px-8 tw-py-3 tw-border tw-border-transparent tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-white tw-bg-green-600 hover:tw-bg-green-700 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-green-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105"
                id="submitButton">
                <span class="submit-text">Kirim Laporan</span>
                <span
                    class="spinner-border tw-w-5 tw-h-5 tw-ml-2 tw-border-2 tw-border-white tw-border-r-transparent tw-rounded-full tw-animate-spin d-none"
                    role="status" aria-hidden="true"></span>
            </button>
            <button type="button"
                class="tw-inline-flex tw-items-center tw-px-8 tw-py-3 tw-border tw-border-gray-300 tw-text-base tw-font-bold tw-rounded-xl tw-shadow-lg tw-text-gray-700 tw-bg-white hover:tw-bg-gray-100 focus:tw-outline-none focus:tw-ring-2 focus:tw-ring-offset-2 focus:tw-ring-indigo-500 tw-transition tw-duration-300 tw-transform hover:tw-scale-105"
                onclick="window.history.back()">Batal</button>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<!-- Message Box Backdrop -->
<div id="messageBoxBackdrop" class="d-none"></div>

<!-- Dynamic Message Box (Pop-up) -->
<div id="dynamicMessageBox" class="d-none">
    <div id="messageBoxIcon" class="icon-container"></div>
    <p id="messageBoxContent"></p>
    <button id="messageBoxOkButton" class="ok-button d-none">Oke</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('itIncidentForm');
        const submitButton = document.getElementById('submitButton');
        const submitText = submitButton.querySelector('.submit-text');
        const submitSpinner = submitButton.querySelector('.spinner-border');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const messageBoxBackdrop = document.getElementById('messageBoxBackdrop');
        const dynamicMessageBox = document.getElementById('dynamicMessageBox');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxIcon = document.getElementById('messageBoxIcon');
        const messageBoxOkButton = document.getElementById('messageBoxOkButton');
        const statusPenyelesaianSelect = document.getElementById('status_penyelesaian'); // Get the select element
        const waktuPenyelesaianGroup = document.getElementById('waktu_penyelesaian_group');
        const tanggalPenyelesaianInput = document.getElementById('tanggal_penyelesaian');

        // Event listener for the "Oke" button to close the message box
        messageBoxOkButton.addEventListener('click', () => {
            dynamicMessageBox.classList.add('d-none');
            messageBoxBackdrop.classList.add('d-none');
        });

        function showMessageBox(message, type) {
            messageBoxContent.textContent = message;
            dynamicMessageBox.classList.remove('success', 'error');
            messageBoxIcon.innerHTML = '';
            messageBoxOkButton.classList.add('d-none');
            messageBoxBackdrop.classList.remove('d-none');

            if (type === 'success') {
                dynamicMessageBox.classList.add('success');
                messageBoxIcon.innerHTML = '&#10003;'; // Checkmark icon
                messageBoxOkButton.classList.remove('d-none');
            } else if (type === 'error') {
                dynamicMessageBox.classList.add('error');
                messageBoxIcon.innerHTML = '&#x2716;'; // Cross mark icon
                messageBoxOkButton.classList.remove('d-none'); // Show OK button for errors too
            }
            dynamicMessageBox.classList.remove('d-none');
        }

        function toggleWaktuPenyelesaian() {
            var statusPenyelesaian = statusPenyelesaianSelect.value; // Use the fetched element
            
            if (statusPenyelesaian === 'Terselesaikan') {
                waktuPenyelesaianGroup.style.display = 'block';
                tanggalPenyelesaianInput.setAttribute('required', 'true');
            } else {
                waktuPenyelesaianGroup.style.display = 'none';
                tanggalPenyelesaianInput.removeAttribute('required');
                tanggalPenyelesaianInput.value = ''; // Clear value if not resolved
            }
        }

        // Add event listener for the change event on the select element
        statusPenyelesaianSelect.addEventListener('change', toggleWaktuPenyelesaian);

        // Call on page load to set initial display
        toggleWaktuPenyelesaian();

        // Date validation for tanggal_surat and waktu_kejadian/tanggal_penyelesaian
        const tanggalSuratInput = document.getElementById('tanggal_surat');
        const waktuKejadianInput = document.getElementById('waktu_kejadian');
        

        const setMaxDateTime = (inputElement) => {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            inputElement.max = `${year}-${month}-${day}T${hours}:${minutes}`;
        };

        if (tanggalSuratInput) {
            const today = new Date().toISOString().split('T')[0];
            tanggalSuratInput.max = today;
        }
        if (waktuKejadianInput) {
            setMaxDateTime(waktuKejadianInput);
        }
        // tanggalPenyelesaianInput is type="date", so only set max date, not datetime
        if (tanggalPenyelesaianInput && tanggalPenyelesaianInput.type === 'date') {
            const today = new Date().toISOString().split('T')[0];
            tanggalPenyelesaianInput.max = today;
        }
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            let formIsValid = true;

            // Validate file size (max 5MB as per API)
            const fileInput = document.getElementById('file');
            if (fileInput.files[0] && fileInput.files[0].size > 5 * 1024 * 1024) { // 5MB
                showMessageBox('Ukuran file lampiran melebihi 5MB.', 'error');
                formIsValid = false;
            }

            // Validate waktu_kejadian is not in the future
            if (waktuKejadianInput && waktuKejadianInput.value) {
                const kejadianDateTime = new Date(waktuKejadianInput.value);
                if (kejadianDateTime > new Date()) {
                    showMessageBox('Waktu Kejadian tidak boleh di masa depan.', 'error');
                    formIsValid = false;
                }
            }

            // Validate tanggal_penyelesaian is not in the future and not before waktu_kejadian
            if (tanggalPenyelesaianInput && tanggalPenyelesaianInput.value && statusPenyelesaianSelect.value === 'Terselesaikan') {
                const penyelesaianDate = new Date(tanggalPenyelesaianInput.value); // Now a date input
                const kejadianDate = new Date(waktuKejadianInput.value.split('T')[0]); // Get only date part for comparison

                if (penyelesaianDate > new Date()) {
                    showMessageBox('Tanggal Penyelesaian tidak boleh di masa depan.', 'error');
                    formIsValid = false;
                }
                if (penyelesaianDate < kejadianDate) {
                    showMessageBox('Tanggal Penyelesaian tidak boleh sebelum Waktu Kejadian.', 'error');
                    formIsValid = false;
                }
            }

            if (!formIsValid) {
                console.log("Form tidak valid, pengiriman dibatalkan.");
                // Ensure loading state is reset if client-side validation fails
                submitButton.disabled = false;
                submitText.textContent = 'Kirim Laporan';
                submitSpinner.classList.add('d-none');
                loadingOverlay.classList.add('d-none');
                return;
            }

            // Show loading state
            submitButton.disabled = true;
            submitText.textContent = 'Mengirim...';
            submitSpinner.classList.remove('d-none');
            loadingOverlay.classList.remove('d-none');
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' }
            })
            .then(response => {
                submitButton.disabled = false;
                submitText.textContent = 'Kirim Laporan';
                submitSpinner.classList.add('d-none');
                loadingOverlay.classList.add('d-none');

                if (!response.ok) {
                    return response.json().then(errorData => {
                        // Check if errorData is a string (e.g., from Django REST Framework validation errors)
                        if (typeof errorData === 'string' && errorData.startsWith("{'")) {
                            try {
                                const parsedError = JSON.parse(errorData.replace(/'/g, '"')); // Replace single quotes for valid JSON
                                throw new Error(parsedError.message || JSON.stringify(parsedError));
                            } catch (e) {
                                // Fallback if parsing fails
                                throw new Error(errorData || 'Gagal mengirim laporan (respons tidak valid dari server).');
                            }
                        }
                        throw new Error(errorData.message || JSON.stringify(errorData) || 'Gagal mengirim laporan (status non-2xx)');
                    }).catch(jsonError => {
                        console.error("Error parsing JSON from non-OK response:", jsonError);
                        return response.text().then(text => {
                            throw new new Error(`Gagal mengirim laporan. Respons server: ${text.substring(0, 100)}...`);
                        });
                    });
                }
                return response.json();
            })
            .then(data => {
                // Access data.message.message if the backend wraps the message in a 'message' key
                if (data.success) {
                    showMessageBox(data.message.message || 'Laporan berhasil dikirim!', 'success');
                    form.reset();
                    // Re-initialize toggle for waktu_penyelesaian after form reset
                    toggleWaktuPenyelesaian(); 
                } else {
                    showMessageBox(data.message.message || 'Gagal mengirim laporan.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitButton.disabled = false;
                submitText.textContent = 'Kirim Laporan';
                submitSpinner.classList.add('d-none');
                loadingOverlay.classList.add('d-none');
                showMessageBox(error.message || 'Terjadi kesalahan jaringan atau server.', 'error');
            });
        });

        // Add event listener for form reset to ensure correct initial state
        form.addEventListener('reset', function() {
            // Delay to allow form.reset() to clear values first
            setTimeout(toggleWaktuPenyelesaian, 0); 
        });
    });
</script>
{% endblock %}
