{% extends 'user/base.html' %}

{% block title %}Dashboard Pelaporan - Revamped{% endblock %}

{% block extra_head %}
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Tailwind Colors (if needed, otherwise default colors are used) */
        /* These are defined here for direct use in the HTML, mimicking a tailwind.config.js setup */
        :root {
            --color-bi-blue-dark: #003366;
            --color-bi-gold: #FFD700;
            --color-bi-blue-medium: #0056b3;
            --color-bi-green: #10B981;
            --color-bi-red: #EF4444;
            --color-bi-amber: #F59E0B;
        }

        .bg-biBlueDark { background-color: var(--color-bi-blue-dark); }
        .text-biBlueDark { color: var(--color-bi-blue-dark); }
        .bg-biGold { background-color: var(--color-bi-gold); }
        .text-biGold { color: var(--color-bi-gold); }
        .text-biBlueMedium { color: var(--color-bi-blue-medium); }
        .text-biGreen { color: var(--color-bi-green); }
        .text-biRed { color: var(--color-bi-red); }
        .text-biAmber { color: var(--color-bi-amber); }

        /* General Body and Font */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f8fafc; /* Light background for the whole page */
            color: #334155; /* Default text color */
        }

        /* Hero Section Styling */
        .hero-section {
            background: linear-gradient(135deg, var(--color-bi-blue-dark) 0%, var(--color-bi-blue-medium) 100%);
            color: white;
            padding: 2.5rem 1rem; /* Reduced padding */
            border-radius: 0.75rem; /* Slightly smaller rounded corners */
            text-align: center;
            margin-bottom: 1.5rem; /* Reduced margin */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); /* Slightly softer shadow */
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            opacity: 0.08; /* Very subtle overlay */
            z-index: 0;
        }
        .hero-content {
            position: relative;
            z-index: 1;
        }
        .hero-clock {
            font-size: 2.5rem; /* Reduced font size */
            font-weight: 700; /* font-bold */
            letter-spacing: 0.05em; /* tracking-wide */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4); /* Softer shadow */
            margin-bottom: 1rem; /* Reduced margin */
            color: var(--color-bi-gold); /* Gold clock */
        }
        .hero-title {
            font-size: 2rem; /* Reduced font size */
            font-weight: 800; /* font-extrabold */
            margin-bottom: 0.75rem; /* Reduced margin */
            line-height: 1.2;
        }
        .hero-subtitle {
            font-size: 1rem; /* Reduced font size */
            opacity: 0.95;
            max-width: 500px; /* Reduced max-width */
            margin: 0 auto 1.5rem; /* Reduced margin */
        }
        .hero-info-bar {
            background-color: rgba(255, 255, 255, 0.2); /* More transparent white */
            backdrop-filter: blur(6px); /* Slightly less blur */
            border-radius: 0.5rem; /* Slightly smaller rounded corners */
            padding: 0.75rem 1rem; /* Reduced padding */
            margin-top: 2rem; /* Reduced margin */
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem; /* Reduced space */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border */
        }
        .hero-info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            font-size: 0.85rem; /* Reduced font size */
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .hero-info-item .icon {
            margin-bottom: 0.4rem; /* Reduced margin */
            color: var(--color-bi-gold);
            width: 1.5rem; /* Reduced size */
            height: 1.5rem; /* Reduced size */
        }
        .hero-info-item .value {
            font-weight: 700; /* font-bold */
            font-size: 1rem; /* Reduced font size */
        }
        .hero-info-item .label {
            font-size: 0.75rem; /* Reduced font size */
            opacity: 0.85;
        }

        /* Main Content Wrapper */
        .main-content-wrapper {
            padding: 1rem; /* Reduced padding */
            max-width: 1100px; /* Reduced max width */
            margin: 0 auto; /* Center the content */
        }

        /* Dashboard Content Card */
        .dashboard-content-card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* Slightly smaller rounded corners */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* Softer shadow */
            padding: 1.5rem; /* Reduced padding */
            margin-bottom: 1.5rem; /* Reduced margin */
            border: 1px solid #e2e8f0; /* subtle border */
        }

        /* Section Group (for each report category) */
        .section-group {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem; /* Slightly smaller rounded corners */
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05); /* Softer shadow */
            padding: 0;
            margin-bottom: 1.5rem; /* Reduced space between sections */
            overflow: hidden;
        }
        .section-group .section-header {
            font-size: 1.15rem; /* Reduced font size */
            font-weight: 700; /* font-bold */
            color: var(--color-bi-blue-dark);
            background-color: #eef2f6; /* Light blue-gray header */
            padding: 0.8rem 1.5rem; /* Reduced padding */
            margin-top: 0;
            margin-left: -1px;
            margin-right: -1px;
            margin-bottom: 1rem; /* Reduced margin */
            border-bottom: 1px solid #d1d5db;
            border-top-left-radius: 0.65rem; /* Adjusted for consistency */
            border-top-right-radius: 0.65rem; /* Adjusted for consistency */
            display: flex;
            align-items: center;
            gap: 0.6rem; /* Reduced gap */
        }
        .section-group .section-header .icon {
            color: var(--color-bi-blue-medium);
            width: 1.5rem; /* Reduced size */
            height: 1.5rem; /* Reduced size */
        }
        .section-group .section-content {
            padding: 1rem 1.5rem; /* Reduced padding */
            padding-top: 0;
        }

        /* Deadline Item Card */
        .deadline-item {
            background-color: #ffffff;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.6rem; /* Slightly smaller rounded corners */
            padding: 1rem; /* Reduced padding */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: auto; /* Allow height to adjust */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04); /* Softer shadow */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative; /* For status icon positioning */
        }
        .deadline-item:hover {
            transform: translateY(-3px); /* Reduced hover effect */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); /* Softer hover shadow */
        }
        .deadline-item.uploaded {
            background-color: #f0fdf4; /* Light green background */
            border-color: #86efac; /* Green border */
        }
        .deadline-item.pending {
            background-color: #fffbeb; /* Light amber background */
            border-color: #fcd34d; /* Amber border */
        }
        .deadline-item.overdue {
            background-color: #fef2f2; /* Light red background */
            border-color: #fca5a5; /* Red border */
        }

        .deadline-name {
            font-weight: 600; /* font-semibold */
            color: #1f2937;
            margin-bottom: 0.4rem; /* Reduced margin */
            font-size: 1rem; /* Reduced font size */
        }
        .deadline-date {
            font-size: 0.85rem; /* Reduced font size */
            color: #6b7280;
            margin-bottom: 0.6rem; /* Reduced margin */
        }
        .days-left {
            font-weight: 700; /* font-bold */
            font-size: 0.9rem; /* Reduced font size */
            margin-top: auto; /* Push to bottom */
            padding-top: 0.4rem; /* Reduced padding */
            border-top: 1px dashed #e5e7eb;
            color: #334155;
        }
        .days-left.urgent {
            color: var(--color-bi-red); /* red-500 */
        }
        .days-left.warning {
            color: var(--color-bi-amber); /* amber-500 */
        }
        .days-left.safe {
            color: var(--color-bi-green); /* green-500 */
        }

        .status-indicator {
            position: absolute;
            top: 0.75rem; /* Adjusted position */
            right: 0.75rem; /* Adjusted position */
            font-size: 1.3rem; /* Reduced size */
            line-height: 1;
        }
        .status-indicator.uploaded .lucide {
            color: var(--color-bi-green);
        }
        .status-indicator.pending .lucide {
            color: var(--color-bi-amber);
        }
        .status-indicator.overdue .lucide {
            color: var(--color-bi-red);
        }

        /* KIP Summary Card */
        .kip-summary-card {
            background-color: #e0f2fe; /* Light blue background */
            border: 1px solid #90cdf4; /* Blue border */
            border-radius: 0.6rem; /* Slightly smaller rounded corners */
            padding: 1.25rem 1.5rem; /* Reduced padding */
            margin-bottom: 1.25rem; /* Reduced margin */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.06); /* Softer inner shadow */
            color: #1a365d; /* Darker blue text */
        }
        .kip-summary-card .kip-title {
            font-size: 1.1rem; /* Reduced font size */
            font-weight: 700; /* font-bold */
            color: var(--color-bi-blue-dark);
            margin-bottom: 0.8rem; /* Reduced margin */
        }
        .kip-metrics {
            display: flex;
            justify-content: center;
            gap: 1.5rem; /* Reduced space between metrics */
            flex-wrap: wrap;
        }
        .kip-metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .kip-metric-item .value {
            font-size: 2rem; /* Reduced font size */
            font-weight: 800; /* font-extrabold */
            line-height: 1;
            color: var(--color-bi-blue-medium);
        }
        .kip-metric-item .label {
            font-size: 0.8rem; /* Reduced font size */
            color: #4a5568;
            margin-top: 0.2rem; /* Reduced margin */
        }
        .kip-metric-item .value.urgent-count {
            color: var(--color-bi-red);
        }
        .kip-metric-item .value.uploaded-count {
            color: var(--color-bi-green);
        }
        .kip-metric-item .value.pending-count {
            color: var(--color-bi-amber);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .hero-clock {
                font-size: 2rem;
            }
            .hero-title {
                font-size: 1.75rem;
            }
            .hero-subtitle {
                font-size: 0.9rem;
            }
            .hero-info-bar {
                flex-direction: column;
                align-items: center;
                padding: 0.5rem 0.75rem;
                gap: 0.75rem;
            }
            .hero-info-item .icon {
                width: 1.25rem;
                height: 1.25rem;
            }
            .hero-info-item .value {
                font-size: 0.9rem;
            }
            .hero-info-item .label {
                font-size: 0.7rem;
            }
            .section-group .section-header {
                font-size: 1rem;
                padding: 0.7rem 1rem;
            }
            .section-group .section-content {
                padding: 0.8rem 1rem;
            }
            .dashboard-content-card {
                padding: 1rem;
            }
            .kip-summary-card {
                padding: 0.8rem 1rem;
            }
            .kip-metric-item .value {
                font-size: 1.75rem;
            }
            .kip-metric-item .label {
                font-size: 0.75rem;
            }
            .deadline-name {
                font-size: 0.9rem;
            }
            .deadline-date {
                font-size: 0.8rem;
            }
            .days-left {
                font-size: 0.85rem;
            }
            .status-indicator {
                font-size: 1.1rem;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-bi-red);
            margin-bottom: 1rem;
        }
        .modal-content p {
            font-size: 1rem;
            color: #4a5568;
            margin-bottom: 1.5rem;
        }
        .modal-content button {
            background-color: var(--color-bi-blue-dark);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .modal-content button:hover {
            background-color: var(--color-bi-blue-medium);
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than modal */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid var(--color-bi-blue-dark); /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        .loading-text {
            color: var(--color-bi-blue-dark);
            font-size: 1.1rem;
            font-weight: 600;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
{% endblock %}

{% block content %}
<div class="main-content-wrapper">

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Selamat Datang di Dashboard Pelaporan</h1>
            <p class="hero-subtitle">Pantau semua deadline laporan Anda dengan mudah dan pastikan tidak ada yang terlewat.</p>
            <div class="hero-clock" id="clock"></div>

            <a href="#" class="tw-inline-block tw-mt-6 tw-px-6 tw-py-2.5 tw-bg-biGold tw-text-biBlueDark tw-font-bold tw-rounded-full tw-shadow-lg hover:tw-bg-yellow-400 tw-transition-all tw-duration-300 tw-transform hover:tw-scale-105">
                Mulai Pelaporan Sekarang
            </a>

            <div class="hero-info-bar">
                <div class="hero-info-item">
                    <i data-lucide="map-pin" class="icon"></i>
                    <span class="value">Jakarta, Indonesia</span>
                    <span class="label">Lokasi Kantor Pusat</span>
                </div>
                <div class="hero-info-item">
                    <i data-lucide="phone" class="icon"></i>
                    <span class="value">(021) 3514070​​</span>
                    <span class="label">Kontak Dukungan</span>
                </div>
                <div class="hero-info-item">
                    <i data-lucide="calendar-days" class="icon"></i>
                    <span class="value">Senin - Jumat</span>
                    <span class="label">Jam Operasional</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content Card -->
    <div class="dashboard-content-card">
        <p class="tw-text-lg tw-font-semibold tw-text-gray-800 tw-text-center tw-mb-6">
            Ringkasan Status Laporan & Deadline Mendatang
        </p>

        <!-- Tombol Reload Data -->
        <div class="tw-text-center tw-mb-6">
            <button id="reloadReportData" class="tw-bg-biBlueDark tw-text-white tw-px-5 tw-py-2.5 tw-rounded-lg tw-font-semibold tw-shadow-md hover:tw-bg-biBlueMedium tw-transition-colors tw-duration-300">
                <i data-lucide="rotate-cw" class="tw-inline-block tw-align-middle tw-mr-2"></i>
                Perbarui Data Laporan
            </button>
        </div>

        <!-- Laporan Bulanan -->
        <div class="section-group">
            <h3 class="section-header">
                <i data-lucide="calendar-check" class="icon"></i>
                Laporan Bulanan
            </h3>
            <div class="section-content">
                <div class="kip-summary-card">
                    <div class="kip-title">Status Laporan Bulanan</div>
                    <div class="kip-metrics">
                        <div class="kip-metric-item">
                            <span class="value" id="bulanan-total-count">0</span>
                            <span class="label">Total Laporan</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value uploaded-count" id="bulanan-uploaded-count">0</span>
                            <span class="label">Sudah Diunggah</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value pending-count" id="bulanan-pending-count">0</span>
                            <span class="label">Belum Diunggah</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value urgent-count" id="bulanan-urgent-count">0</span>
                            <span class="label">Mendesak</span>
                        </div>
                    </div>
                </div>
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 lg:tw-grid-cols-3 tw-gap-4" id="bulanan-reports">
                    <!-- Data laporan bulanan akan diisi di sini oleh JavaScript -->
                </div>
            </div>
        </div>

        <!-- Laporan Triwulanan -->
        <div class="section-group">
            <h3 class="section-header">
                <i data-lucide="calendar-range" class="icon"></i>
                Laporan Triwulanan
            </h3>
            <div class="section-content">
                <div class="kip-summary-card">
                    <div class="kip-title">Status Laporan Triwulanan</div>
                    <div class="kip-metrics">
                        <div class="kip-metric-item">
                            <span class="value" id="triwulanan-total-count">0</span>
                            <span class="label">Total Laporan</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value uploaded-count" id="triwulanan-uploaded-count">0</span>
                            <span class="label">Sudah Diunggah</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value pending-count" id="triwulanan-pending-count">0</span>
                            <span class="label">Belum Diunggah</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value urgent-count" id="triwulanan-urgent-count">0</span>
                            <span class="label">Mendesak</span>
                        </div>
                    </div>
                </div>
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 lg:tw-grid-cols-3 tw-gap-4" id="triwulanan-reports">
                    <!-- Data laporan triwulanan akan diisi di sini oleh JavaScript -->
                </div>
            </div>
        </div>

        <!-- Laporan Tahunan -->
        <div class="section-group">
            <h3 class="section-header">
                <i data-lucide="calendar" class="icon"></i>
                Laporan Tahunan
            </h3>
            <div class="section-content">
                <div class="kip-summary-card">
                    <div class="kip-title">Status Laporan Tahunan</div>
                    <div class="kip-metrics">
                        <div class="kip-metric-item">
                            <span class="value" id="tahunan-total-count">0</span>
                            <span class="label">Total Laporan</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value uploaded-count" id="tahunan-uploaded-count">0</span>
                            <span class="label">Sudah Diunggah</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value pending-count" id="tahunan-pending-count">0</span>
                            <span class="label">Belum Diunggah</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value urgent-count" id="tahunan-urgent-count">0</span>
                            <span class="label">Mendesak</span>
                        </div>
                    </div>
                </div>
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 lg:tw-grid-cols-3 tw-gap-4" id="tahunan-reports">
                    <!-- Data laporan tahunan akan diisi di sini oleh JavaScript -->
                </div>
            </div>
        </div>

        <!-- Laporan Insidental -->
        <div class="section-group">
            <h3 class="section-header">
                <i data-lucide="file-text" class="icon"></i>
                Laporan Insidental
            </h3>
            <div class="section-content">
                <div class="kip-summary-card">
                    <div class="kip-title">Status Laporan Insidental</div>
                    <div class="kip-metrics">
                        <div class="kip-metric-item">
                            <span class="value" id="insidental-total-count">0</span>
                            <span class="label">Total Laporan</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value uploaded-count" id="insidental-uploaded-count">0</span>
                            <span class="label">Sudah Diunggah</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value pending-count" id="insidental-pending-count">0</span>
                            <span class="label">Belum Diunggah</span>
                        </div>
                        <div class="kip-metric-item">
                            <span class="value urgent-count" id="insidental-urgent-count">0</span>
                            <span class="label">Mendesak</span>
                        </div>
                    </div>
                </div>
                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 lg:tw-grid-cols-3 tw-gap-4" id="insidental-reports">
                    <!-- Data laporan insidental akan diisi di sini oleh JavaScript -->
                </div>
            </div>
        </div>

    </div> <!-- End dashboard-content-card -->

</div> <!-- End main-content-wrapper -->

<!-- Modal Pop-up untuk Sesi Habis -->
<div id="sessionExpiredModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Sesi Berakhir</h3>
        <p>Sesi Anda telah berakhir karena tidak ada aktivitas atau masalah autentikasi. Silakan login kembali.</p>
        <button id="reloginButton">Login Kembali</button>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Memuat data laporan...</div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Base URL for API
    // This should point to your Flask app's root if the proxy endpoint is at /api/laporan/all-status
    const API_BASE_URL = ""; // Keep empty as Flask handles relative paths for /api/laporan/all-status

    // Store report status data globally after fetching
    let reportStatusData = null;

    /**
     * Shows the loading overlay.
     */
    function showLoadingOverlay() {
        document.getElementById('loadingOverlay').classList.add('show');
    }

    /**
     * Hides the loading overlay.
     */
    function hideLoadingOverlay() {
        document.getElementById('loadingOverlay').classList.remove('show');
    }

    /**
     * Shows the session expired modal.
     */
    function showSessionExpiredModal() {
        document.getElementById('sessionExpiredModal').classList.add('show');
    }

    /**
     * Hides the session expired modal.
     */
    function hideSessionExpiredModal() {
        document.getElementById('sessionExpiredModal').classList.remove('show');
    }

    /**
     * Updates the digital clock display every second.
     */
    function updateClock() {
        const now = new Date();
        // Format time as HH:MM:SS
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const clockElement = document.getElementById('clock');
        if (clockElement) {
            clockElement.textContent = `${hours}:${minutes}:${seconds}`;
        }
    }

    /**
     * Fetches report status from the backend API or retrieves from sessionStorage.
     * @param {boolean} forceFetch - If true, forces fetching from API, bypassing sessionStorage.
     * @returns {Promise<Object|null>} A promise that resolves with the report status data or null on error.
     */
    async function fetchReportStatus(forceFetch = false) {
        // Show loading overlay
        showLoadingOverlay();

        if (!forceFetch && reportStatusData) {
            console.log('Mengambil data status laporan dari cache.');
            hideLoadingOverlay();
            return reportStatusData;
        }

        // Try to load from sessionStorage first if not forcing fetch
        if (!forceFetch) {
            const cachedData = sessionStorage.getItem('reportStatus');
            if (cachedData) {
                try {
                    reportStatusData = JSON.parse(cachedData);
                    console.log('Mengambil data status laporan dari sessionStorage.');
                    hideLoadingOverlay();
                    return reportStatusData;
                } catch (e) {
                    console.error('Gagal parse data dari sessionStorage:', e);
                    sessionStorage.removeItem('reportStatus'); // Clear invalid cache
                }
            }
        }

        console.log('Mengambil data status laporan dari API backend...');
        try {
            const response = await fetch('/api/laporan/all-status', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    // 'Authorization': 'Bearer ' + sessionStorage.getItem('access_token') // Uncomment if token is stored in sessionStorage
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    showSessionExpiredModal(); // Show modal instead of alert
                    // No redirect here, let the user click the button in the modal
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            reportStatusData = data.data; // Store the 'data' object from the response
            sessionStorage.setItem('reportStatus', JSON.stringify(reportStatusData)); // Cache the data
            console.log('Data status laporan berhasil diambil dan disimpan:', reportStatusData);
            return reportStatusData;
        } catch (error) {
            console.error('Gagal mengambil status laporan:', error);
            // Optionally, display an message to the user if not handled by modal
            if (error.message && !document.getElementById('sessionExpiredModal').classList.contains('show')) {
                // Only show alert if session expired modal is not already shown
                alert('Gagal memuat status laporan: ' + error.message);
            }
            return null;
        } finally {
            hideLoadingOverlay(); // Hide loading overlay regardless of success or failure
            lucide.createIcons(); // Re-create Lucide icons after updating innerHTML for status indicators
        }
    }


    /**
     * Renders a single deadline item HTML.
     * @param {string} name - The name of the report.
     * @param {string} deadlineDateStr - The deadline date string (YYYY-MM-DD).
     * @param {string} category - The category of the report (e.g., 'bulanan', 'tahunan').
     * @param {boolean} isUploaded - True if the report is uploaded, false otherwise.
     * @returns {string} The HTML string for the deadline item.
     */
    function renderDeadlineItem(name, deadlineDateStr, category, isUploaded) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const deadlineDate = new Date(deadlineDateStr);
        deadlineDate.setHours(0, 0, 0, 0);

        const diffTime = deadlineDate.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        let statusClass = '';
        let statusText = '';
        let statusIcon = '';
        let daysLeftClass = '';
        let daysLeftText = '';

        if (isUploaded) {
            statusClass = 'uploaded';
            statusIcon = '<i data-lucide="check-circle"></i>';
            daysLeftText = 'Sudah Diunggah';
            daysLeftClass = 'safe';
        } else {
            statusClass = 'pending';
            statusIcon = '<i data-lucide="clock"></i>';

            if (diffDays < 0) {
                statusClass = 'overdue';
                statusIcon = '<i data-lucide="alert-circle"></i>';
                daysLeftText = `Terlambat ${Math.abs(diffDays)} hari`;
                daysLeftClass = 'urgent';
            } else if (diffDays === 0) {
                daysLeftText = 'Deadline Hari Ini!';
                daysLeftClass = 'urgent';
            } else if (diffDays <= 7) {
                daysLeftText = `${diffDays} hari lagi`;
                daysLeftClass = 'urgent';
            } else if (diffDays <= 30) {
                daysLeftText = `${diffDays} hari lagi`;
                daysLeftClass = 'warning';
            } else {
                daysLeftText = `${diffDays} hari lagi`;
                daysLeftClass = 'safe';
            }
        }

        // Format deadline date for display (e.g., 30 April 2025)
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        const displayDeadlineDate = deadlineDate.toLocaleDateString('id-ID', options);

        return `
            <div class="deadline-item ${statusClass}" data-category="${category}" data-uploaded="${isUploaded}">
                <div class="status-indicator ${statusClass}">${statusIcon}</div>
                <div class="deadline-content">
                    <div class="deadline-name">${name}</div>
                    <div class="deadline-date">Deadline: ${displayDeadlineDate}</div>
                </div>
                <div class="days-left ${daysLeftClass}" data-deadline="${deadlineDateStr}">${daysLeftText}</div>
            </div>
        `;
    }

    /**
     * Updates the deadline status and summary counts for all report categories
     * based on the fetched report status data.
     * @param {Object} reportStatus - The report status data from the API.
     */
    function updateDeadlines(reportStatus) {
        if (!reportStatus) {
            console.warn('Tidak ada data status laporan untuk diperbarui.');
            return;
        }

        const categories = ['bulanan', 'triwulanan', 'tahunan', 'insidental'];
        const categoryCounts = {};

        categories.forEach(cat => {
            categoryCounts[cat] = { total: 0, uploaded: 0, pending: 0, urgent: 0 };
        });

        // Define all reports with their categories and static deadlines
        // These deadlines are placeholders and should ideally come from backend or a config
        const allReports = [
            // Laporan Bulanan
            { name: 'Laporan Fraud', api_key: 'laporan_fraud', category: 'bulanan', deadline: '2025-04-30' },
            { name: 'Laporan Transaksi Dana Bukan Bank', api_key: 'laporan_transaksi_dana_bukan_bank', category: 'bulanan', deadline: '2025-04-30' },
            { name: 'Laporan Kerjasama P2P', api_key: 'laporan_kerjasama_p2p', category: 'bulanan', deadline: '2025-04-30' },
            { name: 'Laporan DTTOT', api_key: 'laporan_dttot', category: 'bulanan', deadline: '2025-04-30' },
            // Laporan Triwulanan
            { name: 'Laporan Keuangan Triwulan', api_key: 'laporan_keuangan_triwulanan', category: 'triwulanan', deadline: '2025-05-15' },
            // Laporan Tahunan
            { name: 'Laporan Keuangan Tahunan Audited', api_key: 'laporan_keuangan_tahunan', category: 'tahunan', deadline: '2025-06-30' },
            { name: 'Laporan APU PPT', api_key: 'laporan_apuppt', category: 'tahunan', deadline: '2025-06-30' },
            { name: 'Laporan Tahunan Sistem Pembayaran', api_key: 'laporan_tahunan_sistem_pembayaran', category: 'tahunan', deadline: '2025-06-30' },
            { name: 'Laporan Manajemen dan Hasil Pengawasan Dewan Komisaris', api_key: 'laporan_manajemen', category: 'tahunan', deadline: '2025-06-30' },
            { name: 'Laporan Audit Sistem Informasi', api_key: 'laporan_audit_sistem_informasi', category: 'tahunan', deadline: '2025-06-30' },
            { name: 'Laporan Pelaksanaan Pengujian Keamanan (Penetration Test)', api_key: 'laporan_pelaksanaan_pengujian_keamanan', category: 'tahunan', deadline: '2025-06-30' },
            { name: 'Laporan RBA APU PPT', api_key: 'laporan_rba_apu_ppt', category: 'tahunan', deadline: '2025-06-30' },
            { name: 'Laporan Perhitungan KPSP', api_key: 'laporan_perhitungan_kpsp', category: 'tahunan', deadline: '2025-06-30' },
            // Laporan Insidental (assuming these are not in the /all-status API for now, or always 'false' if not explicitly true)
            { name: 'Laporan Gangguan IT', api_key: 'laporan_gangguan_it', category: 'insidental', deadline: '2025-04-30' },
        ];

        // Clear existing report lists
        document.getElementById('bulanan-reports').innerHTML = '';
        document.getElementById('triwulanan-reports').innerHTML = '';
        document.getElementById('tahunan-reports').innerHTML = '';
        document.getElementById('insidental-reports').innerHTML = '';


        allReports.forEach(report => {
            // Check if report.api_key exists in reportStatus and its value is true
            const isUploaded = reportStatus.hasOwnProperty(report.api_key) && reportStatus[report.api_key] === true;
            const itemHtml = renderDeadlineItem(report.name, report.deadline, report.category, isUploaded);
            document.getElementById(`${report.category}-reports`).insertAdjacentHTML('beforeend', itemHtml);

            // Update counts
            categoryCounts[report.category].total++;
            if (isUploaded) {
                categoryCounts[report.category].uploaded++;
            } else {
                categoryCounts[report.category].pending++;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const deadlineDate = new Date(report.deadline);
                deadlineDate.setHours(0, 0, 0, 0);
                const diffTime = deadlineDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= 7) { // Urgent if less than or equal to 7 days left, or overdue
                    categoryCounts[report.category].urgent++;
                }
            }
        });

        // Update KIP summary cards with calculated counts
        categories.forEach(cat => {
            const totalCountElement = document.getElementById(`${cat}-total-count`);
            const uploadedCountElement = document.getElementById(`${cat}-uploaded-count`);
            const pendingCountElement = document.getElementById(`${cat}-pending-count`);
            const urgentCountElement = document.getElementById(`${cat}-urgent-count`);

            if (totalCountElement) {
                totalCountElement.textContent = categoryCounts[cat].total;
            }
            if (uploadedCountElement) {
                uploadedCountElement.textContent = categoryCounts[cat].uploaded;
            }
            if (pendingCountElement) {
                pendingCountElement.textContent = categoryCounts[cat].pending;
            }
            if (urgentCountElement) {
                urgentCountElement.textContent = categoryCounts[cat].urgent;
            }
        });

        // Re-create Lucide icons after updating innerHTML for status indicators
        lucide.createIcons();
    }

    // Initial calls when the script loads
    updateClock();

    // Fetch report status and then update deadlines
    document.addEventListener('DOMContentLoaded', async () => {
        const status = await fetchReportStatus();
        if (status) {
            updateDeadlines(status);
        }
    });

    // Set intervals for continuous updates
    setInterval(updateClock, 1000); // Update clock every second

    // Event listener for the reload button
    document.getElementById('reloadReportData').addEventListener('click', async () => {
        console.log('Tombol reload ditekan. Memaksa pengambilan data baru...');
        const status = await fetchReportStatus(true); // Force fetch from API
        if (status) {
            updateDeadlines(status);
        }
    });

    // Event listener for the re-login button in the modal
    document.getElementById('reloginButton').addEventListener('click', () => {
        hideSessionExpiredModal();
        window.location.href = '/'; // Redirect to login page
    });

</script>
{% endblock %}
